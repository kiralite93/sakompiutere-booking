<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sakompiutere Gaming ‚Äî Booking</title>
  <meta name="theme-color" content="#0b1020" />

  <!-- Firebase v9 COMPAT -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#070a12;
      --card:#0b1020;
      --muted:#9aa4bf;
      --text:#eaf0ff;
      --line:rgba(255,255,255,.08);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
      --shadow:0 20px 60px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(110,231,255,.12), transparent 60%),
        radial-gradient(900px 700px at 80% 10%, rgba(167,139,250,.14), transparent 60%),
        radial-gradient(800px 700px at 40% 120%, rgba(52,211,153,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }

    .wrap{max-width:1180px; margin:0 auto; padding:18px;}
    header{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 16px; border:1px solid var(--line); border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      position:sticky; top:14px; z-index:10;
      backdrop-filter: blur(10px);
      animation: dropIn .35s ease both;
    }
    @keyframes dropIn{
      from{ transform: translateY(-10px); opacity:.0; }
      to{ transform: translateY(0); opacity:1; }
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:42px; height:42px; border-radius:14px;
      background:
        radial-gradient(circle at 30% 20%, rgba(110,231,255,.9), rgba(167,139,250,.8) 40%, rgba(0,0,0,0) 72%),
        linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.02));
      border:1px solid var(--line);
      box-shadow: 0 12px 30px rgba(0,0,0,.4);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-60%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
      transform: rotate(22deg) translateX(-60%);
      animation: shine 4.2s ease-in-out infinite;
    }
    @keyframes shine{
      0%, 72%{ transform: rotate(22deg) translateX(-70%); opacity:.0; }
      80%{ opacity:1; }
      100%{ transform: rotate(22deg) translateX(70%); opacity:0; }
    }

    .brand h1{margin:0; font-size:16px; letter-spacing:.4px}
    .brand .sub{margin:0; color:var(--muted); font-size:12px}

    .rightbar{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center;}
    .pill{
      padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--muted); font-size:12px;
      display:flex; gap:6px; align-items:center;
    }
    .pill strong{color:var(--text); font-weight:900}

    .dot{
      width:8px; height:8px; border-radius:999px;
      background:rgba(255,255,255,.25);
      box-shadow:0 0 0 0 rgba(110,231,255,.0);
    }
    .dot.ok{
      background: rgba(52,211,153,.9);
      box-shadow: 0 0 0 0 rgba(52,211,153,.45);
      animation: pulse 1.8s ease-out infinite;
    }
    .dot.err{
      background: rgba(251,113,133,.95);
    }
    @keyframes pulse{
      0%{ box-shadow:0 0 0 0 rgba(52,211,153,.35); }
      70%{ box-shadow:0 0 0 10px rgba(52,211,153,0); }
      100%{ box-shadow:0 0 0 0 rgba(52,211,153,0); }
    }

    .lang{
      display:flex; gap:6px;
      padding:6px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
    }
    .lang button{
      padding:7px 10px; border-radius:999px;
      border:1px solid transparent;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .lang button:hover{ transform: translateY(-1px); }
    .lang button.active{
      border-color: rgba(110,231,255,.55);
      background: rgba(110,231,255,.10);
      color: var(--text);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:18px;
      margin-top:16px;
      animation: fadeUp .35s ease both;
      animation-delay: .06s;
    }
    @keyframes fadeUp{
      from{ transform: translateY(8px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
      header{position:static;}
    }

    .card{
      border:1px solid var(--line);
      border-radius:var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
    }
    .hd h2{margin:0; font-size:14px}
    .hint{color:var(--muted); font-size:12px}
    .bd{padding:14px 16px}

    .notice{
      border:1px dashed rgba(110,231,255,.35);
      background: rgba(110,231,255,.06);
      padding:12px 12px;
      border-radius:16px;
      font-size:12px;
      line-height:1.35;
    }

    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:1000;
      letter-spacing:.2px;
      transition: transform .10s ease, border-color .12s ease, background .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    button:hover{border-color: rgba(110,231,255,.5); transform: translateY(-1px)}
    button:active{transform: translateY(0px) scale(.99)}
    button[disabled]{opacity:.55; cursor:not-allowed; transform:none}

    .primary{
      border-color: rgba(110,231,255,.55);
      background: linear-gradient(180deg, rgba(110,231,255,.18), rgba(167,139,250,.10));
      box-shadow: 0 0 0 0 rgba(110,231,255,0);
    }
    .primary:hover{ box-shadow: 0 0 0 3px rgba(110,231,255,.10); }
    .ghost{background:transparent}
    .danger{border-color: rgba(251,113,133,.6); background: rgba(251,113,133,.10)}
    .warn{border-color: rgba(251,191,36,.55); background: rgba(251,191,36,.08)}
    .mini{padding:6px 10px; border-radius:12px; font-size:12px; font-weight:1000}

    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
      transition: border-color .12s ease, box-shadow .12s ease, transform .12s ease;
    }
    input:focus, select:focus{border-color: rgba(110,231,255,.6); box-shadow:0 0 0 3px rgba(110,231,255,.12)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;}
    @media (max-width:520px){ .row{grid-template-columns:1fr;} }

    .pcgrid{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 980px){ .pcgrid{grid-template-columns: repeat(2, 1fr);} }

    .pc{
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(0,0,0,.22);
      cursor:pointer;
      transition: transform .10s ease, border-color .12s ease, box-shadow .12s ease;
      user-select:none;
      position:relative;
      min-height:74px;
      overflow:hidden;
    }
    .pc:before{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(600px 200px at -20% 0%, rgba(110,231,255,.12), transparent 60%);
      opacity:.0;
      transition: opacity .2s ease;
      pointer-events:none;
    }
    .pc:hover{transform: translateY(-1px); border-color: rgba(110,231,255,.4)}
    .pc:hover:before{opacity:1}
    .pc .name{font-weight:1100; letter-spacing:.3px}
    .pc .meta{margin-top:6px; color:var(--muted); font-size:12px}
    .pc.selected{
      border-color: rgba(110,231,255,.75);
      box-shadow: 0 0 0 3px rgba(110,231,255,.10);
    }
    .check{
      position:absolute; top:10px; right:10px;
      width:22px; height:22px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.35);
      display:grid; place-items:center;
      color: transparent;
      font-weight:1100;
      font-size:12px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease, color .12s ease;
    }
    .pc.selected .check{
      border-color: rgba(110,231,255,.75);
      background: rgba(110,231,255,.14);
      color: var(--text);
      transform: scale(1.06);
    }

    .chipbar{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .chip{
      padding:10px 12px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      cursor:pointer;
      font-weight:1100;
      font-size:12px;
      user-select:none;
      white-space:nowrap;
      transition: transform .10s ease, border-color .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    .chip:hover{border-color: rgba(110,231,255,.5); transform: translateY(-1px)}
    .chip.active{
      border-color: rgba(110,231,255,.75);
      background: rgba(110,231,255,.10);
      box-shadow: 0 0 0 3px rgba(110,231,255,.10);
    }
    .chip.busy{
      border-color: rgba(251,113,133,.65);
      background: rgba(251,113,133,.08);
      color: rgba(251,113,133,.95);
      cursor:not-allowed;
      opacity:.92;
      transform:none !important;
    }
    .chip.skel{
      border-style:dashed;
      opacity:.65;
      cursor:default;
      background: linear-gradient(90deg, rgba(255,255,255,.03), rgba(255,255,255,.06), rgba(255,255,255,.03));
      background-size: 240% 100%;
      animation: sk 1.2s ease infinite;
    }
    @keyframes sk{ 0%{background-position:0% 0} 100%{background-position:100% 0} }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:16px;
      margin-top:10px;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
      font-size:12px;
    }
    th{color:var(--muted); font-weight:1100; text-align:left; background:rgba(255,255,255,.03)}
    tr:last-child td{border-bottom:none}

    .footerbar{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-top:12px;
      color: var(--muted);
      font-size:12px;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      padding:2px 6px;
      border:1px solid var(--line);
      border-radius:8px;
      background:rgba(0,0,0,.25);
      color:var(--muted);
      font-size:12px;
    }
    .hide{display:none !important;}

    /* Toast message animation */
    .toastIn{
      animation: toast .28s ease both;
    }
    @keyframes toast{
      from{ transform: translateY(6px); opacity:.0; }
      to{ transform: translateY(0); opacity:1; }
    }

    /* Modal */
    .backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .backdrop.show{display:flex; animation: fade .18s ease both;}
    @keyframes fade{ from{opacity:0} to{opacity:1} }

    .modal{
      width:min(560px, 100%);
      border:1px solid var(--line);
      border-radius:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
      animation: pop .22s ease both;
      transform-origin: 50% 20%;
    }
    @keyframes pop{
      from{ transform: translateY(10px) scale(.98); opacity:.0; }
      to{ transform: translateY(0) scale(1); opacity:1; }
    }
    .mh{
      padding:14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border-bottom:1px solid var(--line);
    }
    .mb{padding:14px 16px}
    .mut{color:var(--muted); font-size:12px}

    .smalllinks{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .linkbtn{
      border:1px solid var(--line);
      background:transparent;
      color:var(--muted);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      cursor:pointer;
    }
    .linkbtn:hover{ color:var(--text); border-color: rgba(110,231,255,.35); }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1 id="t_title">Sakompiutere Gaming ‚Äî Booking</h1>
        <p class="sub" id="t_sub">–í—ã–±–µ—Ä–∏ –ü–ö ‚Üí –≤—ã–±–µ—Ä–∏ —Å–ª–æ—Ç ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</p>
      </div>
    </div>

    <div class="rightbar">
      <div class="lang" aria-label="Language selector">
        <button id="lang_ru" type="button">RU</button>
        <button id="lang_en" type="button">EN</button>
        <button id="lang_ka" type="button">KA</button>
      </div>

      <div class="pill"><span id="t_user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>: <strong id="userPill">‚Äî</strong></div>

      <div class="pill">
        <span class="dot" id="cloudDot"></span>
        <span id="t_status">–°—Ç–∞—Ç—É—Å</span>: <strong id="cloudPill">‚Ä¶</strong>
      </div>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="hd">
        <h2 id="t_main">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
        <div class="hint" id="hintTop">Firebase –≤–∫–ª—é—á—ë–Ω: –æ–±—â–∞—è –±–∞–∑–∞ –¥–ª—è –≤—Å–µ—Ö</div>
      </div>

      <div class="bd">
        <!-- AUTH BAR -->
        <div class="notice" id="authBar">
          <b id="t_authTitle">–ê–∫–∫–∞—É–Ω—Ç</b><br/>
          <span id="t_authDesc">–î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω—É–∂–µ–Ω –ª–æ–≥–∏–Ω.</span>
          <div class="btns">
            <button class="primary" id="openAuthBtn" type="button">üîë <span id="t_login">–í–æ–π—Ç–∏</span> / <span id="t_register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span></button>
            <button class="ghost hide" id="logoutBtn" type="button">üö™ <span id="t_logout">–í—ã–π—Ç–∏</span></button>
          </div>
          <div class="notice" style="margin-top:10px" id="authMsg">‚Äî</div>
        </div>

        <!-- FLOW -->
        <div class="notice" style="margin-top:12px" id="flowHelp">
          <b id="t_flowTitle">–ö–∞–∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</b><br/>
          <span id="t_flow1">1) –í—ã–±–µ—Ä–∏ 1 –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ü–ö</span><br/>
          <span id="t_flow2">2) –í—ã–±–µ—Ä–∏ –¥–∞—Ç—É –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</span><br/>
          <span id="t_flow3">3) –í—ã–±–µ—Ä–∏ —É–¥–æ–±–Ω—ã–π —Å–ª–æ—Ç (–∑–µ–ª—ë–Ω—ã–π —Å–≤–æ–±–æ–¥–µ–Ω)</span><br/>
          <span id="t_flow4">4) –ü–æ–¥—Ç–≤–µ—Ä–¥–∏</span>
        </div>

        <!-- FORM -->
        <div style="margin-top:12px">
          <div class="row">
            <div>
              <label id="t_nickLabel">–¢–≤–æ–π –Ω–∏–∫ (–≤ –∫–ª—É–±–µ)</label>
              <input id="nick" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: KiraLite" />
            </div>
            <div>
              <label id="t_dateLabel">–î–∞—Ç–∞</label>
              <input id="date" type="date" />
            </div>
          </div>

          <div class="row">
            <div>
              <label id="t_duration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</label>
              <select id="duration">
                <option value="60">1h</option>
                <option value="90">1h 30m</option>
                <option value="120">2h</option>
                <option value="180">3h</option>
                <option value="240">4h</option>
              </select>
            </div>
            <div>
              <label id="t_noteLabel">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
              <input id="note" type="text" placeholder="CS2 / –¢—É—Ä–Ω–∏—Ä" />
            </div>
          </div>

          <div class="hint" id="t_pickpc">–í—ã–±–µ—Ä–∏ –ü–ö (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ):</div>
          <div id="pcGrid" class="pcgrid"></div>

          <div class="notice" style="margin-top:10px">
            <b id="t_slotsTitle">–°–ª–æ—Ç—ã</b><br/>
            <span id="t_slotsDesc">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –ü–ö –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî –ø–æ—Ç–æ–º –ø–æ—è–≤—è—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã.</span>
            <div class="chipbar" id="slotChips"></div>
          </div>

          <div class="btns" style="margin-top:12px">
            <button class="primary" id="createBtn" type="button">‚úÖ <span id="t_bookNow">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</span></button>
            <button class="ghost" id="myBtn" type="button">üë§ <span id="t_my">–ú–æ–∏ –±—Ä–æ–Ω–∏</span></button>
            <button class="ghost" id="todayBtn" type="button">üìÖ <span id="t_today">–°–µ–≥–æ–¥–Ω—è</span></button>
          </div>

          <div class="notice" style="margin-top:10px" id="msgBox">‚Äî</div>
        </div>

        <!-- MY BOOKINGS -->
        <div id="myBox" class="hide" style="margin-top:14px">
          <div class="btns">
            <button class="ghost" id="closeMyBtn" type="button">‚úñ <span id="t_close">–ó–∞–∫—Ä—ã—Ç—å</span></button>
          </div>
          <table>
            <thead>
              <tr>
                <th id="t_colDate">–î–∞—Ç–∞</th>
                <th id="t_colTime">–í—Ä–µ–º—è</th>
                <th id="t_colPc">–ü–ö</th>
                <th id="t_colNote">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                <th id="t_colAct">–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody id="myTable"></tbody>
          </table>
        </div>

        <!-- TODAY -->
        <div id="todayBox" class="hide" style="margin-top:14px">
          <div class="btns">
            <button class="ghost" id="closeTodayBtn" type="button">‚úñ <span id="t_close2">–ó–∞–∫—Ä—ã—Ç—å</span></button>
          </div>
          <table>
            <thead>
              <tr>
                <th id="t_colTime2">–í—Ä–µ–º—è</th>
                <th id="t_colPc2">–ü–ö</th>
                <th id="t_colNick2">–ù–∏–∫</th>
                <th id="t_colNote2">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
              </tr>
            </thead>
            <tbody id="todayTable"></tbody>
          </table>
        </div>

        <!-- ADMIN -->
        <div id="adminBox" class="hide" style="margin-top:14px">
          <div class="notice">
            <b>Admin</b> ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–æ–Ω—è–º–∏
            <div class="row" style="margin-top:10px">
              <div>
                <label>–î–∞—Ç–∞ (—Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å)</label>
                <input id="adminDate" type="date" />
              </div>
              <div>
                <label>–ü–æ–∏—Å–∫ (–Ω–∏–∫/–ü–ö/email)</label>
                <input id="adminSearch" type="text" placeholder="search" />
              </div>
            </div>
            <div class="btns">
              <button class="ghost" id="refreshAdminBtn" type="button">üîÑ Refresh</button>
              <button class="danger" id="adminCloseBtn" type="button">üö™ Close admin</button>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th>–î–µ–Ω—å</th><th>–í—Ä–µ–º—è</th><th>–ü–ö</th><th>–ù–∏–∫</th><th>User</th><th>Action</th>
              </tr>
            </thead>
            <tbody id="adminTable"></tbody>
          </table>
        </div>

        <div class="footerbar">
          <div><span class="kbd">Esc</span> ‚Äî <span id="t_esc">–∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–∞</span></div>
          <div class="btns" style="margin:0">
            <button class="mini ghost" id="openAdminBtn" type="button">üîê Admin</button>
          </div>
        </div>

      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="hd">
        <h2 id="t_side">–ü–æ–¥—Å–∫–∞–∑–∫–∞</h2>
        <div class="hint" id="t_side2">—á—Ç–æ–±—ã –∏–≥—Ä–æ–∫ –ø–æ–Ω—è–ª —Å—Ä–∞–∑—É</div>
      </div>
      <div class="bd">
        <div class="notice" id="helpBox"></div>
        <div style="height:12px"></div>
        <div class="notice" id="rulesBox"></div>
        <div style="height:12px"></div>
        <div class="notice">
          <b>–í–∞–∂–Ω–æ</b><br/>
          Firebase —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ <b>http(s)</b>. –ù–∞ <b>file:///</b> –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è/–±–∞–∑–∞ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º.<br/>
          –ï—Å–ª–∏ –≤–∏–¥–∏—à—å <b>permission-denied</b> ‚Äî –ø—Ä–æ–≤–µ—Ä—å Firestore Rules.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- AUTH MODAL -->
<div class="backdrop" id="authBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="mh">
      <div>
        <b id="t_authModal">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</b>
        <div class="mut" id="t_authModal2">Email + –ø–∞—Ä–æ–ª—å</div>
      </div>
      <button id="authCloseBtn" type="button">‚úñ</button>
    </div>
    <div class="mb">
      <div class="row">
        <div>
          <label>Email</label>
          <input id="authEmail" type="email" placeholder="email@example.com" />
        </div>
        <div>
          <label>Password</label>
          <input id="authPass" type="password" placeholder="******" />
        </div>
      </div>
      <div class="btns">
        <button class="primary" id="doLoginBtn" type="button">–í–æ–π—Ç–∏</button>
        <button class="ghost" id="doRegisterBtn" type="button">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>
      <div class="smalllinks">
        <button class="linkbtn" id="forgotBtn" type="button">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
        <span class="mut">–ü–∞—Ä–æ–ª—å ‚â• 6 —Å–∏–º–≤–æ–ª–æ–≤</span>
      </div>
      <div class="notice" style="margin-top:10px" id="authModalMsg">‚Äî</div>
    </div>
  </div>
</div>

<script>
(() => {
  // =========================
  // FIREBASE CONFIG (—Ç–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ)
  // =========================
  const firebaseConfig = {
    apiKey: "AIzaSyDJ-5e_xLPW9PnYT66ENey_Ndh8HJdI5wc",
    authDomain: "sakompiutere-gaming.firebaseapp.com",
    projectId: "sakompiutere-gaming",
    storageBucket: "sakompiutere-gaming.firebasestorage.app",
    messagingSenderId: "508996154674",
    appId: "1:508996154674:web:0b6e475d284c49ba80d32b",
    measurementId: "G-H2HKS025KH"
  };

  // =========================
  // CLUB CONFIG
  // =========================
  const PCs = ["Bishop","Godzilla","Elf","Kadita","Orc","Lancelot","Fantomas","Soultaker","Pudge","Kratos"];
  const SLOT_STEP_MIN = 30;

  // —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å (–º–æ–∂–µ—Ç –ø–µ—Ä–µ—Å–µ–∫–∞—Ç—å –ø–æ–ª–Ω–æ—á—å)
  const WORKING_HOURS_ENABLED = true;
  const WORK_START = "10:00";
  const WORK_END   = "03:00"; // –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å

  // –ê–¥–º–∏–Ω—ã –ø–æ email (–¥–æ–±–∞–≤—å —Å–≤–æ–∏)
  const ADMIN_EMAILS = [
    // "kiralite93@gmail.com",
  ];

  const LOCKS_COLLECTION = "locks";

  // =========================
  // HELPERS
  // =========================
  const $ = (id) => document.getElementById(id);
  const pad2 = (n)=>String(n).padStart(2,"0");
  const toISODate = (d)=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const parseISODate = (iso)=>{ const [y,m,d]=iso.split("-").map(Number); return new Date(y,m-1,d,0,0,0,0); };
  const minutesFromHHMM = (t)=>{ const [h,m]=t.split(":").map(Number); return h*60+m; };
  const hhmmFromMinutes = (min)=>{ min=((min%1440)+1440)%1440; const h=Math.floor(min/60), m=min%60; return `${pad2(h)}:${pad2(m)}`; };

  const addDays = (dateObj, days) => new Date(dateObj.getTime() + days*24*60*60*1000);

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function setToast(text, kind="info"){
    const el = $("msgBox");
    el.classList.remove("toastIn");
    void el.offsetWidth; // restart animation
    el.classList.add("toastIn");

    el.textContent = text;
    el.style.borderColor =
      kind==="good" ? "rgba(52,211,153,.45)" :
      kind==="bad" ? "rgba(251,113,133,.55)" :
      kind==="warn"? "rgba(251,191,36,.55)" :
      "rgba(110,231,255,.35)";
    el.style.background =
      kind==="good" ? "rgba(52,211,153,.08)" :
      kind==="bad" ? "rgba(251,113,133,.08)" :
      kind==="warn"? "rgba(251,191,36,.08)" :
      "rgba(110,231,255,.06)";
  }

  function show(el){ el.classList.remove("hide"); }
  function hide(el){ el.classList.add("hide"); }

  function openModal(){ $("authBackdrop").classList.add("show"); }
  function closeModal(){ $("authBackdrop").classList.remove("show"); }

  function isCrossMidnight(){
    if(!WORKING_HOURS_ENABLED) return false;
    const ws = minutesFromHHMM(WORK_START);
    const we = minutesFromHHMM(WORK_END);
    return we <= ws;
  }

  // ‚Äú—Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å‚Äù = –≤—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞. –°–ª–æ—Ç—ã –ø–æ—Å–ª–µ –ø–æ–ª—É–Ω–æ—á–∏ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ +1 –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–º—É –¥–Ω—é.
  function slotStartAbs(dateISO, startMin){
    const base = parseISODate(dateISO);
    let d = new Date(base.getFullYear(), base.getMonth(), base.getDate(), Math.floor(startMin/60), startMin%60, 0, 0);
    if(isCrossMidnight()){
      const ws = minutesFromHHMM(WORK_START);
      if(startMin < ws) d = addDays(d, 1); // –Ω–æ—á–Ω–æ–π —Å–ª–æ—Ç -> —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –¥–µ–Ω—å
    }
    return d;
  }
  function slotEndAbs(dateISO, endMin){
    // endMin –º–æ–∂–µ—Ç ‚Äú—É–ø–∏—Ä–∞—Ç—å—Å—è‚Äù –≤ 03:00 –∏ —Ç–æ–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–º –¥–Ω–µ
    const base = parseISODate(dateISO);
    let d = new Date(base.getFullYear(), base.getMonth(), base.getDate(), Math.floor(endMin/60), endMin%60, 0, 0);
    if(isCrossMidnight()){
      const ws = minutesFromHHMM(WORK_START);
      // –µ—Å–ª–∏ –∫–æ–Ω–µ—Ü –º–µ–Ω—å—à–µ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è ‚Äî —ç—Ç–æ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
      if(endMin <= ws) d = addDays(d, 1);
    }
    return d;
  }

  function overlapsAbs(aStart, aEnd, bStart, bEnd){
    return Math.max(aStart, bStart) < Math.min(aEnd, bEnd);
  }

  // locks –¥–æ–ª–∂–Ω—ã –æ—Ç–ª–∏—á–∞—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –¥–µ–Ω—å —Å–µ–≥–º–µ–Ω—Ç–∞ (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Å—Ç—Ä–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π)
  function lockSegmentISO(dateISO, minute){
    if(!isCrossMidnight()) return dateISO;
    const ws = minutesFromHHMM(WORK_START);
    if(minute < ws) {
      const d = addDays(parseISODate(dateISO), 1);
      return toISODate(d);
    }
    return dateISO;
  }

  function lockId(dateISO, pc, minute){
    const segISO = lockSegmentISO(dateISO, minute);
    return `${segISO}__${pc}__${minute}`;
  }

  function lockMinutesBetween(startMin, endMin){
    const mins = [];
    for(let m = startMin; m < endMin; m += SLOT_STEP_MIN) mins.push(m);
    return mins;
  }

  // =========================
  // i18n
  // =========================
  const LANG_KEY = "sg_lang";
  let lang = localStorage.getItem(LANG_KEY) || "ru";

  const i18n = {
    ru: {
      title:"Sakompiutere Gaming ‚Äî Booking",
      sub:"–í—ã–±–µ—Ä–∏ –ü–ö ‚Üí –≤—ã–±–µ—Ä–∏ —Å–ª–æ—Ç ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å",
      user:"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", status:"–°—Ç–∞—Ç—É—Å",
      main:"–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ",
      authTitle:"–ê–∫–∫–∞—É–Ω—Ç",
      authDesc:"–î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω—É–∂–µ–Ω –ª–æ–≥–∏–Ω.",
      login:"–í–æ–π—Ç–∏", register:"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è", logout:"–í—ã–π—Ç–∏",
      flowTitle:"–ö–∞–∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å",
      flow1:"1) –í—ã–±–µ—Ä–∏ 1 –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ü–ö",
      flow2:"2) –í—ã–±–µ—Ä–∏ –¥–∞—Ç—É –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
      flow3:"3) –í—ã–±–µ—Ä–∏ —É–¥–æ–±–Ω—ã–π —Å–ª–æ—Ç (–∑–µ–ª—ë–Ω—ã–π —Å–≤–æ–±–æ–¥–µ–Ω)",
      flow4:"4) –ü–æ–¥—Ç–≤–µ—Ä–¥–∏",
      nickLabel:"–¢–≤–æ–π –Ω–∏–∫ (–≤ –∫–ª—É–±–µ)",
      dateLabel:"–î–∞—Ç–∞ (—Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å)",
      duration:"–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
      note:"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)",
      pickpc:"–í—ã–±–µ—Ä–∏ –ü–ö (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ):",
      slotsTitle:"–°–ª–æ—Ç—ã",
      slotsDesc:"–í—ã–±–µ—Ä–∏ –ü–ö –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî –ø–æ—è–≤—è—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã. –ù–æ—á–Ω—ã–µ —Å–ª–æ—Ç—ã –ø–æ–º–µ—á–µ–Ω—ã üåô(+1).",
      bookNow:"–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å",
      my:"–ú–æ–∏ –±—Ä–æ–Ω–∏",
      today:"–°–µ–≥–æ–¥–Ω—è",
      close:"–ó–∞–∫—Ä—ã—Ç—å",
      colDate:"–î–µ–Ω—å",
      colTime:"–í—Ä–µ–º—è",
      colPc:"–ü–ö",
      colNote:"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",
      colAct:"–î–µ–π—Å—Ç–≤–∏—è",
      side:"–ü–æ–¥—Å–∫–∞–∑–∫–∞",
      side2:"—á—Ç–æ–±—ã –∏–≥—Ä–æ–∫ –ø–æ–Ω—è–ª —Å—Ä–∞–∑—É",
      help:`‚úÖ –ë—ã—Å—Ç—Ä–æ:
1) –í–æ–π–¥–∏
2) –í—ã–±–µ—Ä–∏ –ü–ö
3) –í—ã–±–µ—Ä–∏ –¥–∞—Ç—É, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
4) –í—ã–±–µ—Ä–∏ —Å–ª–æ—Ç ‚Üí ‚Äú–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å‚Äù

üë§ ‚Äú–ú–æ–∏ –±—Ä–æ–Ω–∏‚Äù ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä/–æ—Ç–º–µ–Ω–∞.`,
      rulesTitle:"–ü—Ä–∞–≤–∏–ª–∞",
      rulesBody:"‚Ä¢ –ù–µ–ª—å–∑—è –ø–µ—Ä–µ—Å–µ–∫–∞—Ç—å –±—Ä–æ–Ω–∏ –Ω–∞ –æ–¥–Ω–æ–º –ü–ö<br/>‚Ä¢ –ù–æ—á–Ω—ã–µ —Å–ª–æ—Ç—ã –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–Ω—é üåô(+1)<br/>‚Ä¢ Firebase = –æ–±—â–∞—è –±–∞–∑–∞ (—É –≤—Å–µ—Ö –æ–¥–Ω–∞)",
      esc:"–∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–∞",
    },
    en: {
      title:"Sakompiutere Gaming ‚Äî Booking",
      sub:"Pick PC ‚Üí pick slot ‚Üí confirm",
      user:"User", status:"Status",
      main:"Booking",
      authTitle:"Account",
      authDesc:"Login required to book.",
      login:"Login", register:"Register", logout:"Logout",
      flowTitle:"How to book",
      flow1:"1) Select one or multiple PCs",
      flow2:"2) Pick date & duration",
      flow3:"3) Pick a slot (green = free)",
      flow4:"4) Confirm",
      nickLabel:"Your club nickname",
      dateLabel:"Date (work day)",
      duration:"Duration",
      note:"Note (optional)",
      pickpc:"Select PCs (multi-select):",
      slotsTitle:"Slots",
      slotsDesc:"Pick PCs + duration ‚Äî available slots will appear. Night slots are marked üåô(+1).",
      bookNow:"Book now",
      my:"My bookings",
      today:"Today",
      close:"Close",
      colDate:"Day",
      colTime:"Time",
      colPc:"PC",
      colNote:"Note",
      colAct:"Actions",
      side:"Hint",
      side2:"so users understand fast",
      help:`‚úÖ Quick:
1) Login
2) Choose PCs
3) Choose date & duration
4) Choose slot ‚Üí ‚ÄúBook now‚Äù

üë§ ‚ÄúMy bookings‚Äù ‚Äî view/cancel.`,
      rulesTitle:"Rules",
      rulesBody:"‚Ä¢ No overlaps on the same PC<br/>‚Ä¢ Night slots belong to next day üåô(+1)<br/>‚Ä¢ Firebase enabled (shared DB)",
      esc:"close panels",
    },
    ka: {
      title:"Sakompiutere Gaming ‚Äî Booking",
      sub:"·Éê·Éò·É†·É©·Éò·Éî PC ‚Üí ·Éê·Éò·É†·É©·Éò·Éî ·É°·Éö·Éù·É¢·Éò ‚Üí ·Éì·Éê·Éê·Éì·Éê·É°·É¢·É£·É†·Éî",
      user:"·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò", status:"·É°·É¢·Éê·É¢·É£·É°·Éò",
      main:"·ÉØ·Éê·Éï·É®·Éê·Éú·Éò",
      authTitle:"·Éê·É•·Éê·É£·Éú·Éó·Éò",
      authDesc:"·ÉØ·Éê·Éï·É®·Éú·Éò·É°·Éó·Éï·Éò·É° ·É°·Éê·É≠·Éò·É†·Éù·Éê ·É®·Éî·É°·Éï·Éö·Éê.",
      login:"·É®·Éî·É°·Éï·Éö·Éê", register:"·É†·Éî·Éí·Éò·É°·É¢·É†·Éê·É™·Éò·Éê", logout:"·Éí·Éê·É°·Éï·Éö·Éê",
      flowTitle:"·É†·Éù·Éí·Éù·É† ·Éì·Éê·Éï·ÉØ·Éê·Éï·É®·Éú·Éù",
      flow1:"1) ·Éê·Éò·É†·É©·Éò·Éî ·Éî·É†·Éó·Éò ·Éê·Éú ·É†·Éê·Éõ·Éì·Éî·Éú·Éò·Éõ·Éî PC",
      flow2:"2) ·Éê·Éò·É†·É©·Éò·Éî ·Éó·Éê·É†·Éò·É¶·Éò ·Éì·Éê ·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éù·Éë·Éê",
      flow3:"3) ·Éê·Éò·É†·É©·Éò·Éî ·É°·Éö·Éù·É¢·Éò (·Éõ·É¨·Éï·Éê·Éú·Éî = ·Éó·Éê·Éï·Éò·É°·É£·É§·Éê·Éö·Éò)",
      flow4:"4) ·Éì·Éê·Éê·Éì·Éê·É°·É¢·É£·É†·Éî",
      nickLabel:"·Éú·Éò·Éô·Éò (·Éô·Éö·É£·Éë·É®·Éò)",
      dateLabel:"·Éó·Éê·É†·Éò·É¶·Éò (·É°·Éê·Éõ·É£·É®·Éê·Éù ·Éì·É¶·Éî)",
      duration:"·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éù·Éë·Éê",
      note:"·É®·Éî·Éú·Éò·É®·Éï·Éú·Éê (·Éê·É†·Éê·É°·Éê·Éï·Éê·Éö·Éì·Éî·Éë·É£·Éö·Éù)",
      pickpc:"·Éê·Éò·É†·É©·Éò·Éî PC-·Éî·Éë·Éò (·É®·Éî·Éò·É´·Éö·Éî·Éë·Éê ·É†·Éê·Éõ·Éì·Éî·Éú·Éò·Éõ·Éî):",
      slotsTitle:"·É°·Éö·Éù·É¢·Éî·Éë·Éò",
      slotsDesc:"·Éê·Éò·É†·É©·Éò·Éî PC ·Éì·Éê ·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éù·Éë·Éê ‚Äî ·Éí·Éê·Éõ·Éù·É©·Éú·Éì·Éî·Éë·Éê ·Éó·Éê·Éï·Éò·É°·É£·É§·Éê·Éö·Éò ·É°·Éö·Éù·É¢·Éî·Éë·Éò. ·É¶·Éê·Éõ·Éò·É° ·É°·Éö·Éù·É¢·Éî·Éë·Éò: üåô(+1).",
      bookNow:"·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éê",
      my:"·É©·Éî·Éõ·Éò ·ÉØ·Éê·Éï·É®·Éú·Éî·Éë·Éò",
      today:"·Éì·É¶·Éî·É°",
      close:"·Éì·Éê·ÉÆ·É£·É†·Éï·Éê",
      colDate:"·Éì·É¶·Éî",
      colTime:"·Éì·É†·Éù",
      colPc:"PC",
      colNote:"·É®·Éî·Éú·Éò·É®·Éï·Éú·Éê",
      colAct:"·É•·Éõ·Éî·Éì·Éî·Éë·Éê",
      side:"·Éõ·Éò·Éú·Éò·É®·Éú·Éî·Éë·Éê",
      side2:"·É†·Éù·Éõ ·É°·É¨·É†·Éê·É§·Éê·Éì ·Éí·Éê·Éò·Éí·Éù·Éú",
      help:`‚úÖ ·É°·É¨·É†·Éê·É§·Éê·Éì:
1) ·É®·Éî·Éì·Éò
2) ·Éê·Éò·É†·É©·Éò·Éî PC-·Éî·Éë·Éò
3) ·Éê·Éò·É†·É©·Éò·Éî ·Éó·Éê·É†·Éò·É¶·Éò ·Éì·Éê ·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éù·Éë·Éê
4) ·Éê·Éò·É†·É©·Éò·Éî ·É°·Éö·Éù·É¢·Éò ‚Üí ‚Äú·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éê‚Äù

üë§ ‚Äú·É©·Éî·Éõ·Éò ·ÉØ·Éê·Éï·É®·Éú·Éî·Éë·Éò‚Äù ‚Äî ·Éú·Éê·ÉÆ·Éï·Éê/·Éí·Éê·É£·É•·Éõ·Éî·Éë·Éê.`,
      rulesTitle:"·É¨·Éî·É°·Éî·Éë·Éò",
      rulesBody:"‚Ä¢ ·Éî·É†·Éó PC-·Éñ·Éî ·Éí·Éê·Éì·Éê·Éô·Éï·Éî·Éó·Éê ·Éê·É† ·É®·Éî·Éò·É´·Éö·Éî·Éë·Éê<br/>‚Ä¢ ·É¶·Éê·Éõ·Éò·É° ·É°·Éö·Éù·É¢·Éî·Éë·Éò ·Éî·Éô·É£·Éó·Éï·Éú·Éò·É° ·É®·Éî·Éõ·Éì·Éî·Éí ·Éì·É¶·Éî·É° üåô(+1)<br/>‚Ä¢ Firebase ·É©·Éê·É†·Éó·É£·Éö·Éò·Éê (·É°·Éê·Éî·É†·Éó·Éù ·Éë·Éê·Éñ·Éê)",
      esc:"·É§·Éê·Éú·ÉØ·É†·Éî·Éë·Éò·É° ·Éì·Éê·ÉÆ·É£·É†·Éï·Éê",
    }
  };

  function t(k){ return (i18n[lang] && i18n[lang][k]) || i18n.ru[k] || k; }
  function applyLang(){
    $("t_title").textContent = t("title");
    $("t_sub").textContent = t("sub");
    $("t_user").textContent = t("user");
    $("t_status").textContent = t("status");
    $("t_main").textContent = t("main");
    $("t_authTitle").textContent = t("authTitle");
    $("t_authDesc").textContent = t("authDesc");
    $("t_login").textContent = t("login");
    $("t_register").textContent = t("register");
    $("t_logout").textContent = t("logout");
    $("t_flowTitle").textContent = t("flowTitle");
    $("t_flow1").textContent = t("flow1");
    $("t_flow2").textContent = t("flow2");
    $("t_flow3").textContent = t("flow3");
    $("t_flow4").textContent = t("flow4");
    $("t_nickLabel").textContent = t("nickLabel");
    $("t_dateLabel").textContent = t("dateLabel");
    $("t_duration").textContent = t("duration");
    $("t_noteLabel").textContent = t("note");
    $("t_pickpc").textContent = t("pickpc");
    $("t_slotsTitle").textContent = t("slotsTitle");
    $("t_slotsDesc").textContent = t("slotsDesc");
    $("t_bookNow").textContent = t("bookNow");
    $("t_my").textContent = t("my");
    $("t_today").textContent = t("today");
    $("t_close").textContent = t("close");
    $("t_close2").textContent = t("close");
    $("t_colDate").textContent = t("colDate");
    $("t_colTime").textContent = t("colTime");
    $("t_colPc").textContent = t("colPc");
    $("t_colNote").textContent = t("colNote");
    $("t_colAct").textContent = t("colAct");
    $("t_side").textContent = t("side");
    $("t_side2").textContent = t("side2");
    $("helpBox").textContent = t("help");
    $("rulesBox").innerHTML = `<b>${t("rulesTitle")}</b><br/>${t("rulesBody")}`;
    $("t_esc").textContent = t("esc");

    $("lang_ru").classList.toggle("active", lang==="ru");
    $("lang_en").classList.toggle("active", lang==="en");
    $("lang_ka").classList.toggle("active", lang==="ka");
  }

  // =========================
  // FIREBASE INIT
  // =========================
  let app, auth, db;
  let currentUser = null;
  let isAdmin = false;

  function setCloud(text, ok=true){
    $("cloudPill").textContent = text;
    const dot = $("cloudDot");
    dot.classList.remove("ok","err");
    if(ok) dot.classList.add("ok");
    else dot.classList.add("err");
  }

  try{
    app = firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.firestore();
    setCloud("OK", true);
  }catch(e){
    console.error(e);
    setCloud("ERROR", false);
    setToast("Firebase init error. Open Console (F12).", "bad");
  }

  // =========================
  // UI STATE
  // =========================
  let selectedPCs = new Set();
  let selectedSlot = null; // {startMin,endMin,label,startAt,endAt}
  let cachedDayBookings = []; // bookings for dateKey

  function renderPCGrid(){
    const grid = $("pcGrid");
    grid.innerHTML = "";
    for(const pc of PCs){
      const div = document.createElement("div");
      div.className = "pc" + (selectedPCs.has(pc) ? " selected" : "");
      div.innerHTML = `
        <div class="check">‚úì</div>
        <div class="name">${pc}</div>
        <div class="meta">${selectedPCs.has(pc) ? "Selected" : "Tap to select"}</div>
      `;
      div.addEventListener("click", ()=>{
        if(selectedPCs.has(pc)) selectedPCs.delete(pc);
        else selectedPCs.add(pc);
        renderPCGrid();
        rebuildSlots();
      });
      grid.appendChild(div);
    }
  }

  function workingWindowSegments(){
    const ws = minutesFromHHMM(WORK_START);
    const we = minutesFromHHMM(WORK_END);
    if(!WORKING_HOURS_ENABLED) return [{a:0,b:1440, night:false}];
    if(we > ws) return [{a:ws,b:we, night:false}];
    // crosses midnight: [ws..1440] + [0..we]
    return [
      {a:ws,b:1440, night:false},
      {a:0,b:we, night:true}
    ];
  }

  function slotBusyForSelectedPCs(slot){
    // —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ —Ä–µ–∞–ª—å–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ startAt/endAt
    for(const b of cachedDayBookings){
      if(!selectedPCs.has(b.pc)) continue;
      if(overlapsAbs(slot.startAtMs, slot.endAtMs, b.startAtMs, b.endAtMs)) return true;
    }
    return false;
  }

  async function loadBookingsForDateKey(dateKey){
    const snap = await db.collection("bookings").where("dateKey", "==", dateKey).get();
    return snap.docs.map(d => ({ id:d.id, ...d.data() }));
  }

  async function refreshDayAndSlots(){
    const dateKey = $("date").value;
    if(!dateKey || !db) return;
    try{
      cachedDayBookings = await loadBookingsForDateKey(dateKey);
      // normalize for compare
      cachedDayBookings = cachedDayBookings.map(b => ({
        ...b,
        startAtMs: Number(b.startAtMs || 0),
        endAtMs: Number(b.endAtMs || 0),
      }));
    }catch(e){
      console.error(e);
      setToast("–ù–µ –º–æ–≥—É –∑–∞–≥—Ä—É–∑–∏—Ç—å –±—Ä–æ–Ω–∏ –∏–∑ –±–∞–∑—ã. –ü—Ä–æ–≤–µ—Ä—å Firestore rules.", "bad");
      cachedDayBookings = [];
    }
    rebuildSlots();
  }

  function rebuildSlots(){
    const chips = $("slotChips");
    chips.innerHTML = "";
    selectedSlot = null;

    const dateKey = $("date").value;
    const dur = Number($("duration").value || 60);

    if(!dateKey || selectedPCs.size === 0){
      chips.innerHTML = `<div class="mut">‚Äî</div>`;
      return;
    }

    // small skeleton while loading is possible: but here we already have cached bookings
    const segs = workingWindowSegments();
    const slots = [];

    for(const seg of segs){
      for(let s = seg.a; s + dur <= seg.b; s += SLOT_STEP_MIN){
        const e = s + dur;

        const startAt = slotStartAbs(dateKey, s);
        const endAt = slotEndAbs(dateKey, e);

        const labelBase = `${hhmmFromMinutes(s)} ‚Üí ${hhmmFromMinutes(e)}`;
        const label = seg.night ? `${labelBase}  üåô(+1)` : labelBase;

        slots.push({
          startMin:s,
          endMin:e,
          label,
          startAtMs: startAt.getTime(),
          endAtMs: endAt.getTime(),
          night: !!seg.night
        });
      }
    }

    if(!slots.length){
      chips.innerHTML = `<div class="mut">‚Äî</div>`;
      return;
    }

    for(const sl of slots){
      const busy = slotBusyForSelectedPCs(sl);
      const div = document.createElement("div");
      div.className = "chip" + (busy ? " busy" : "");
      div.textContent = busy ? `‚õî ${sl.label}` : `‚úÖ ${sl.label}`;
      div.addEventListener("click", ()=>{
        if(busy) return;
        selectedSlot = sl;
        [...chips.children].forEach(x=>x.classList.remove("active"));
        div.classList.add("active");
      });
      chips.appendChild(div);
    }
  }

  // =========================
  // PROFILE
  // =========================
  async function upsertProfileNick(uid, nick){
    const safeNick = (nick || "").trim().slice(0, 32);
    if(!safeNick) return;
    await db.collection("users").doc(uid).set({
      nick: safeNick,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });
  }

  async function loadProfileNick(uid){
    const doc = await db.collection("users").doc(uid).get();
    return doc.exists ? (doc.data().nick || "") : "";
  }

  function updateAuthUI(){
    $("logoutBtn").classList.toggle("hide", !currentUser);
    $("openAuthBtn").classList.toggle("hide", !!currentUser);
    $("userPill").textContent = currentUser ? (currentUser.email || currentUser.uid.slice(0,6)) : "‚Äî";

    isAdmin = !!(currentUser && ADMIN_EMAILS.map(x=>String(x).toLowerCase()).includes(String(currentUser.email||"").toLowerCase()));
    if(!isAdmin) hide($("adminBox"));
  }

  // =========================
  // BOOKING + LOCKS (transaction, —Ç–æ–ª—å–∫–æ doc refs)
  // =========================
  async function createBooking(){
    if(!currentUser){
      setToast("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏.", "bad");
      return;
    }

    const nick = ($("nick").value||"").trim();
    const dateKey = $("date").value;
    const note = ($("note").value||"").trim();

    if(!nick){ setToast("–í–≤–µ–¥–∏ –Ω–∏–∫.", "bad"); return; }
    if(!dateKey){ setToast("–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É.", "bad"); return; }
    if(selectedPCs.size===0){ setToast("–í—ã–±–µ—Ä–∏ –ü–ö.", "bad"); return; }
    if(!selectedSlot){ setToast("–í—ã–±–µ—Ä–∏ —Å–≤–æ–±–æ–¥–Ω—ã–π —Å–ª–æ—Ç.", "bad"); return; }

    // –∑–∞–ø—Ä–µ—Ç –≤ –ø—Ä–æ—à–ª–æ–µ
    const now = Date.now();
    if(selectedSlot.startAtMs < now){
      setToast("–ù–µ–ª—å–∑—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º.", "bad");
      return;
    }

    // save nick
    try{ await upsertProfileNick(currentUser.uid, nick); }catch(e){}

    const pcs = Array.from(selectedPCs);

    $("createBtn").disabled = true;
    setToast("–°–æ–∑–¥–∞—é –±—Ä–æ–Ω—å‚Ä¶", "info");

    try{
      await db.runTransaction(async (tx) => {
        // –¥–ª—è –∫–∞–∂–¥–æ–≥–æ PC —Å–æ–∑–¥–∞—ë–º locks –Ω–∞ –∫–∞–∂–¥—ã–π 30-–º–∏–Ω —Å–µ–≥–º–µ–Ω—Ç
        for(const pc of pcs){
          const mins = lockMinutesBetween(selectedSlot.startMin, selectedSlot.endMin);
          const lockIds = mins.map(m => lockId(dateKey, pc, m));

          // 1) check locks
          for(const lid of lockIds){
            const ref = db.collection(LOCKS_COLLECTION).doc(lid);
            const snap = await tx.get(ref);
            if(snap.exists) throw new Error("OVERLAP_LOCK");
          }

          // 2) create locks
          for(const lid of lockIds){
            const minute = Number(lid.split("__").pop());
            tx.set(db.collection(LOCKS_COLLECTION).doc(lid), {
              uid: currentUser.uid,
              pc,
              dateKey,
              segmentISO: lockSegmentISO(dateKey, minute),
              minute,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }

          // 3) create booking doc
          const bRef = db.collection("bookings").doc();
          tx.set(bRef, {
            uid: currentUser.uid,
            userEmail: currentUser.email || "",
            nick,
            pc,
            dateKey, // —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å
            startMin: selectedSlot.startMin,
            endMin: selectedSlot.endMin,
            startAtMs: selectedSlot.startAtMs,
            endAtMs: selectedSlot.endAtMs,
            note,
            lockIds,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      });

      setToast(`‚úÖ –ì–æ—Ç–æ–≤–æ! –ü–ö: ${pcs.join(", ")} ‚Äî ${selectedSlot.label}`, "good");
      await refreshDayAndSlots();

    }catch(e){
      console.error(e);
      if(String(e.message||"") === "OVERLAP_LOCK"){
        setToast("‚õî –≠—Ç–æ—Ç —Å–ª–æ—Ç —É–∂–µ –∑–∞–Ω—è–ª–∏. –í—ã–±–µ—Ä–∏ –¥—Ä—É–≥–æ–π.", "bad");
      }else{
        setToast("–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. –û—Ç–∫—Ä–æ–π Console (F12) –∏ –ø—Ä–∏—à–ª–∏ 1 –∫—Ä–∞—Å–Ω—É—é —Å—Ç—Ä–æ–∫—É.", "bad");
      }
    }finally{
      $("createBtn").disabled = false;
    }
  }

  // =========================
  // MY BOOKINGS
  // =========================
  async function loadMyBookings(){
    if(!currentUser) return [];
    const snap = await db.collection("bookings").where("uid","==", currentUser.uid).get();
    const list = snap.docs.map(d => ({ id:d.id, ...d.data() }));
    list.forEach(b=>{
      b.startAtMs = Number(b.startAtMs || 0);
      b.endAtMs = Number(b.endAtMs || 0);
    });
    list.sort((a,b)=> (a.startAtMs - b.startAtMs) || String(a.pc).localeCompare(String(b.pc)));
    return list;
  }

  async function deleteBookingAndLocks(b){
    const batch = db.batch();
    if(Array.isArray(b.lockIds)){
      for(const lid of b.lockIds){
        batch.delete(db.collection(LOCKS_COLLECTION).doc(lid));
      }
    }
    batch.delete(db.collection("bookings").doc(b.id));
    await batch.commit();
  }

  function fmtDayFromMs(ms){
    const d = new Date(ms);
    return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }

  async function renderMyBookings(){
    const tbody = $("myTable");
    tbody.innerHTML = "";
    if(!currentUser){
      tbody.innerHTML = `<tr><td colspan="5" style="color:var(--muted)">Login first</td></tr>`;
      return;
    }
    const list = await loadMyBookings();
    if(!list.length){
      tbody.innerHTML = `<tr><td colspan="5" style="color:var(--muted)">‚Äî</td></tr>`;
      return;
    }

    for(const b of list){
      const start = new Date(b.startAtMs);
      const end = new Date(b.endAtMs);
      const timeStr = `${pad2(start.getHours())}:${pad2(start.getMinutes())} ‚Üí ${pad2(end.getHours())}:${pad2(end.getMinutes())}`;
      const dayStr = escapeHtml(b.dateKey || "");
      const nightMark = isCrossMidnight() && (minutesFromHHMM(`${pad2(start.getHours())}:${pad2(start.getMinutes())}`) < minutesFromHHMM(WORK_START)) ? " üåô(+1)" : "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${dayStr}</td>
        <td>${escapeHtml(timeStr)}${nightMark}</td>
        <td><b>${escapeHtml(b.pc)}</b></td>
        <td style="color:var(--muted)">${escapeHtml(b.note||"")}</td>
        <td><button class="mini danger" type="button">Cancel</button></td>
      `;
      tbody.appendChild(tr);

      tr.querySelector("button").addEventListener("click", async ()=>{
        if(!confirm("Cancel booking?")) return;
        try{
          await deleteBookingAndLocks(b);
          await refreshDayAndSlots();
          await renderMyBookings();
          setToast("–û—Ç–º–µ–Ω–µ–Ω–æ.", "good");
        }catch(e){
          console.error(e);
          setToast("–ù–µ –º–æ–≥—É –æ—Ç–º–µ–Ω–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å Firestore rules.", "bad");
        }
      });
    }
  }

  // =========================
  // TODAY (–ø–æ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–π –¥–∞—Ç–µ —Å–µ–π—á–∞—Å)
  // =========================
  async function renderToday(){
    const tbody = $("todayTable");
    tbody.innerHTML = "";
    const now = new Date();

    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±—Ä–æ–Ω–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ –ø–æ–ø–∞–¥–∞—é—Ç "—Å–µ–≥–æ–¥–Ω—è –ø–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—é" (startAtMs within today's day)
    const dayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0).getTime();
    const dayEnd = dayStart + 24*60*60*1000;

    try{
      // —á–∏—Ç–∞–µ–º –ø–æ dateKey —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –∏ –≤—á–µ—Ä–∞—à–Ω–µ–≥–æ (—á—Ç–æ–±—ã –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –Ω–æ—á–Ω—ã–µ)
      const todayKey = toISODate(now);
      const yKey = toISODate(addDays(now, -1));

      const [s1, s2] = await Promise.all([
        db.collection("bookings").where("dateKey","==", todayKey).get(),
        db.collection("bookings").where("dateKey","==", yKey).get(),
      ]);

      let list = [
        ...s1.docs.map(d=>({id:d.id, ...d.data()})),
        ...s2.docs.map(d=>({id:d.id, ...d.data()})),
      ];

      list = list.map(b=>({
        ...b,
        startAtMs: Number(b.startAtMs||0),
        endAtMs: Number(b.endAtMs||0),
      }))
      .filter(b => overlapsAbs(b.startAtMs, b.endAtMs, dayStart, dayEnd))
      .sort((a,b)=> (a.startAtMs - b.startAtMs) || String(a.pc).localeCompare(String(b.pc)));

      if(!list.length){
        tbody.innerHTML = `<tr><td colspan="4" style="color:var(--muted)">‚Äî</td></tr>`;
        return;
      }

      for(const b of list){
        const start = new Date(b.startAtMs);
        const end = new Date(b.endAtMs);
        const timeStr = `${pad2(start.getHours())}:${pad2(start.getMinutes())} ‚Üí ${pad2(end.getHours())}:${pad2(end.getMinutes())}`;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(timeStr)}</td>
          <td><b>${escapeHtml(b.pc)}</b></td>
          <td>${escapeHtml(b.nick||"")}</td>
          <td style="color:var(--muted)">${escapeHtml(b.note||"")}</td>
        `;
        tbody.appendChild(tr);
      }
    }catch(e){
      console.error(e);
      tbody.innerHTML = `<tr><td colspan="4" style="color:var(--muted)">Firestore error</td></tr>`;
    }
  }

  // =========================
  // ADMIN
  // =========================
  async function renderAdmin(){
    if(!isAdmin){ setToast("–¢—ã –Ω–µ –∞–¥–º–∏–Ω (–ø—Ä–æ–≤–µ—Ä—å ADMIN_EMAILS).", "bad"); return; }
    const dateKey = $("adminDate").value;
    const q = ($("adminSearch").value||"").trim().toLowerCase();
    const tbody = $("adminTable");
    tbody.innerHTML = "";

    if(!dateKey){
      tbody.innerHTML = `<tr><td colspan="6" style="color:var(--muted)">Pick date</td></tr>`;
      return;
    }

    try{
      const snap = await db.collection("bookings").where("dateKey","==",dateKey).get();
      let list = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      list = list.map(b=>({ ...b, startAtMs:Number(b.startAtMs||0), endAtMs:Number(b.endAtMs||0) }));

      if(q){
        list = list.filter(b =>
          (b.nick||"").toLowerCase().includes(q) ||
          (b.pc||"").toLowerCase().includes(q) ||
          (b.userEmail||"").toLowerCase().includes(q)
        );
      }

      list.sort((a,b)=> (a.startAtMs - b.startAtMs) || String(a.pc).localeCompare(String(b.pc)));

      if(!list.length){
        tbody.innerHTML = `<tr><td colspan="6" style="color:var(--muted)">‚Äî</td></tr>`;
        return;
      }

      for(const b of list){
        const start = new Date(b.startAtMs);
        const end = new Date(b.endAtMs);
        const timeStr = `${pad2(start.getHours())}:${pad2(start.getMinutes())} ‚Üí ${pad2(end.getHours())}:${pad2(end.getMinutes())}`;
        const nightMark = isCrossMidnight() && (minutesFromHHMM(`${pad2(start.getHours())}:${pad2(start.getMinutes())}`) < minutesFromHHMM(WORK_START)) ? " üåô(+1)" : "";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(b.dateKey||"")}</td>
          <td>${escapeHtml(timeStr)}${nightMark}</td>
          <td><b>${escapeHtml(b.pc)}</b></td>
          <td>${escapeHtml(b.nick||"")}</td>
          <td style="color:var(--muted)">${escapeHtml(b.userEmail||"")}</td>
          <td><button class="mini danger" type="button">Delete</button></td>
        `;
        tbody.appendChild(tr);

        tr.querySelector("button").addEventListener("click", async ()=>{
          if(!confirm("Delete booking?")) return;
          try{
            await deleteBookingAndLocks(b);
            await refreshDayAndSlots();
            await renderAdmin();
            setToast("–£–¥–∞–ª–µ–Ω–æ.", "good");
          }catch(e){
            console.error(e);
            setToast("–ù–µ –º–æ–≥—É —É–¥–∞–ª–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å rules.", "bad");
          }
        });
      }
    }catch(e){
      console.error(e);
      setToast("Admin load error. Check rules.", "bad");
    }
  }

  // =========================
  // EVENTS
  // =========================
  function bindEvents(){
    $("lang_ru").onclick = ()=>{ lang="ru"; localStorage.setItem(LANG_KEY,lang); applyLang(); };
    $("lang_en").onclick = ()=>{ lang="en"; localStorage.setItem(LANG_KEY,lang); applyLang(); };
    $("lang_ka").onclick = ()=>{ lang="ka"; localStorage.setItem(LANG_KEY,lang); applyLang(); };

    $("openAuthBtn").onclick = openModal;
    $("authCloseBtn").onclick = closeModal;
    $("authBackdrop").onclick = (e)=>{ if(e.target === $("authBackdrop")) closeModal(); };

    $("doLoginBtn").onclick = async ()=>{
      const email = ($("authEmail").value||"").trim();
      const pass = ($("authPass").value||"").trim();
      if(!email || !pass){ $("authModalMsg").textContent = "–í–≤–µ–¥–∏—Ç–µ email+password"; return; }
      try{
        await auth.signInWithEmailAndPassword(email, pass);
        $("authModalMsg").textContent = "OK";
        closeModal();
      }catch(e){
        console.error(e);
        $("authModalMsg").textContent = e.message || "Login error";
      }
    };

    $("doRegisterBtn").onclick = async ()=>{
      const email = ($("authEmail").value||"").trim();
      const pass = ($("authPass").value||"").trim();
      if(!email || !pass){ $("authModalMsg").textContent = "–í–≤–µ–¥–∏—Ç–µ email+password"; return; }
      try{
        await auth.createUserWithEmailAndPassword(email, pass);
        $("authModalMsg").textContent = "Created!";
        closeModal();
      }catch(e){
        console.error(e);
        $("authModalMsg").textContent = e.message || "Register error";
      }
    };

    $("forgotBtn").onclick = async ()=>{
      const email = ($("authEmail").value||"").trim();
      if(!email){ $("authModalMsg").textContent = "–í–≤–µ–¥–∏—Ç–µ email"; return; }
      try{
        await auth.sendPasswordResetEmail(email);
        $("authModalMsg").textContent = "–ü–∏—Å—å–º–æ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ";
      }catch(e){
        console.error(e);
        $("authModalMsg").textContent = e.message || "Reset error";
      }
    };

    $("logoutBtn").onclick = async ()=>{ try{ await auth.signOut(); }catch(e){} };

    $("date").addEventListener("change", async ()=>{ await refreshDayAndSlots(); });
    $("duration").addEventListener("change", ()=>{ rebuildSlots(); });
    $("createBtn").onclick = createBooking;

    $("myBtn").onclick = async ()=>{
      show($("myBox"));
      hide($("todayBox"));
      hide($("adminBox"));
      await renderMyBookings();
      $("myBox").scrollIntoView({behavior:"smooth", block:"start"});
    };
    $("closeMyBtn").onclick = ()=> hide($("myBox"));

    $("todayBtn").onclick = async ()=>{
      hide($("myBox"));
      show($("todayBox"));
      hide($("adminBox"));
      await renderToday();
      $("todayBox").scrollIntoView({behavior:"smooth", block:"start"});
    };
    $("closeTodayBtn").onclick = ()=> hide($("todayBox"));

    // admin
    $("openAdminBtn").onclick = async ()=>{
      if(!currentUser){ setToast("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏.", "bad"); return; }
      if(!isAdmin){ setToast("–¢—ã –Ω–µ –∞–¥–º–∏–Ω. –î–æ–±–∞–≤—å —Å–≤–æ–π email –≤ ADMIN_EMAILS.", "bad"); return; }
      hide($("myBox")); hide($("todayBox"));
      show($("adminBox"));
      $("adminDate").value = $("adminDate").value || $("date").value;
      await renderAdmin();
      $("adminBox").scrollIntoView({behavior:"smooth", block:"start"});
    };
    $("adminCloseBtn").onclick = ()=> hide($("adminBox"));
    $("refreshAdminBtn").onclick = renderAdmin;
    $("adminDate").addEventListener("change", renderAdmin);
    $("adminSearch").addEventListener("input", ()=>{ renderAdmin(); });

    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        hide($("myBox")); hide($("todayBox")); hide($("adminBox"));
        closeModal();
      }
    });
  }

  // =========================
  // BOOT
  // =========================
  async function boot(){
    const now = new Date();
    $("date").value = toISODate(now);
    $("adminDate").value = toISODate(now);

    if(!i18n[lang]) lang="ru";
    applyLang();

    renderPCGrid();

    const savedNick = localStorage.getItem("sg_nick") || "";
    if(savedNick) $("nick").value = savedNick;
    $("nick").addEventListener("input", ()=> localStorage.setItem("sg_nick", ($("nick").value||"").trim()));

    bindEvents();

    // init message
    setToast("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏, —á—Ç–æ–±—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å.", "info");

    // auth state
    auth.onAuthStateChanged(async (u)=>{
      currentUser = u || null;
      updateAuthUI();

      if(currentUser){
        $("authMsg").textContent = `‚úÖ Logged in: ${currentUser.email || currentUser.uid.slice(0,6)}`;
        setToast("–í—ã–±–µ—Ä–∏ –ü–ö –∏ —Å–ª–æ—Ç.", "info");

        if(!($("nick").value||"").trim()){
          try{
            const pn = await loadProfileNick(currentUser.uid);
            if(pn) $("nick").value = pn;
          }catch(e){}
        }
      }else{
        $("authMsg").textContent = "‚Äî";
        setToast("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏, —á—Ç–æ–±—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å.", "info");
      }

      await refreshDayAndSlots();
    });
  }

  boot();
})();
</script>
</body>
</html>
