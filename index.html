<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sakompiutere Gaming â€” Booking</title>
  <meta name="theme-color" content="#0b1020" />

  <!-- Firebase v9 COMPAT -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#070a12;
      --card:#0b1020;
      --muted:#9aa4bf;
      --text:#eaf0ff;
      --line:rgba(255,255,255,.08);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
      --shadow:0 20px 60px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(110,231,255,.12), transparent 60%),
        radial-gradient(900px 700px at 80% 10%, rgba(167,139,250,.14), transparent 60%),
        radial-gradient(800px 700px at 40% 120%, rgba(52,211,153,.10), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1180px; margin:0 auto; padding:18px;}
    header{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 16px; border:1px solid var(--line); border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      position:sticky; top:14px; z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: radial-gradient(circle at 30% 20%, rgba(110,231,255,.9), rgba(167,139,250,.8) 40%, rgba(0,0,0,0) 72%),
                  linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.02));
      border:1px solid var(--line);
      box-shadow: 0 12px 30px rgba(0,0,0,.4);
    }
    .brand h1{margin:0; font-size:16px; letter-spacing:.4px}
    .brand .sub{margin:0; color:var(--muted); font-size:12px}

    .rightbar{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center;}
    .pill{
      padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--muted); font-size:12px;
    }
    .pill strong{color:var(--text); font-weight:900}

    .lang{
      display:flex; gap:6px;
      padding:6px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
    }
    .lang button{
      padding:7px 10px; border-radius:999px;
      border:1px solid transparent;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      font-weight:900;
      font-size:12px;
    }
    .lang button.active{
      border-color: rgba(110,231,255,.55);
      background: rgba(110,231,255,.10);
      color: var(--text);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:18px;
      margin-top:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
      header{position:static;}
    }

    .card{
      border:1px solid var(--line);
      border-radius:var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
    }
    .hd h2{margin:0; font-size:14px}
    .hint{color:var(--muted); font-size:12px}
    .bd{padding:14px 16px}

    .notice{
      border:1px dashed rgba(110,231,255,.35);
      background: rgba(110,231,255,.06);
      padding:12px 12px;
      border-radius:16px;
      font-size:12px;
      line-height:1.35;
    }

    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:1000;
      letter-spacing:.2px;
    }
    button:hover{border-color: rgba(110,231,255,.5)}
    .primary{
      border-color: rgba(110,231,255,.55);
      background: linear-gradient(180deg, rgba(110,231,255,.18), rgba(167,139,250,.10));
    }
    .ghost{background:transparent}
    .danger{border-color: rgba(251,113,133,.6); background: rgba(251,113,133,.10)}
    .mini{padding:6px 10px; border-radius:12px; font-size:12px; font-weight:1000}

    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    input:focus, select:focus{border-color: rgba(110,231,255,.6); box-shadow:0 0 0 3px rgba(110,231,255,.12)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;}
    @media (max-width:520px){ .row{grid-template-columns:1fr;} }

    .pcgrid{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 980px){ .pcgrid{grid-template-columns: repeat(2, 1fr);} }

    .pc{
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(0,0,0,.22);
      cursor:pointer;
      transition: transform .08s ease, border-color .12s ease, box-shadow .12s ease;
      user-select:none;
      position:relative;
      min-height:74px;
    }
    .pc:hover{transform: translateY(-1px); border-color: rgba(110,231,255,.4)}
    .pc .name{font-weight:1100; letter-spacing:.3px}
    .pc .meta{margin-top:6px; color:var(--muted); font-size:12px}
    .pc.selected{
      border-color: rgba(110,231,255,.75);
      box-shadow: 0 0 0 3px rgba(110,231,255,.10);
    }
    .check{
      position:absolute; top:10px; right:10px;
      width:22px; height:22px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.35);
      display:grid; place-items:center;
      color: transparent;
      font-weight:1100;
      font-size:12px;
    }
    .pc.selected .check{
      border-color: rgba(110,231,255,.75);
      background: rgba(110,231,255,.14);
      color: var(--text);
    }

    .chipbar{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .chip{
      padding:10px 12px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      cursor:pointer;
      font-weight:1100;
      font-size:12px;
      user-select:none;
      white-space:nowrap;
    }
    .chip:hover{border-color: rgba(110,231,255,.5)}
    .chip.active{
      border-color: rgba(110,231,255,.75);
      background: rgba(110,231,255,.10);
      box-shadow: 0 0 0 3px rgba(110,231,255,.10);
    }
    .chip.busy{
      border-color: rgba(251,113,133,.65);
      background: rgba(251,113,133,.08);
      color: rgba(251,113,133,.95);
      cursor:not-allowed;
      opacity:.95;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:16px;
      margin-top:10px;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
      font-size:12px;
    }
    th{color:var(--muted); font-weight:1100; text-align:left; background:rgba(255,255,255,.03)}
    tr:last-child td{border-bottom:none}

    .footerbar{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-top:12px;
      color: var(--muted);
      font-size:12px;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      padding:2px 6px;
      border:1px solid var(--line);
      border-radius:8px;
      background:rgba(0,0,0,.25);
      color:var(--muted);
      font-size:12px;
    }
    .hide{display:none !important;}

    .backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .backdrop.show{display:flex;}
    .modal{
      width:min(560px, 100%);
      border:1px solid var(--line);
      border-radius:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .mh{
      padding:14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border-bottom:1px solid var(--line);
    }
    .mb{padding:14px 16px}
    .mut{color:var(--muted); font-size:12px}
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1 id="t_title">Sakompiutere Gaming â€” Booking</h1>
        <p class="sub" id="t_sub">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ ĞŸĞš â†’ Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸ ÑĞ»Ğ¾Ñ‚ â†’ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ</p>
      </div>
    </div>

    <div class="rightbar">
      <div class="lang" aria-label="Language selector">
        <button id="lang_ru" type="button">RU</button>
        <button id="lang_en" type="button">EN</button>
        <button id="lang_ka" type="button">KA</button>
      </div>
      <div class="pill"><span id="t_user">ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ</span>: <strong id="userPill">â€”</strong></div>
      <div class="pill"><span id="t_status">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</span>: <strong id="cloudPill">â€¦</strong></div>
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <div class="hd">
        <h2 id="t_main">Ğ‘Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ</h2>
        <div class="hint" id="hintTop">Firebase Ğ²ĞºĞ»ÑÑ‡Ñ‘Ğ½: Ğ¾Ğ±Ñ‰Ğ°Ñ Ğ±Ğ°Ğ·Ğ° Ğ´Ğ»Ñ Ğ²ÑĞµÑ…</div>
      </div>

      <div class="bd">
        <div class="notice" id="authBar">
          <b id="t_authTitle">ĞĞºĞºĞ°ÑƒĞ½Ñ‚</b><br/>
          <span id="t_authDesc">Ğ”Ğ»Ñ Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ½ÑƒĞ¶ĞµĞ½ Ğ»Ğ¾Ğ³Ğ¸Ğ½.</span>
          <div class="btns">
            <button class="primary" id="openAuthBtn" type="button">ğŸ”‘ <span id="t_login">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</span> / <span id="t_register">Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ</span></button>
            <button class="ghost hide" id="logoutBtn" type="button">ğŸšª <span id="t_logout">Ğ’Ñ‹Ğ¹Ñ‚Ğ¸</span></button>
          </div>
          <div class="notice" style="margin-top:10px" id="authMsg">â€”</div>
        </div>

        <div class="notice" style="margin-top:12px" id="flowHelp">
          <b id="t_flowTitle">ĞšĞ°Ğº Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</b><br/>
          <span id="t_flow1">1) Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ 1 Ğ¸Ğ»Ğ¸ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ĞŸĞš</span><br/>
          <span id="t_flow2">2) Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ´Ğ°Ñ‚Ñƒ Ğ¸ Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ</span><br/>
          <span id="t_flow3">3) Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ ÑƒĞ´Ğ¾Ğ±Ğ½Ñ‹Ğ¹ ÑĞ»Ğ¾Ñ‚ (Ğ·ĞµĞ»Ñ‘Ğ½Ñ‹Ğ¹ ÑĞ²Ğ¾Ğ±Ğ¾Ğ´ĞµĞ½)</span><br/>
          <span id="t_flow4">4) ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸</span>
        </div>

        <div style="margin-top:12px">
          <div class="row">
            <div>
              <label id="t_nickLabel">Ğ¢Ğ²Ğ¾Ğ¹ Ğ½Ğ¸Ğº (Ğ² ĞºĞ»ÑƒĞ±Ğµ)</label>
              <input id="nick" type="text" placeholder="Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: KiraLite" />
            </div>
            <div>
              <label id="t_dateLabel">Ğ”Ğ°Ñ‚Ğ°</label>
              <input id="date" type="date" />
            </div>
          </div>

          <div class="row">
            <div>
              <label id="t_duration">Ğ”Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ</label>
              <select id="duration">
                <option value="60">1h</option>
                <option value="90">1h 30m</option>
                <option value="120">2h</option>
                <option value="180">3h</option>
                <option value="240">4h</option>
              </select>
            </div>
            <div>
              <label id="t_noteLabel">ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)</label>
              <input id="note" type="text" placeholder="CS2 / Ğ¢ÑƒÑ€Ğ½Ğ¸Ñ€" />
            </div>
          </div>

          <div class="hint" id="t_pickpc">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ ĞŸĞš (Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾):</div>
          <div id="pcGrid" class="pcgrid"></div>

          <div class="notice" style="margin-top:10px">
            <b id="t_slotsTitle">Ğ¡Ğ»Ğ¾Ñ‚Ñ‹</b><br/>
            <span id="t_slotsDesc">Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸ ĞŸĞš Ğ¸ Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ â€” Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ğ¿Ğ¾ÑĞ²ÑÑ‚ÑÑ ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ñ‹Ğµ ÑĞ»Ğ¾Ñ‚Ñ‹.</span>
            <div class="chipbar" id="slotChips"></div>
          </div>

          <div class="btns" style="margin-top:12px">
            <button class="primary" id="createBtn" type="button">âœ… <span id="t_bookNow">Ğ—Ğ°Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</span></button>
            <button class="ghost" id="myBtn" type="button">ğŸ‘¤ <span id="t_my">ĞœĞ¾Ğ¸ Ğ±Ñ€Ğ¾Ğ½Ğ¸</span></button>
            <button class="ghost" id="todayBtn" type="button">ğŸ“… <span id="t_today">Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ</span></button>
          </div>

          <div class="notice" style="margin-top:10px" id="msgBox">â€”</div>
        </div>

        <div id="myBox" class="hide" style="margin-top:14px">
          <div class="btns">
            <button class="ghost" id="closeMyBtn" type="button">âœ– <span id="t_close">Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ</span></button>
          </div>
          <table>
            <thead>
              <tr>
                <th id="t_colDate">Ğ”Ğ°Ñ‚Ğ°</th>
                <th id="t_colTime">Ğ’Ñ€ĞµĞ¼Ñ</th>
                <th id="t_colPc">ĞŸĞš</th>
                <th id="t_colNote">ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹</th>
                <th id="t_colAct">Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</th>
              </tr>
            </thead>
            <tbody id="myTable"></tbody>
          </table>
        </div>

        <div id="todayBox" class="hide" style="margin-top:14px">
          <div class="btns">
            <button class="ghost" id="closeTodayBtn" type="button">âœ– <span id="t_close2">Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ</span></button>
          </div>
          <table>
            <thead>
              <tr>
                <th id="t_colTime2">Ğ’Ñ€ĞµĞ¼Ñ</th>
                <th id="t_colPc2">ĞŸĞš</th>
                <th id="t_colNick2">ĞĞ¸Ğº</th>
                <th id="t_colNote2">ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹</th>
              </tr>
            </thead>
            <tbody id="todayTable"></tbody>
          </table>
        </div>

        <div class="footerbar">
          <div><span class="kbd">Esc</span> â€” <span id="t_esc">Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¾ĞºĞ½Ğ°</span></div>
        </div>

      </div>
    </div>

    <div class="card">
      <div class="hd">
        <h2 id="t_side">ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°</h2>
        <div class="hint" id="t_side2">Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ³Ñ€Ğ¾Ğº Ğ¿Ğ¾Ğ½ÑĞ» ÑÑ€Ğ°Ğ·Ñƒ</div>
      </div>
      <div class="bd">
        <div class="notice" id="helpBox"></div>
        <div style="height:12px"></div>
        <div class="notice" id="rulesBox"></div>
        <div style="height:12px"></div>
        <div class="notice">
          <b>Ğ’Ğ°Ğ¶Ğ½Ğ¾</b><br/>
          Firebase Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ° <b>http(s)</b>. ĞĞ° <b>file:///</b> Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ/Ğ±Ğ°Ğ·Ğ° Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ¾Ğ¼.
        </div>
      </div>
    </div>
  </div>
</div>

<div class="backdrop" id="authBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="mh">
      <div>
        <b id="t_authModal">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ / Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ</b>
        <div class="mut" id="t_authModal2">Email + Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ</div>
      </div>
      <button id="authCloseBtn" type="button">âœ–</button>
    </div>
    <div class="mb">
      <div class="row">
        <div>
          <label>Email</label>
          <input id="authEmail" type="email" placeholder="email@example.com" />
        </div>
        <div>
          <label>Password</label>
          <input id="authPass" type="password" placeholder="******" />
        </div>
      </div>
      <div class="btns">
        <button class="primary" id="doLoginBtn" type="button">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</button>
        <button class="ghost" id="doRegisterBtn" type="button">Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ</button>
      </div>
      <div class="notice" style="margin-top:10px" id="authModalMsg">â€”</div>
    </div>
  </div>
</div>

<script>
(() => {
  // =========================
  // FIREBASE CONFIG (Ñ‚Ğ²Ğ¾Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ)
  // =========================
  const firebaseConfig = {
    apiKey: "AIzaSyDJ-5e_xLPW9PnYT66ENey_Ndh8HJdI5wc",
    authDomain: "sakompiutere-gaming.firebaseapp.com",
    projectId: "sakompiutere-gaming",
    storageBucket: "sakompiutere-gaming.firebasestorage.app",
    messagingSenderId: "508996154674",
    appId: "1:508996154674:web:0b6e475d284c49ba80d32b",
    measurementId: "G-H2HKS025KH"
  };

  // =========================
  // CLUB CONFIG
  // =========================
  const PCs = ["Bishop","Godzilla","Elf","Kadita","Orc","Lancelot","Fantomas","Soultaker","Pudge","Kratos"];
  const SLOT_STEP_MIN = 30;

  const WORKING_HOURS_ENABLED = true;
  const WORK_START = "10:00";
  const WORK_END = "03:00"; // next day

  // =========================
  // LOCKS (Ğ²Ğ°Ğ¶Ğ½Ğ¾: ÑÑ‚Ğ¾ Ñ„Ğ¸ĞºÑĞ¸Ñ‚ tx.get(query) Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ)
  // =========================
  const LOCKS_COLLECTION = "locks";

  // =========================
  // HELPERS
  // =========================
  const $ = (id) => document.getElementById(id);
  const pad2 = (n)=>String(n).padStart(2,"0");
  const toISODate = (d)=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const parseISODate = (iso)=>{ const [y,m,d]=iso.split("-").map(Number); return new Date(y,m-1,d,0,0,0,0); };
  const minutesFromHHMM = (t)=>{ const [h,m]=t.split(":").map(Number); return h*60+m; };
  const hhmmFromMinutes = (min)=>{ min=((min%1440)+1440)%1440; const h=Math.floor(min/60), m=min%60; return `${pad2(h)}:${pad2(m)}`; };

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function setMsg(text, kind="info"){
    const el = $("msgBox");
    el.textContent = text;
    el.style.borderColor =
      kind==="good" ? "rgba(52,211,153,.45)" :
      kind==="bad" ? "rgba(251,113,133,.55)" :
      "rgba(110,231,255,.35)";
    el.style.background =
      kind==="good" ? "rgba(52,211,153,.08)" :
      kind==="bad" ? "rgba(251,113,133,.08)" :
      "rgba(110,231,255,.06)";
  }

  function show(el){ el.classList.remove("hide"); }
  function hide(el){ el.classList.add("hide"); }
  function openModal(){ $("authBackdrop").classList.add("show"); }
  function closeModal(){ $("authBackdrop").classList.remove("show"); }

  function isCrossMidnight(){
    if(!WORKING_HOURS_ENABLED) return false;
    const ws = minutesFromHHMM(WORK_START);
    const we = minutesFromHHMM(WORK_END);
    return we <= ws;
  }

  // =========================
  // i18n (Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼)
  // =========================
  const LANG_KEY = "sg_lang";
  let lang = localStorage.getItem(LANG_KEY) || "ru";

  const i18n = {
    ru: {
      title:"Sakompiutere Gaming â€” Booking",
      sub:"Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ ĞŸĞš â†’ Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸ ÑĞ»Ğ¾Ñ‚ â†’ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ",
      user:"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ", status:"Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ",
      main:"Ğ‘Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ",
      authTitle:"ĞĞºĞºĞ°ÑƒĞ½Ñ‚",
      authDesc:"Ğ”Ğ»Ñ Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ½ÑƒĞ¶ĞµĞ½ Ğ»Ğ¾Ğ³Ğ¸Ğ½.",
      login:"Ğ’Ğ¾Ğ¹Ñ‚Ğ¸", register:"Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ", logout:"Ğ’Ñ‹Ğ¹Ñ‚Ğ¸",
      flowTitle:"ĞšĞ°Ğº Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ",
      flow1:"1) Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ 1 Ğ¸Ğ»Ğ¸ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ĞŸĞš",
      flow2:"2) Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ´Ğ°Ñ‚Ñƒ Ğ¸ Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ",
      flow3:"3) Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ ÑƒĞ´Ğ¾Ğ±Ğ½Ñ‹Ğ¹ ÑĞ»Ğ¾Ñ‚ (Ğ·ĞµĞ»Ñ‘Ğ½Ñ‹Ğ¹ ÑĞ²Ğ¾Ğ±Ğ¾Ğ´ĞµĞ½)",
      flow4:"4) ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸",
      nickLabel:"Ğ¢Ğ²Ğ¾Ğ¹ Ğ½Ğ¸Ğº (Ğ² ĞºĞ»ÑƒĞ±Ğµ)",
      dateLabel:"Ğ”Ğ°Ñ‚Ğ°",
      duration:"Ğ”Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ",
      note:"ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)",
      pickpc:"Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ ĞŸĞš (Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾):",
      slotsTitle:"Ğ¡Ğ»Ğ¾Ñ‚Ñ‹",
      slotsDesc:"Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸ ĞŸĞš Ğ¸ Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ â€” Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ğ¿Ğ¾ÑĞ²ÑÑ‚ÑÑ ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ñ‹Ğµ ÑĞ»Ğ¾Ñ‚Ñ‹.",
      bookNow:"Ğ—Ğ°Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ",
      my:"ĞœĞ¾Ğ¸ Ğ±Ñ€Ğ¾Ğ½Ğ¸",
      today:"Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ",
      close:"Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ",
      colDate:"Ğ”Ğ°Ñ‚Ğ°",
      colTime:"Ğ’Ñ€ĞµĞ¼Ñ",
      colPc:"ĞŸĞš",
      colNote:"ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹",
      colAct:"Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ",
      side:"ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°",
      side2:"Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ³Ñ€Ğ¾Ğº Ğ¿Ğ¾Ğ½ÑĞ» ÑÑ€Ğ°Ğ·Ñƒ",
      help:`âœ… Ğ‘Ñ‹ÑÑ‚Ñ€Ğ¾:
1) Ğ’Ğ¾Ğ¹Ğ´Ğ¸
2) Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ ĞŸĞš
3) Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ´Ğ°Ñ‚Ñƒ, Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ
4) Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ ÑĞ»Ğ¾Ñ‚ â†’ â€œĞ—Ğ°Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒâ€

ğŸ‘¤ â€œĞœĞ¾Ğ¸ Ğ±Ñ€Ğ¾Ğ½Ğ¸â€ â€” Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€/Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ°.`,
      rulesTitle:"ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ°",
      rulesBody:"â€¢ ĞĞµĞ»ÑŒĞ·Ñ Ğ¿ĞµÑ€ĞµÑĞµĞºĞ°Ñ‚ÑŒ Ğ±Ñ€Ğ¾Ğ½Ğ¸ Ğ½Ğ° Ğ¾Ğ´Ğ½Ğ¾Ğ¼ ĞŸĞš<br/>â€¢ Ğ¡Ğ»Ğ¾Ñ‚ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‡Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¿Ğ¾ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¼ ĞŸĞš<br/>â€¢ Ğ”Ğ»Ñ Ğ¾Ğ±Ñ‰ĞµĞ¹ Ğ±Ğ°Ğ·Ñ‹ Ğ²ĞºĞ»ÑÑ‡Ñ‘Ğ½ Firebase",
      esc:"Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¾ĞºĞ½Ğ°",
    },
    en: {
      title:"Sakompiutere Gaming â€” Booking",
      sub:"Pick PC â†’ pick slot â†’ confirm",
      user:"User", status:"Status",
      main:"Booking",
      authTitle:"Account",
      authDesc:"Login required to book.",
      login:"Login", register:"Register", logout:"Logout",
      flowTitle:"How to book",
      flow1:"1) Select one or multiple PCs",
      flow2:"2) Pick date & duration",
      flow3:"3) Pick a slot (green = free)",
      flow4:"4) Confirm",
      nickLabel:"Your club nickname",
      dateLabel:"Date",
      duration:"Duration",
      note:"Note (optional)",
      pickpc:"Select PCs (multi-select):",
      slotsTitle:"Slots",
      slotsDesc:"Pick PCs + duration first â€” then you will see available slots.",
      bookNow:"Book now",
      my:"My bookings",
      today:"Today",
      close:"Close",
      colDate:"Date",
      colTime:"Time",
      colPc:"PC",
      colNote:"Note",
      colAct:"Actions",
      side:"Hint",
      side2:"so users understand fast",
      help:`âœ… Quick:
1) Login
2) Choose PCs
3) Choose date & duration
4) Choose slot â†’ â€œBook nowâ€

ğŸ‘¤ â€œMy bookingsâ€ â€” view/cancel.`,
      rulesTitle:"Rules",
      rulesBody:"â€¢ No overlaps on the same PC<br/>â€¢ Slots depend on selected PCs<br/>â€¢ Firebase enabled (shared DB)",
      esc:"close panels",
    },
    ka: {
      title:"Sakompiutere Gaming â€” Booking",
      sub:"áƒáƒ˜áƒ áƒ©áƒ˜áƒ” PC â†’ áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ¡áƒšáƒáƒ¢áƒ˜ â†’ áƒ“áƒáƒáƒ“áƒáƒ¡áƒ¢áƒ£áƒ áƒ”",
      user:"áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜", status:"áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜",
      main:"áƒ¯áƒáƒ•áƒ¨áƒáƒœáƒ˜",
      authTitle:"áƒáƒ¥áƒáƒ£áƒœáƒ—áƒ˜",
      authDesc:"áƒ¯áƒáƒ•áƒ¨áƒœáƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡ áƒ¡áƒáƒ­áƒ˜áƒ áƒáƒ áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ.",
      login:"áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ", register:"áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ", logout:"áƒ’áƒáƒ¡áƒ•áƒšáƒ",
      flowTitle:"áƒ áƒáƒ’áƒáƒ  áƒ“áƒáƒ•áƒ¯áƒáƒ•áƒ¨áƒœáƒ",
      flow1:"1) áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ”áƒ áƒ—áƒ˜ áƒáƒœ áƒ áƒáƒ›áƒ“áƒ”áƒœáƒ˜áƒ›áƒ” PC",
      flow2:"2) áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜ áƒ“áƒ áƒ®áƒáƒœáƒ’áƒ áƒ«áƒšáƒ˜áƒ•áƒáƒ‘áƒ",
      flow3:"3) áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ¡áƒšáƒáƒ¢áƒ˜ (áƒ›áƒ¬áƒ•áƒáƒœáƒ” = áƒ—áƒáƒ•áƒ˜áƒ¡áƒ£áƒ¤áƒáƒšáƒ˜)",
      flow4:"4) áƒ“áƒáƒáƒ“áƒáƒ¡áƒ¢áƒ£áƒ áƒ”",
      nickLabel:"áƒœáƒ˜áƒ™áƒ˜ (áƒ™áƒšáƒ£áƒ‘áƒ¨áƒ˜)",
      dateLabel:"áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜",
      duration:"áƒ®áƒáƒœáƒ’áƒ áƒ«áƒšáƒ˜áƒ•áƒáƒ‘áƒ",
      note:"áƒ¨áƒ”áƒœáƒ˜áƒ¨áƒ•áƒœáƒ (áƒáƒ áƒáƒ¡áƒáƒ•áƒáƒšáƒ“áƒ”áƒ‘áƒ£áƒšáƒ)",
      pickpc:"áƒáƒ˜áƒ áƒ©áƒ˜áƒ” PC-áƒ”áƒ‘áƒ˜ (áƒ¨áƒ”áƒ˜áƒ«áƒšáƒ”áƒ‘áƒ áƒ áƒáƒ›áƒ“áƒ”áƒœáƒ˜áƒ›áƒ”):",
      slotsTitle:"áƒ¡áƒšáƒáƒ¢áƒ”áƒ‘áƒ˜",
      slotsDesc:"áƒ¯áƒ”áƒ  áƒáƒ˜áƒ áƒ©áƒ˜áƒ” PC áƒ“áƒ áƒ®áƒáƒœáƒ’áƒ áƒ«áƒšáƒ˜áƒ•áƒáƒ‘áƒ â€” áƒ¨áƒ”áƒ›áƒ“áƒ”áƒ’ áƒ’áƒáƒ›áƒáƒ©áƒœáƒ“áƒ”áƒ‘áƒ áƒ—áƒáƒ•áƒ˜áƒ¡áƒ£áƒ¤áƒáƒšáƒ˜ áƒ¡áƒšáƒáƒ¢áƒ”áƒ‘áƒ˜.",
      bookNow:"áƒ“áƒáƒ¯áƒáƒ•áƒ¨áƒœáƒ",
      my:"áƒ©áƒ”áƒ›áƒ˜ áƒ¯áƒáƒ•áƒ¨áƒœáƒ”áƒ‘áƒ˜",
      today:"áƒ“áƒ¦áƒ”áƒ¡",
      close:"áƒ“áƒáƒ®áƒ£áƒ áƒ•áƒ",
      colDate:"áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜",
      colTime:"áƒ“áƒ áƒ",
      colPc:"PC",
      colNote:"áƒ¨áƒ”áƒœáƒ˜áƒ¨áƒ•áƒœáƒ",
      colAct:"áƒ¥áƒ›áƒ”áƒ“áƒ”áƒ‘áƒ",
      side:"áƒ›áƒ˜áƒœáƒ˜áƒ¨áƒœáƒ”áƒ‘áƒ",
      side2:"áƒ áƒáƒ› áƒ¡áƒ¬áƒ áƒáƒ¤áƒáƒ“ áƒ’áƒáƒ˜áƒ’áƒáƒœ",
      help:`âœ… áƒ¡áƒ¬áƒ áƒáƒ¤áƒáƒ“:
1) áƒ¨áƒ”áƒ“áƒ˜
2) áƒáƒ˜áƒ áƒ©áƒ˜áƒ” PC-áƒ”áƒ‘áƒ˜
3) áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜ áƒ“áƒ áƒ®áƒáƒœáƒ’áƒ áƒ«áƒšáƒ˜áƒ•áƒáƒ‘áƒ
4) áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ¡áƒšáƒáƒ¢áƒ˜ â†’ â€œáƒ“áƒáƒ¯áƒáƒ•áƒ¨áƒœáƒâ€

ğŸ‘¤ â€œáƒ©áƒ”áƒ›áƒ˜ áƒ¯áƒáƒ•áƒ¨áƒœáƒ”áƒ‘áƒ˜â€ â€” áƒœáƒáƒ®áƒ•áƒ/áƒ’áƒáƒ£áƒ¥áƒ›áƒ”áƒ‘áƒ.`,
      rulesTitle:"áƒ¬áƒ”áƒ¡áƒ”áƒ‘áƒ˜",
      rulesBody:"â€¢ áƒ”áƒ áƒ— PC-áƒ–áƒ” áƒ’áƒáƒ“áƒáƒ™áƒ•áƒ”áƒ—áƒ áƒáƒ  áƒ¨áƒ”áƒ˜áƒ«áƒšáƒ”áƒ‘áƒ<br/>â€¢ áƒ¡áƒšáƒáƒ¢áƒ”áƒ‘áƒ˜ áƒ“áƒáƒ›áƒáƒ™áƒ˜áƒ“áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ áƒáƒ áƒ©áƒ”áƒ£áƒš PC-áƒ–áƒ”<br/>â€¢ Firebase áƒ©áƒáƒ áƒ—áƒ£áƒšáƒ˜áƒ (áƒ¡áƒáƒ”áƒ áƒ—áƒ áƒ‘áƒáƒ–áƒ)",
      esc:"áƒ¤áƒáƒœáƒ¯áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ“áƒáƒ®áƒ£áƒ áƒ•áƒ",
    }
  };

  function t(k){ return (i18n[lang] && i18n[lang][k]) || i18n.ru[k] || k; }
  function applyLang(){
    $("t_title").textContent = t("title");
    $("t_sub").textContent = t("sub");
    $("t_user").textContent = t("user");
    $("t_status").textContent = t("status");
    $("t_main").textContent = t("main");
    $("t_authTitle").textContent = t("authTitle");
    $("t_authDesc").textContent = t("authDesc");
    $("t_login").textContent = t("login");
    $("t_register").textContent = t("register");
    $("t_logout").textContent = t("logout");
    $("t_flowTitle").textContent = t("flowTitle");
    $("t_flow1").textContent = t("flow1");
    $("t_flow2").textContent = t("flow2");
    $("t_flow3").textContent = t("flow3");
    $("t_flow4").textContent = t("flow4");
    $("t_nickLabel").textContent = t("nickLabel");
    $("t_dateLabel").textContent = t("dateLabel");
    $("t_duration").textContent = t("duration");
    $("t_noteLabel").textContent = t("note");
    $("t_pickpc").textContent = t("pickpc");
    $("t_slotsTitle").textContent = t("slotsTitle");
    $("t_slotsDesc").textContent = t("slotsDesc");
    $("t_bookNow").textContent = t("bookNow");
    $("t_my").textContent = t("my");
    $("t_today").textContent = t("today");
    $("t_close").textContent = t("close");
    $("t_close2").textContent = t("close");
    $("t_colDate").textContent = t("colDate");
    $("t_colTime").textContent = t("colTime");
    $("t_colPc").textContent = t("colPc");
    $("t_colNote").textContent = t("colNote");
    $("t_colAct").textContent = t("colAct");
    $("t_side").textContent = t("side");
    $("t_side2").textContent = t("side2");
    $("helpBox").textContent = t("help");
    $("rulesBox").innerHTML = `<b>${t("rulesTitle")}</b><br/>${t("rulesBody")}`;
    $("t_esc").textContent = t("esc");

    $("lang_ru").classList.toggle("active", lang==="ru");
    $("lang_en").classList.toggle("active", lang==="en");
    $("lang_ka").classList.toggle("active", lang==="ka");
  }

  // =========================
  // FIREBASE INIT
  // =========================
  let app, auth, db;
  let currentUser = null;

  function setCloud(text){ $("cloudPill").textContent = text; }

  try{
    app = firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.firestore();
    setCloud("OK");
  }catch(e){
    console.error(e);
    setCloud("ERROR");
    setMsg("Firebase init error. Open Console (F12).", "bad");
  }

  // =========================
  // UI STATE
  // =========================
  let selectedPCs = new Set();
  let selectedSlot = null;
  let cachedDayBookings = [];

  function renderPCGrid(){
    const grid = $("pcGrid");
    grid.innerHTML = "";
    for(const pc of PCs){
      const div = document.createElement("div");
      div.className = "pc" + (selectedPCs.has(pc) ? " selected" : "");
      div.innerHTML = `
        <div class="check">âœ“</div>
        <div class="name">${pc}</div>
        <div class="meta">${selectedPCs.has(pc) ? "Selected" : "Tap to select"}</div>
      `;
      div.addEventListener("click", ()=>{
        if(selectedPCs.has(pc)) selectedPCs.delete(pc);
        else selectedPCs.add(pc);
        renderPCGrid();
        rebuildSlots();
      });
      grid.appendChild(div);
    }
  }

  function workingWindowMinutes(){
    const ws = minutesFromHHMM(WORK_START);
    const we = minutesFromHHMM(WORK_END);
    if(!WORKING_HOURS_ENABLED) return [{a:0,b:1440}];
    if(we > ws) return [{a:ws,b:we}];
    return [{a:ws,b:1440},{a:0,b:we}];
  }

  function overlaps(a1,a2,b1,b2){
    return Math.max(a1,b1) < Math.min(a2,b2);
  }

  function slotBusyForSelectedPCs(startMin, endMin){
    for(const b of cachedDayBookings){
      if(!selectedPCs.has(b.pc)) continue;
      if(overlaps(startMin, endMin, b.startMin, b.endMin)) return true;
    }
    return false;
  }

  async function loadBookingsForDate(dateISO){
    const snap = await db.collection("bookings").where("date", "==", dateISO).get();
    return snap.docs.map(d => ({ id:d.id, ...d.data() }));
  }

  function rebuildSlots(){
    const chips = $("slotChips");
    chips.innerHTML = "";
    selectedSlot = null;

    const dateISO = $("date").value;
    const dur = Number($("duration").value || 60);

    if(!dateISO || selectedPCs.size === 0){
      chips.innerHTML = `<div class="mut">â€”</div>`;
      return;
    }

    const segs = workingWindowMinutes();
    const slots = [];

    for(const seg of segs){
      for(let s = seg.a; s + dur <= seg.b; s += SLOT_STEP_MIN){
        const e = s + dur;
        let label = `${hhmmFromMinutes(s)} â†’ ${hhmmFromMinutes(e)}`;
        if(isCrossMidnight()){
          const ws = minutesFromHHMM(WORK_START);
          if(s < ws) label += "  ğŸŒ™(+1)";
        }
        slots.push({startMin:s, endMin:e, label});
      }
    }

    for(const sl of slots){
      const busy = slotBusyForSelectedPCs(sl.startMin, sl.endMin);
      const div = document.createElement("div");
      div.className = "chip" + (busy ? " busy" : "");
      div.textContent = busy ? `â›” ${sl.label}` : `âœ… ${sl.label}`;
      div.addEventListener("click", ()=>{
        if(busy) return;
        selectedSlot = sl;
        [...chips.children].forEach(x=>x.classList.remove("active"));
        div.classList.add("active");
      });
      chips.appendChild(div);
    }
  }

  async function refreshDayAndSlots(){
    const dateISO = $("date").value;
    if(!dateISO) return;
    try{
      cachedDayBookings = await loadBookingsForDate(dateISO);
    }catch(e){
      console.error(e);
      setMsg("ĞĞµ Ğ¼Ğ¾Ğ³Ñƒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ±Ñ€Ğ¾Ğ½Ğ¸ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ Firestore rules.", "bad");
      cachedDayBookings = [];
    }
    rebuildSlots();
  }

  // =========================
  // AUTH + PROFILE
  // =========================
  async function upsertProfileNick(uid, nick){
    const safeNick = (nick || "").trim().slice(0, 32);
    if(!safeNick) return;
    await db.collection("users").doc(uid).set({
      nick: safeNick,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });
  }

  async function loadProfileNick(uid){
    const doc = await db.collection("users").doc(uid).get();
    return doc.exists ? (doc.data().nick || "") : "";
  }

  function updateAuthUI(){
    $("logoutBtn").classList.toggle("hide", !currentUser);
    $("openAuthBtn").classList.toggle("hide", !!currentUser);
    $("userPill").textContent = currentUser ? (currentUser.email || currentUser.uid.slice(0,6)) : "â€”";
  }

  // =========================
  // LOCK HELPERS
  // =========================
  function lockId(dateISO, pc, minute){
    // minute ĞºÑ€Ğ°Ñ‚Ğ½Ğ¾ 30
    return `${dateISO}__${pc}__${minute}`;
  }
  function lockMinutesBetween(startMin, endMin){
    const mins = [];
    for(let m = startMin; m < endMin; m += SLOT_STEP_MIN) mins.push(m);
    return mins;
  }

  // =========================
  // CREATE BOOKING (transaction with doc refs only)
  // =========================
  async function createBooking(){
    if(!currentUser){ setMsg("Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ğ¾Ğ¹Ğ´Ğ¸.", "bad"); return; }

    const nick = ($("nick").value||"").trim();
    const dateISO = $("date").value;
    const note = ($("note").value||"").trim();

    if(!nick){ setMsg("Ğ’Ğ²ĞµĞ´Ğ¸ Ğ½Ğ¸Ğº.", "bad"); return; }
    if(!dateISO){ setMsg("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ´Ğ°Ñ‚Ñƒ.", "bad"); return; }
    if(selectedPCs.size===0){ setMsg("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ ĞŸĞš.", "bad"); return; }
    if(!selectedSlot){ setMsg("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ñ‹Ğ¹ ÑĞ»Ğ¾Ñ‚.", "bad"); return; }

    // Ğ·Ğ°Ğ¿Ñ€ĞµÑ‚ "Ğ² Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğ¼" Ñ ÑƒÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ Ğ¿ĞµÑ€ĞµÑĞµÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑƒĞ½Ğ¾Ñ‡Ğ¸
    const now = new Date();
    const day0 = parseISODate(dateISO);
    let startAbs = new Date(day0.getFullYear(), day0.getMonth(), day0.getDate(),
      Math.floor(selectedSlot.startMin/60), selectedSlot.startMin%60, 0, 0);
    if (isCrossMidnight()){
      const ws = minutesFromHHMM(WORK_START);
      if (selectedSlot.startMin < ws){
        startAbs = new Date(startAbs.getTime() + 24*60*60*1000);
      }
    }
    if(startAbs.getTime() < now.getTime()){
      setMsg("ĞĞµĞ»ÑŒĞ·Ñ Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğ¼.", "bad");
      return;
    }

    try{ await upsertProfileNick(currentUser.uid, nick); }catch(e){}

    const pcs = Array.from(selectedPCs);
    const startMin = selectedSlot.startMin;
    const endMin = selectedSlot.endMin;

    setMsg("Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ Ğ±Ñ€Ğ¾Ğ½ÑŒâ€¦", "info");

    try{
      await db.runTransaction(async (tx) => {
        // 1) Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼/ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ locks
        // 2) ĞµÑĞ»Ğ¸ Ğ²ÑÑ‘ Ğ¾Ğº â€” ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ booking docs (Ğ¿Ğ¾ 1 Ğ½Ğ° PC)

        for(const pc of pcs){
          const mins = lockMinutesBetween(startMin, endMin);
          const lockIds = mins.map(m => lockId(dateISO, pc, m));

          // check locks exist
          for(const id of lockIds){
            const ref = db.collection(LOCKS_COLLECTION).doc(id);
            const snap = await tx.get(ref);
            if(snap.exists){
              throw new Error("OVERLAP_LOCK");
            }
          }

          // create locks
          for(const id of lockIds){
            const ref = db.collection(LOCKS_COLLECTION).doc(id);
            tx.set(ref, {
              uid: currentUser.uid,
              pc,
              date: dateISO,
              minute: Number(id.split("__").pop()),
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }

          // create booking doc
          const bRef = db.collection("bookings").doc();
          tx.set(bRef, {
            uid: currentUser.uid,
            userEmail: currentUser.email || "",
            nick,
            pc,
            date: dateISO,
            startMin,
            endMin,
            note,
            lockIds,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      });

      setMsg(`âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾! Ğ—Ğ°Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾: ${pcs.join(", ")} â€” ${selectedSlot.label}`, "good");
      await refreshDayAndSlots();

    }catch(e){
      console.error(e);
      if(String(e.message||"") === "OVERLAP_LOCK"){
        setMsg("â›” Ğ­Ñ‚Ğ¾Ñ‚ ÑĞ»Ğ¾Ñ‚ ÑƒĞ¶Ğµ Ğ·Ğ°Ğ½ÑĞ»Ğ¸. Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹.", "bad");
      }else{
        setMsg("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ. ĞÑ‚ĞºÑ€Ğ¾Ğ¹ Console (F12) Ğ¸ Ğ¿Ñ€Ğ¸ÑˆĞ»Ğ¸ 1 ĞºÑ€Ğ°ÑĞ½ÑƒÑ ÑÑ‚Ñ€Ğ¾ĞºÑƒ.", "bad");
      }
    }
  }

  // =========================
  // MY BOOKINGS
  // =========================
  async function loadMyBookings(){
    if(!currentUser) return [];
    const snap = await db.collection("bookings").where("uid","==", currentUser.uid).get();
    const list = snap.docs.map(d => ({ id:d.id, ...d.data() }));
    list.sort((a,b)=> (a.date+a.startMin+a.pc).localeCompare(b.date+b.startMin+b.pc));
    return list;
  }

  async function deleteBookingAndLocks(b){
    // b Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ id + lockIds
    const batch = db.batch();

    if(Array.isArray(b.lockIds)){
      for(const lid of b.lockIds){
        batch.delete(db.collection(LOCKS_COLLECTION).doc(lid));
      }
    }
    batch.delete(db.collection("bookings").doc(b.id));

    await batch.commit();
  }

  async function renderMyBookings(){
    const tbody = $("myTable");
    tbody.innerHTML = "";
    if(!currentUser){
      tbody.innerHTML = `<tr><td colspan="5" style="color:var(--muted)">Login first</td></tr>`;
      return;
    }
    const list = await loadMyBookings();
    if(!list.length){
      tbody.innerHTML = `<tr><td colspan="5" style="color:var(--muted)">â€”</td></tr>`;
      return;
    }

    for(const b of list){
      const timeStr = `${hhmmFromMinutes(b.startMin)} â†’ ${hhmmFromMinutes(b.endMin)}`;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(b.date)}</td>
        <td>${escapeHtml(timeStr)}</td>
        <td><b>${escapeHtml(b.pc)}</b></td>
        <td style="color:var(--muted)">${escapeHtml(b.note||"")}</td>
        <td><button class="mini danger" type="button" data-id="${b.id}">Cancel</button></td>
      `;
      tbody.appendChild(tr);

      tr.querySelector("button").addEventListener("click", async ()=>{
        if(!confirm("Cancel booking?")) return;
        try{
          await deleteBookingAndLocks(b);
          await refreshDayAndSlots();
          await renderMyBookings();
          setMsg("ĞÑ‚Ğ¼ĞµĞ½ĞµĞ½Ğ¾.", "good");
        }catch(e){
          console.error(e);
          setMsg("ĞĞµ Ğ¼Ğ¾Ğ³Ñƒ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ Firestore rules.", "bad");
        }
      });
    }
  }

  // =========================
  // TODAY
  // =========================
  async function renderToday(){
    const tbody = $("todayTable");
    tbody.innerHTML = "";
    const todayISO = toISODate(new Date());
    try{
      const snap = await db.collection("bookings").where("date","==",todayISO).get();
      const list = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      list.sort((a,b)=> (a.startMin+a.pc).toString().localeCompare((b.startMin+b.pc).toString()));

      if(!list.length){
        tbody.innerHTML = `<tr><td colspan="4" style="color:var(--muted)">â€”</td></tr>`;
        return;
      }

      for(const b of list){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(hhmmFromMinutes(b.startMin))} â†’ ${escapeHtml(hhmmFromMinutes(b.endMin))}</td>
          <td><b>${escapeHtml(b.pc)}</b></td>
          <td>${escapeHtml(b.nick||"")}</td>
          <td style="color:var(--muted)">${escapeHtml(b.note||"")}</td>
        `;
        tbody.appendChild(tr);
      }
    }catch(e){
      console.error(e);
      tbody.innerHTML = `<tr><td colspan="4" style="color:var(--muted)">Firestore error</td></tr>`;
    }
  }

  // =========================
  // EVENTS
  // =========================
  function bindEvents(){
    $("lang_ru").onclick = ()=>{ lang="ru"; localStorage.setItem(LANG_KEY,lang); applyLang(); };
    $("lang_en").onclick = ()=>{ lang="en"; localStorage.setItem(LANG_KEY,lang); applyLang(); };
    $("lang_ka").onclick = ()=>{ lang="ka"; localStorage.setItem(LANG_KEY,lang); applyLang(); };

    $("openAuthBtn").onclick = openModal;
    $("authCloseBtn").onclick = closeModal;
    $("authBackdrop").onclick = (e)=>{ if(e.target === $("authBackdrop")) closeModal(); };

    $("doLoginBtn").onclick = async ()=>{
      const email = ($("authEmail").value||"").trim();
      const pass = ($("authPass").value||"").trim();
      if(!email || !pass){ $("authModalMsg").textContent = "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ email+password"; return; }
      try{
        await auth.signInWithEmailAndPassword(email, pass);
        $("authModalMsg").textContent = "OK";
        closeModal();
      }catch(e){
        console.error(e);
        $("authModalMsg").textContent = e.message || "Login error";
      }
    };

    $("doRegisterBtn").onclick = async ()=>{
      const email = ($("authEmail").value||"").trim();
      const pass = ($("authPass").value||"").trim();
      if(!email || !pass){ $("authModalMsg").textContent = "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ email+password"; return; }
      try{
        await auth.createUserWithEmailAndPassword(email, pass);
        $("authModalMsg").textContent = "Created!";
        closeModal();
      }catch(e){
        console.error(e);
        $("authModalMsg").textContent = e.message || "Register error";
      }
    };

    $("logoutBtn").onclick = async ()=>{ try{ await auth.signOut(); }catch(e){} };

    $("date").addEventListener("change", async ()=>{ await refreshDayAndSlots(); });
    $("duration").addEventListener("change", ()=>{ rebuildSlots(); });
    $("createBtn").onclick = createBooking;

    $("myBtn").onclick = async ()=>{
      show($("myBox"));
      hide($("todayBox"));
      await renderMyBookings();
      $("myBox").scrollIntoView({behavior:"smooth", block:"start"});
    };
    $("closeMyBtn").onclick = ()=> hide($("myBox"));

    $("todayBtn").onclick = async ()=>{
      hide($("myBox"));
      show($("todayBox"));
      await renderToday();
      $("todayBox").scrollIntoView({behavior:"smooth", block:"start"});
    };
    $("closeTodayBtn").onclick = ()=> hide($("todayBox"));

    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        hide($("myBox")); hide($("todayBox"));
        closeModal();
      }
    });
  }

  // =========================
  // BOOT
  // =========================
  async function boot(){
    $("date").value = toISODate(new Date());

    if(!i18n[lang]) lang="ru";
    applyLang();

    renderPCGrid();

    const savedNick = localStorage.getItem("sg_nick") || "";
    if(savedNick) $("nick").value = savedNick;
    $("nick").addEventListener("input", ()=> localStorage.setItem("sg_nick", ($("nick").value||"").trim()));

    bindEvents();

    auth.onAuthStateChanged(async (u)=>{
      currentUser = u || null;
      updateAuthUI();

      if(currentUser){
        $("authMsg").textContent = `âœ… Logged in: ${currentUser.email || currentUser.uid.slice(0,6)}`;
        setMsg("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ ĞŸĞš Ğ¸ ÑĞ»Ğ¾Ñ‚.", "info");

        if(!($("nick").value||"").trim()){
          try{
            const pn = await loadProfileNick(currentUser.uid);
            if(pn) $("nick").value = pn;
          }catch(e){}
        }
      }else{
        $("authMsg").textContent = "â€”";
        setMsg("Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ğ¾Ğ¹Ğ´Ğ¸, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ.", "info");
      }

      await refreshDayAndSlots();
    });
  }

  boot();
})();
</script>
</body>
</html>
