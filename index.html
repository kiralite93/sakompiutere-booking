<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sakompiutere Gaming ‚Äî Booking</title>
  <meta name="theme-color" content="#0b1020" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    :root{
      --bg:#070a12;
      --card:#0b1020;
      --muted:#9aa4bf;
      --text:#eaf0ff;
      --line:rgba(255,255,255,.08);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
      --shadow:0 20px 60px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(110,231,255,.12), transparent 60%),
        radial-gradient(900px 700px at 80% 10%, rgba(167,139,250,.14), transparent 60%),
        radial-gradient(800px 700px at 40% 120%, rgba(52,211,153,.10), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1180px; margin:0 auto; padding:18px;}
    header{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 16px; border:1px solid var(--line); border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      position:sticky; top:14px; z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: radial-gradient(circle at 30% 20%, rgba(110,231,255,.9), rgba(167,139,250,.8) 40%, rgba(0,0,0,0) 72%),
                  linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.02));
      border:1px solid var(--line);
      box-shadow: 0 12px 30px rgba(0,0,0,.4);
    }
    .brand h1{margin:0; font-size:16px; letter-spacing:.4px}
    .brand .sub{margin:0; color:var(--muted); font-size:12px}
    .rightbar{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center;}
    .pill{
      padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--muted); font-size:12px;
    }
    .pill strong{color:var(--text); font-weight:900}
    .lang{
      display:flex; gap:6px;
      padding:6px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
    }
    .lang button{
      padding:7px 10px; border-radius:999px;
      border:1px solid transparent;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      font-weight:900;
      font-size:12px;
    }
    .lang button.active{
      border-color: rgba(110,231,255,.55);
      background: rgba(110,231,255,.10);
      color: var(--text);
    }
    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:18px;
      margin-top:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
      header{position:static;}
    }
    .card{
      border:1px solid var(--line);
      border-radius:var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
    }
    .hd h2{margin:0; font-size:14px}
    .hint{color:var(--muted); font-size:12px; line-height:1.35}
    .bd{padding:14px 16px}

    .stepper{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .step{
      display:flex; gap:10px; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      color:var(--muted);
      font-size:12px;
      user-select:none;
    }
    .step .n{
      width:22px; height:22px; border-radius:999px;
      display:grid; place-items:center;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:1000;
    }
    .step.active{
      border-color: rgba(110,231,255,.55);
      background: rgba(110,231,255,.08);
      color: var(--text);
    }
    .step.active .n{border-color: rgba(110,231,255,.55); color: var(--text)}

    .notice{
      border:1px dashed rgba(110,231,255,.35);
      background: rgba(110,231,255,.06);
      padding:12px 12px;
      border-radius:16px;
      font-size:12px;
      line-height:1.35;
    }

    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:1000;
      letter-spacing:.2px;
    }
    button:hover{border-color: rgba(110,231,255,.5)}
    .primary{
      border-color: rgba(110,231,255,.55);
      background: linear-gradient(180deg, rgba(110,231,255,.18), rgba(167,139,250,.10));
    }
    .ghost{background:transparent}
    .danger{border-color: rgba(251,113,133,.6); background: rgba(251,113,133,.10)}
    .mini{padding:6px 10px; border-radius:12px; font-size:12px; font-weight:1000}

    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    input:focus{border-color: rgba(110,231,255,.6); box-shadow:0 0 0 3px rgba(110,231,255,.12)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;}
    @media (max-width:520px){ .row{grid-template-columns:1fr;} }

    .pcgrid{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 980px){ .pcgrid{grid-template-columns: repeat(2, 1fr);} }

    .pc{
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(0,0,0,.22);
      cursor:pointer;
      transition: transform .08s ease, border-color .12s ease, box-shadow .12s ease;
      user-select:none;
      position:relative;
      min-height:70px;
    }
    .pc:hover{transform: translateY(-1px); border-color: rgba(110,231,255,.4)}
    .pc .name{font-weight:1100; letter-spacing:.3px}
    .pc .meta{margin-top:6px; color:var(--muted); font-size:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .tag{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background:rgba(0,0,0,.25);
      font-size:12px; color:var(--muted);
    }
    .dot{width:8px; height:8px; border-radius:999px; background: var(--muted)}
    .dot.good{background:var(--good)}
    .dot.bad{background:var(--bad)}
    .dot.warn{background:var(--warn)}

    .pc.selected{
      border-color: rgba(110,231,255,.75);
      box-shadow: 0 0 0 3px rgba(110,231,255,.10);
    }
    .check{
      position:absolute; top:10px; right:10px;
      width:22px; height:22px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.35);
      display:grid; place-items:center;
      color: transparent;
      font-weight:1100;
      font-size:12px;
    }
    .pc.selected .check{
      border-color: rgba(110,231,255,.75);
      background: rgba(110,231,255,.14);
      color: var(--text);
    }

    .chipbar{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .chip{
      padding:9px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      cursor:pointer;
      font-weight:1100;
      font-size:12px;
      user-select:none;
    }
    .chip.active{
      border-color: rgba(110,231,255,.6);
      background: rgba(110,231,255,.10);
    }
    .chip.disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    .slotGrid{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:8px;
      margin-top:10px;
    }
    @media (max-width:980px){ .slotGrid{grid-template-columns: repeat(4, 1fr);} }
    @media (max-width:520px){ .slotGrid{grid-template-columns: repeat(3, 1fr);} }

    .slot{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      cursor:pointer;
      font-weight:1100;
      font-size:12px;
      text-align:center;
      user-select:none;
    }
    .slot:hover{border-color: rgba(110,231,255,.5)}
    .slot.active{
      border-color: rgba(52,211,153,.55);
      background: rgba(52,211,153,.10);
    }

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:16px;
      margin-top:10px;
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
      font-size:12px;
    }
    .table th{color:var(--muted); font-weight:1100; text-align:left; background:rgba(255,255,255,.03)}
    .table tr:last-child td{border-bottom:none}

    .hide{display:none !important;}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      padding:2px 6px;
      border:1px solid var(--line);
      border-radius:8px;
      background:rgba(0,0,0,.25);
      color:var(--muted);
      font-size:12px;
    }

    @media print{
      header, #rightSide, #openAdminBtn, #exitAdminBtn, #introBox, #step1Box, #step2Box, #step3Box, #myBox { display:none !important; }
      body{ background:#fff !important; color:#000 !important; }
      .card{ box-shadow:none !important; background:#fff !important; border:1px solid #ddd !important; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1 id="t_title">Sakompiutere Gaming ‚Äî Booking</h1>
        <p class="sub" id="t_sub">–í—ã–±–µ—Ä–∏ –ü–ö ‚Üí –≤—ã–±–µ—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Üí –≤—ã–±–µ—Ä–∏ —Å—Ç–∞—Ä—Ç</p>
      </div>
    </div>

    <div class="rightbar">
      <div class="lang" aria-label="Language selector">
        <button id="lang_ru">RU</button>
        <button id="lang_en">EN</button>
        <button id="lang_ka">KA</button>
      </div>
      <div class="pill"><span id="t_today">–°–µ–≥–æ–¥–Ω—è</span>: <strong id="todayPill">‚Äî</strong></div>
      <div class="pill"><span id="t_bookings">–ë—Ä–æ–Ω–µ–π</span>: <strong id="countPill">0</strong></div>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="hd">
        <div class="stepper">
          <div class="step" id="step1"><span class="n">1</span><span id="t_step1">–ü–ö</span></div>
          <div class="step" id="step2"><span class="n">2</span><span id="t_step2">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å + —Å—Ç–∞—Ä—Ç</span></div>
          <div class="step" id="step3"><span class="n">3</span><span id="t_step3">–ì–æ—Ç–æ–≤–æ</span></div>
        </div>
        <div class="hint" id="t_hint">–ë–µ–∑ –≤–≤–æ–¥–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤—Ä—É—á–Ω—É—é</div>
      </div>

      <div class="bd">
        <div class="notice" id="introBox">
          <b id="t_fast">‚ö° –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å—Ç–∏–ª—å</b><br/>
          <span id="t_intro1">–¢—ã –≤—ã–±–∏—Ä–∞–µ—à—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî</span><br/>
          <span id="t_intro2">–∞ —Å–∞–π—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ç–∞—Ä—Ç—ã.</span><br/>
          <span id="t_intro3">–ù–∏–∫–∞–∫–∏—Ö Start/End.</span>
          <div class="btns">
            <button class="primary" id="startBtn">‚ñ∂ <span id="t_start">–ù–∞—á–∞—Ç—å</span></button>
            <button class="ghost" id="viewMyBtn">üë§ <span id="t_my">–ú–æ–∏ –±—Ä–æ–Ω–∏</span></button>
          </div>
        </div>

        <!-- STEP 1 -->
        <div id="step1Box" class="hide">
          <div class="row">
            <div>
              <label id="t_nickLabel">–¢–≤–æ–π –Ω–∏–∫</label>
              <input id="nick" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: KiraLite" />
            </div>
            <div>
              <label id="t_dateLabel">–î–∞—Ç–∞</label>
              <input id="date" type="date" />
            </div>
          </div>

          <div class="hint" id="t_pickpc">–í—ã–±–µ—Ä–∏ 1 –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ü–ö:</div>
          <div id="pcGrid" class="pcgrid"></div>

          <div class="btns">
            <button class="primary" id="toStep2Btn">‚û° <span id="t_next">–î–∞–ª–µ–µ</span></button>
            <button class="ghost" id="clearPcBtn">‚úñ <span id="t_clear">–û—á–∏—Å—Ç–∏—Ç—å</span></button>
          </div>
        </div>

        <!-- STEP 2 -->
        <div id="step2Box" class="hide">
          <div class="notice">
            <b id="t_step2Title">–í—ã–±–µ—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</b><br/>
            <span class="hint" id="t_step2Desc">–ü–æ—Ç–æ–º –≤—ã–±–µ—Ä–∏ —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞ (–∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ).</span>
          </div>

          <div class="chipbar" id="durChips"></div>

          <div class="notice" style="margin-top:10px;">
            <b id="t_pickStart">–í—ã–±–µ—Ä–∏ —Å—Ç–∞—Ä—Ç</b><br/>
            <span class="hint" id="t_pickStartHint">–ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ç–∞—Ä—Ç—ã (—à–∞–≥ 15 –º–∏–Ω—É—Ç).</span>
          </div>

          <div class="slotGrid" id="slotGrid"></div>

          <div class="row" style="margin-top:10px;">
            <div>
              <label id="t_noteLabel">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
              <input id="note" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: CS2 / –¢—É—Ä–Ω–∏—Ä" />
            </div>
            <div>
              <label id="t_priceLabel">–¶–µ–Ω–∞ (GEL/—á–∞—Å)</label>
              <input id="price" type="number" min="0" step="0.5" value="5" />
            </div>
          </div>

          <div class="notice" id="rangePreview">‚Äî</div>

          <div class="btns">
            <button class="ghost" id="backTo1Btn">‚¨Ö <span id="t_back">–ù–∞–∑–∞–¥</span></button>
            <button class="primary" id="toStep3Btn">‚û° <span id="t_next2">–î–∞–ª–µ–µ</span></button>
          </div>
        </div>

        <!-- STEP 3 -->
        <div id="step3Box" class="hide">
          <div class="notice" id="summaryBox"></div>

          <div class="btns">
            <button class="ghost" id="backTo2Btn">‚¨Ö <span id="t_back2">–ù–∞–∑–∞–¥</span></button>
            <button class="primary" id="createBtn">‚úÖ <span id="t_bookNow">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</span></button>
          </div>

          <div class="notice" id="msg" style="margin-top:10px;" aria-live="polite">OK</div>

          <div class="notice" style="margin-top:10px;">
            <b id="t_qrTitle">QR –±—Ä–æ–Ω–∏</b><br/>
            <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:10px;">
              <canvas id="qrCanvas" width="160" height="160" style="background:#fff;border-radius:12px;border:1px solid rgba(255,255,255,.08)"></canvas>
              <div class="hint" id="qrHint">QR –æ–±–Ω–æ–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏.</div>
            </div>
          </div>

          <div class="btns" style="margin-top:10px;">
            <button class="ghost" id="showMyInlineBtn">üë§ <span id="t_my2">–ú–æ–∏ –±—Ä–æ–Ω–∏</span></button>
            <button class="ghost" id="copyShareBtn">üîó <span id="t_copyShare">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –±—Ä–æ–Ω—å</span></button>
          </div>
        </div>

        <!-- MY BOOKINGS -->
        <div id="myBox" class="hide" style="margin-top:12px;">
          <div class="hd" style="border:1px solid var(--line); border-radius:16px; margin-top:10px;">
            <h2 style="margin:0;font-size:14px;" id="t_myTitle">–ú–æ–∏ –±—Ä–æ–Ω–∏</h2>
            <div class="hint" id="t_myHint">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ –Ω–∏–∫—É</div>
          </div>
          <div class="bd" style="border:1px solid var(--line); border-radius:16px; border-top:none;">
            <div class="row">
              <div>
                <label id="t_myNick">–ù–∏–∫</label>
                <input id="myNickInput" type="text" placeholder="–≤–≤–µ–¥–∏ –Ω–∏–∫" />
              </div>
              <div style="display:flex; align-items:end; gap:10px; flex-wrap:wrap;">
                <button class="primary" id="mySearchBtn">üîé <span id="t_show">–ü–æ–∫–∞–∑–∞—Ç—å</span></button>
                <button class="ghost" id="myCloseBtn">‚úñ <span id="t_close">–ó–∞–∫—Ä—ã—Ç—å</span></button>
              </div>
            </div>

            <table class="table">
              <thead>
                <tr>
                  <th style="width:160px" id="t_colDate">–î–∞—Ç–∞</th>
                  <th style="width:160px" id="t_colTime">–í—Ä–µ–º—è</th>
                  <th style="width:120px" id="t_colPc">–ü–ö</th>
                  <th id="t_colNote">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                  <th style="width:110px" id="t_colCost">–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                  <th style="width:140px" id="t_colCancel">–û—Ç–º–µ–Ω–∞</th>
                </tr>
              </thead>
              <tbody id="myTable"></tbody>
            </table>
          </div>
        </div>

        <div class="hint" style="margin-top:12px;">
          <span class="kbd">Esc</span> ‚Äî –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å—Ç–∞—Ä—Ç
        </div>

      </div>
    </div>

    <!-- RIGHT -->
    <div class="card" id="rightSide">
      <div class="hd">
        <h2 id="t_sideTitle">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</h2>
        <div class="hint" id="t_sideHint">–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–Ω—è—Ç–Ω–æ</div>
      </div>
      <div class="bd">
        <div class="notice" id="helpBox"></div>

        <div style="height:12px"></div>
        <div class="notice" id="rulesBox"></div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // =========================
  // CONFIG
  // =========================
  const PCs = ["Bishop","Godzilla","Elf","Kadita","Orc","Lancelot","Fantomas","Soultaker","Pudge","Kratos"];

  const STORAGE_KEY = "sg_bookings_v4_slots";
  const LANG_KEY = "sg_lang";
  const NICK_KEY = "sg_nick";

  const MIN_BOOK_MINUTES = 30;
  const MAX_BOOK_HOURS = 8;
  const MAX_DAYS_AHEAD = 14;

  // —à–∞–≥ –∫–Ω–æ–ø–æ–∫ —Å—Ç–∞—Ä—Ç–æ–≤ (15 –º–∏–Ω—É—Ç ‚Äî –∏–¥–µ–∞–ª—å–Ω–æ)
  const START_STEP_MIN = 15;

  // –†–∞–±–æ—á–∏–µ —á–∞—Å—ã (–µ—Å–ª–∏ 24/7 ‚Üí –≤—ã–∫–ª—é—á–∏)
  const WORKING_HOURS_ENABLED = true;
  const WORK_START = "10:00";
  const WORK_END = "03:00"; // –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å

  // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–±—ã—Å—Ç—Ä–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ)
  const DURATIONS = [30, 60, 90, 120, 180, 240]; // minutes

  // =========================
  // i18n (–∫–æ—Ä–æ—Ç–∫–æ, –±–µ–∑ –ø–µ—Ä–µ–≥—Ä—É–∑–∞)
  // =========================
  const i18n = {
    ru: {
      title:"Sakompiutere Gaming ‚Äî Booking",
      sub:"–í—ã–±–µ—Ä–∏ –ü–ö ‚Üí –≤—ã–±–µ—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Üí –≤—ã–±–µ—Ä–∏ —Å—Ç–∞—Ä—Ç",
      today:"–°–µ–≥–æ–¥–Ω—è", bookings:"–ë—Ä–æ–Ω–µ–π",
      s1:"–ü–ö", s2:"–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å + —Å—Ç–∞—Ä—Ç", s3:"–ì–æ—Ç–æ–≤–æ",
      hint:"–ë–µ–∑ –≤–≤–æ–¥–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤—Ä—É—á–Ω—É—é",
      fast:"‚ö° –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å—Ç–∏–ª—å",
      intro1:"–¢—ã –≤—ã–±–∏—Ä–∞–µ—à—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî",
      intro2:"–∞ —Å–∞–π—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ç–∞—Ä—Ç—ã.",
      intro3:"–ù–∏–∫–∞–∫–∏—Ö Start/End.",
      start:"–ù–∞—á–∞—Ç—å",
      my:"–ú–æ–∏ –±—Ä–æ–Ω–∏",
      nick:"–¢–≤–æ–π –Ω–∏–∫",
      date:"–î–∞—Ç–∞",
      pickpc:"–í—ã–±–µ—Ä–∏ 1 –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ü–ö:",
      next:"–î–∞–ª–µ–µ",
      clear:"–û—á–∏—Å—Ç–∏—Ç—å",
      back:"–ù–∞–∑–∞–¥",
      step2Title:"–í—ã–±–µ—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
      step2Desc:"–ü–æ—Ç–æ–º –≤—ã–±–µ—Ä–∏ —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞ (–∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ).",
      pickStart:"–í—ã–±–µ—Ä–∏ —Å—Ç–∞—Ä—Ç",
      pickStartHint:"–ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ç–∞—Ä—Ç—ã (—à–∞–≥ 15 –º–∏–Ω—É—Ç).",
      note:"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)",
      price:"–¶–µ–Ω–∞ (GEL/—á–∞—Å)",
      next2:"–î–∞–ª–µ–µ",
      back2:"–ù–∞–∑–∞–¥",
      bookNow:"–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å",
      my2:"–ú–æ–∏ –±—Ä–æ–Ω–∏",
      copyShare:"–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –±—Ä–æ–Ω—å",
      qrTitle:"QR –±—Ä–æ–Ω–∏",
      qrHint:"QR –æ–±–Ω–æ–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏.",
      myTitle:"–ú–æ–∏ –±—Ä–æ–Ω–∏",
      myHint:"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ –Ω–∏–∫—É",
      myNick:"–ù–∏–∫",
      show:"–ü–æ–∫–∞–∑–∞—Ç—å",
      close:"–ó–∞–∫—Ä—ã—Ç—å",
      colDate:"–î–∞—Ç–∞",
      colTime:"–í—Ä–µ–º—è",
      colPc:"–ü–ö",
      colNote:"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",
      colCost:"–°—Ç–æ–∏–º–æ—Å—Ç—å",
      colCancel:"–û—Ç–º–µ–Ω–∞",
      help:
`‚úÖ –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:
1) –í—ã–±–µ—Ä–∏ –ü–ö –∏ –¥–∞—Ç—É
2) –í—ã–±–µ—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
3) –í—ã–±–µ—Ä–∏ —Å–≤–æ–±–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç (–∫–Ω–æ–ø–∫–∏)
–ì–æ—Ç–æ–≤–æ.

–≠—Ç–æ –Ω–∞–º–Ω–æ–≥–æ –ø—Ä–æ—â–µ, —á–µ–º Start/End.`,
      rulesTitle:"–ü—Ä–∞–≤–∏–ª–∞",
      rule1:"–ù–µ–ª—å–∑—è –ø–µ—Ä–µ—Å–µ–∫–∞—Ç—å –±—Ä–æ–Ω–∏ –Ω–∞ –æ–¥–Ω–æ–º –ü–ö",
      rule2:`–ú–∏–Ω ${MIN_BOOK_MINUTES} –º–∏–Ω—É—Ç, –º–∞–∫—Å ${MAX_BOOK_HOURS} —á–∞—Å–æ–≤`,
      rule3:`–í–ø–µ—Ä—ë–¥: –º–∞–∫—Å–∏–º—É–º ${MAX_DAYS_AHEAD} –¥–Ω–µ–π`,
      rule4on:`–ß–∞—Å—ã –∫–ª—É–±–∞: ${WORK_START} ‚Üí ${WORK_END}`,
      rule4off:"–ß–∞—Å—ã –∫–ª—É–±–∞: 24/7",
      errNick:"–í–≤–µ–¥–∏ –Ω–∏–∫.",
      errPc:"–í—ã–±–µ—Ä–∏ —Ö–æ—Ç—è –±—ã 1 –ü–ö.",
      errDate:"–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É.",
      errDur:"–í—ã–±–µ—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.",
      errStart:"–í—ã–±–µ—Ä–∏ —Å—Ç–∞—Ä—Ç.",
      errPast:"–ù–µ–ª—å–∑—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º.",
      errTooFar:"–°–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ. –í—ã–±–µ—Ä–∏ –¥–∞—Ç—É –±–ª–∏–∂–µ.",
      errNoSlots:"–ü–æ–¥ —ç—Ç—É –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å—Ç–∞—Ä—Ç–æ–≤. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å/–¥–∞—Ç—É.",
      created:"–ì–æ—Ç–æ–≤–æ! –°–æ–∑–¥–∞–Ω–æ –±—Ä–æ–Ω–µ–π",
      copied:"–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ.",
      copyFail:"–ù–µ —Å–º–æ–≥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ‚Äî —Å–∫–æ–ø–∏—Ä—É–π –≤—Ä—É—á–Ω—É—é."
    },
    en: {
      title:"Sakompiutere Gaming ‚Äî Booking",
      sub:"Pick PCs ‚Üí duration ‚Üí pick start",
      today:"Today", bookings:"Bookings",
      s1:"PCs", s2:"Duration + start", s3:"Done",
      hint:"No manual time input",
      fast:"‚ö° Simplest style",
      intro1:"You pick duration ‚Äî",
      intro2:"the site shows only free start times.",
      intro3:"No Start/End fields.",
      start:"Start",
      my:"My bookings",
      nick:"Nickname",
      date:"Date",
      pickpc:"Pick 1 or more PCs:",
      next:"Next",
      clear:"Clear",
      back:"Back",
      step2Title:"Pick duration",
      step2Desc:"Then pick a free start time (buttons).",
      pickStart:"Pick start",
      pickStartHint:"Only free starts shown (15-min step).",
      note:"Note (optional)",
      price:"Price (GEL/hour)",
      next2:"Next",
      back2:"Back",
      bookNow:"Book",
      my2:"My bookings",
      copyShare:"Copy booking",
      qrTitle:"Booking QR",
      qrHint:"QR updates after booking.",
      myTitle:"My bookings",
      myHint:"By nickname",
      myNick:"Nickname",
      show:"Show",
      close:"Close",
      colDate:"Date",
      colTime:"Time",
      colPc:"PC",
      colNote:"Note",
      colCost:"Cost",
      colCancel:"Cancel",
      help:
`‚úÖ New time logic:
1) Pick PCs + date
2) Pick duration
3) Pick a free start time
Done.`,
      rulesTitle:"Rules",
      rule1:"No overlaps on same PC",
      rule2:`Min ${MIN_BOOK_MINUTES} min, max ${MAX_BOOK_HOURS} h`,
      rule3:`Ahead: max ${MAX_DAYS_AHEAD} days`,
      rule4on:`Club hours: ${WORK_START} ‚Üí ${WORK_END}`,
      rule4off:"Club hours: 24/7",
      errNick:"Enter nickname.",
      errPc:"Select at least 1 PC.",
      errDate:"Select date.",
      errDur:"Select duration.",
      errStart:"Select start time.",
      errPast:"No booking in the past.",
      errTooFar:"Too far ahead. Pick a closer date.",
      errNoSlots:"No free start times for this duration. Try another duration/date.",
      created:"Done! Bookings created",
      copied:"Copied.",
      copyFail:"Copy failed ‚Äî copy manually."
    },
    ka: {
      title:"Sakompiutere Gaming ‚Äî Booking",
      sub:"PC-·Éî·Éë·Éò ‚Üí ·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éù·Éë·Éê ‚Üí ·Éì·Éê·É¨·Éß·Éî·Éë·Éê",
      today:"·Éì·É¶·Éî·É°", bookings:"·ÉØ·Éê·Éï·É®·Éú·Éî·Éë·Éò",
      s1:"PC", s2:"·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éù·Éë·Éê + ·Éì·Éê·É¨·Éß·Éî·Éë·Éê", s3:"·Éõ·Éñ·Éê·Éì·Éê·Éê",
      hint:"·Éì·É†·Éù ·ÉÆ·Éî·Éö·Éò·Éó ·Éê·É† ·É®·Éî·Éí·Éß·Éê·Éï·É°",
      fast:"‚ö° ·Éß·Éï·Éî·Éö·Éê·Éñ·Éî ·Éõ·Éê·É†·É¢·Éò·Éï·Éò",
      intro1:"·É®·Éî·Éú ·Éò·É†·É©·Éî·Éï ·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éù·Éë·Éê·É° ‚Äî",
      intro2:"·É°·Éê·Éò·É¢·Éò ·Éí·Éê·É©·Éï·Éî·Éú·Éî·Éë·É° ·Éõ·ÉÆ·Éù·Éö·Éù·Éì ·Éó·Éê·Éï·Éò·É°·É£·É§·Éê·Éö ·Éì·Éê·É¨·Éß·Éî·Éë·Éî·Éë·É°.",
      intro3:"Start/End ·Éê·É† ·Éê·É†·Éò·É°.",
      start:"·Éì·Éê·É¨·Éß·Éî·Éë·Éê",
      my:"·É©·Éî·Éõ·Éò ·ÉØ·Éê·Éï·É®·Éú·Éî·Éë·Éò",
      nick:"·Éú·Éò·Éô·Éò",
      date:"·Éó·Éê·É†·Éò·É¶·Éò",
      pickpc:"·Éê·Éò·É†·É©·Éò·Éî 1 ·Éê·Éú ·Éõ·Éî·É¢·Éò PC:",
      next:"·É®·Éî·Éõ·Éì·Éî·Éí·Éò",
      clear:"·Éí·Éê·É°·É£·É§·Éó·Éê·Éï·Éî·Éë·Éê",
      back:"·É£·Éô·Éê·Éú",
      step2Title:"·Éê·Éò·É†·É©·Éò·Éî ·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éù·Éë·Éê",
      step2Desc:"·É®·Éî·Éõ·Éì·Éî·Éí ·Éê·Éò·É†·É©·Éò·Éî ·Éó·Éê·Éï·Éò·É°·É£·É§·Éê·Éö·Éò ·Éì·Éê·É¨·Éß·Éî·Éë·Éê (·É¶·Éò·Éö·Éê·Éô·Éî·Éë·Éò).",
      pickStart:"·Éê·Éò·É†·É©·Éò·Éî ·Éì·Éê·É¨·Éß·Éî·Éë·Éê",
      pickStartHint:"·Éõ·ÉÆ·Éù·Éö·Éù·Éì ·Éó·Éê·Éï·Éò·É°·É£·É§·Éê·Éö·Éò ·Éì·Éê·É¨·Éß·Éî·Éë·Éî·Éë·Éò (15 ·É¨·Éó ·Éú·Éê·Éë·Éò·ÉØ·Éò).",
      note:"·É®·Éî·Éú·Éò·É®·Éï·Éú·Éê (optional)",
      price:"·É§·Éê·É°·Éò (GEL/·É°·Éê·Éê·Éó·Éò)",
      next2:"·É®·Éî·Éõ·Éì·Éî·Éí·Éò",
      back2:"·É£·Éô·Éê·Éú",
      bookNow:"·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éê",
      my2:"·É©·Éî·Éõ·Éò ·ÉØ·Éê·Éï·É®·Éú·Éî·Éë·Éò",
      copyShare:"·Éô·Éù·Éû·Éò·É†·Éî·Éë·Éê",
      qrTitle:"QR",
      qrHint:"QR ·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éì·Éî·Éë·Éê ·ÉØ·Éê·Éï·É®·Éú·Éò·É° ·É®·Éî·Éõ·Éì·Éî·Éí.",
      myTitle:"·É©·Éî·Éõ·Éò ·ÉØ·Éê·Éï·É®·Éú·Éî·Éë·Éò",
      myHint:"·Éú·Éò·Éô·Éò·Éó",
      myNick:"·Éú·Éò·Éô·Éò",
      show:"·É©·Éï·Éî·Éú·Éî·Éë·Éê",
      close:"·Éì·Éê·ÉÆ·É£·É†·Éï·Éê",
      colDate:"·Éó·Éê·É†·Éò·É¶·Éò",
      colTime:"·Éì·É†·Éù",
      colPc:"PC",
      colNote:"·É®·Éî·Éú·Éò·É®·Éï·Éú·Éê",
      colCost:"·É§·Éê·É°·Éò",
      colCancel:"·Éí·Éê·É£·É•·Éõ·Éî·Éë·Éê",
      help:
`‚úÖ ·Éê·ÉÆ·Éê·Éö·Éò ·Éö·Éù·Éí·Éò·Éô·Éê:
1) ·Éê·Éò·É†·É©·Éò·Éî PC ·Éì·Éê ·Éó·Éê·É†·Éò·É¶·Éò
2) ·Éê·Éò·É†·É©·Éò·Éî ·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éù·Éë·Éê
3) ·Éê·Éò·É†·É©·Éò·Éî ·Éó·Éê·Éï·Éò·É°·É£·É§·Éê·Éö·Éò ·Éì·Éê·É¨·Éß·Éî·Éë·Éê
·Éõ·Éñ·Éê·Éì·Éê·Éê.`,
      rulesTitle:"·É¨·Éî·É°·Éî·Éë·Éò",
      rule1:"·Éî·É†·Éó PC-·Éñ·Éî ·Éí·Éê·Éì·Éê·Éô·Éï·Éî·Éó·Éê ·Éê·É† ·É®·Éî·Éò·É´·Éö·Éî·Éë·Éê",
      rule2:`·Éõ·Éò·Éú ${MIN_BOOK_MINUTES} ·É¨·Éó, ·Éõ·Éê·É•·É° ${MAX_BOOK_HOURS} ·É°·Éó`,
      rule3:`·É¨·Éò·Éú·Éê·É°·É¨·Éê·É†: ·Éõ·Éê·É•·É° ${MAX_DAYS_AHEAD} ·Éì·É¶·Éî`,
      rule4on:`·É°·Éê·Éê·Éó·Éî·Éë·Éò: ${WORK_START} ‚Üí ${WORK_END}`,
      rule4off:"·É°·Éê·Éê·Éó·Éî·Éë·Éò: 24/7",
      errNick:"·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éî ·Éú·Éò·Éô·Éò.",
      errPc:"·Éê·Éò·É†·É©·Éò·Éî ·Éõ·Éò·Éú·Éò·Éõ·É£·Éõ 1 PC.",
      errDate:"·Éê·Éò·É†·É©·Éò·Éî ·Éó·Éê·É†·Éò·É¶·Éò.",
      errDur:"·Éê·Éò·É†·É©·Éò·Éî ·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éù·Éë·Éê.",
      errStart:"·Éê·Éò·É†·É©·Éò·Éî ·Éì·Éê·É¨·Éß·Éî·Éë·Éê.",
      errPast:"·É¨·Éê·É†·É°·É£·Éö·É®·Éò ·ÉØ·Éê·Éï·É®·Éê·Éú·Éò ·Éê·É† ·É®·Éî·Éò·É´·Éö·Éî·Éë·Éê.",
      errTooFar:"·É´·Éê·Éö·Éò·Éê·Éú ·É®·Éù·É†·É°·Éê·Éê.",
      errNoSlots:"·Éê·Éõ ·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éù·Éë·Éê·Éñ·Éî ·Éó·Éê·Éï·Éò·É°·É£·É§·Éê·Éö·Éò ·Éì·Éê·É¨·Éß·Éî·Éë·Éê ·Éê·É† ·Éê·É†·Éò·É°. ·É°·É™·Éê·Éì·Éî ·É°·ÉÆ·Éï·Éê.",
      created:"·Éõ·Éñ·Éê·Éì·Éê·Éê! ·É®·Éî·É•·Éõ·Éú·Éò·Éö·Éò·Éê",
      copied:"·Éô·Éù·Éû·Éò·É†·Éî·Éë·É£·Éö·Éò·Éê.",
      copyFail:"·Éï·Éî·É† ·Éì·Éê·Éô·Éù·Éû·Éò·É†·Éì·Éê ‚Äî ·ÉÆ·Éî·Éö·Éò·Éó ·Éì·Éê·Éô·Éù·Éû·Éò·É†·Éî."
    }
  };

  // =========================
  // Helpers
  // =========================
  const $ = (id) => document.getElementById(id);
  const pad2 = (n)=>String(n).padStart(2,"0");
  const toISODate = (d)=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const parseDateISO = (iso)=>{ const [y,m,d]=iso.split("-").map(Number); return new Date(y, m-1, d, 0,0,0,0); };
  const minutesFromTime = (t)=>{ const [h,m]=t.split(":").map(Number); return h*60+m; };
  const timeFromMinutes = (min)=>{ min=((min%1440)+1440)%1440; const h=Math.floor(min/60), m=min%60; return `${pad2(h)}:${pad2(m)}`; };
  const addDays = (dateObj, days)=>{ const d=new Date(dateObj); d.setDate(d.getDate()+days); return d; };
  const money = (n)=>`${Number(n||0).toFixed(2)} GEL`;
  const calcPriceGel = (pricePerHour, mins)=>Math.round((Number(pricePerHour)*(mins/60))*2)/2;

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function intersects(a1,a2,b1,b2){
    return Math.max(a1.getTime(), b1.getTime()) < Math.min(a2.getTime(), b2.getTime());
  }

  // =========================
  // Storage
  // =========================
  function loadBookings(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(e){ return []; }
  }
  function saveBookings(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

  // =========================
  // State
  // =========================
  let lang = localStorage.getItem(LANG_KEY) || "ru";
  if(!i18n[lang]) lang="ru";

  let bookings = loadBookings();
  let selectedPCs = new Set();
  let selectedDurMin = null;
  let selectedStartMinAbs = null; // minutes from window start (absolute within the day-window)
  let computedWindow = null; // {day0, winStartAbsDate, winEndAbsDate, winStartMin, winEndMin, spansMidnight}

  // =========================
  // i18n
  // =========================
  function t(k){ return i18n[lang][k] ?? i18n.ru[k] ?? k; }
  function applyLang(){
    $("t_title").textContent = t("title");
    $("t_sub").textContent = t("sub");
    $("t_today").textContent = t("today");
    $("t_bookings").textContent = t("bookings");

    $("t_step1").textContent = t("s1");
    $("t_step2").textContent = t("s2");
    $("t_step3").textContent = t("s3");
    $("t_hint").textContent = t("hint");

    $("t_fast").textContent = t("fast");
    $("t_intro1").textContent = t("intro1");
    $("t_intro2").textContent = t("intro2");
    $("t_intro3").textContent = t("intro3");
    $("t_start").textContent = t("start");
    $("t_my").textContent = t("my");
    $("t_my2").textContent = t("my");

    $("t_nickLabel").textContent = t("nick");
    $("t_dateLabel").textContent = t("date");
    $("t_pickpc").textContent = t("pickpc");
    $("t_next").textContent = t("next");
    $("t_clear").textContent = t("clear");

    $("t_step2Title").textContent = t("step2Title");
    $("t_step2Desc").textContent = t("step2Desc");
    $("t_pickStart").textContent = t("pickStart");
    $("t_pickStartHint").textContent = t("pickStartHint");

    $("t_noteLabel").textContent = t("note");
    $("t_priceLabel").textContent = t("price");
    $("t_back").textContent = t("back");
    $("t_next2").textContent = t("next2");
    $("t_back2").textContent = t("back2");
    $("t_bookNow").textContent = t("bookNow");
    $("t_copyShare").textContent = t("copyShare");
    $("t_qrTitle").textContent = t("qrTitle");
    $("qrHint").textContent = t("qrHint");

    $("t_myTitle").textContent = t("myTitle");
    $("t_myHint").textContent = t("myHint");
    $("t_myNick").textContent = t("myNick");
    $("t_show").textContent = t("show");
    $("t_close").textContent = t("close");

    $("t_colDate").textContent = t("colDate");
    $("t_colTime").textContent = t("colTime");
    $("t_colPc").textContent = t("colPc");
    $("t_colNote").textContent = t("colNote");
    $("t_colCost").textContent = t("colCost");
    $("t_colCancel").textContent = t("colCancel");

    $("t_sideTitle").textContent = "Hint";
    $("t_sideHint").textContent = "";
    $("helpBox").textContent = t("help");

    $("rulesBox").innerHTML = `
      <b>${t("rulesTitle")}</b><br/>
      ‚Ä¢ ${t("rule1")}<br/>
      ‚Ä¢ ${t("rule2")}<br/>
      ‚Ä¢ ${t("rule3")}<br/>
      ‚Ä¢ ${WORKING_HOURS_ENABLED ? t("rule4on") : t("rule4off")}
    `;

    $("lang_ru").classList.toggle("active", lang==="ru");
    $("lang_en").classList.toggle("active", lang==="en");
    $("lang_ka").classList.toggle("active", lang==="ka");
  }

  // =========================
  // UI flow
  // =========================
  function setStep(n){
    $("step1").classList.toggle("active", n===1);
    $("step2").classList.toggle("active", n===2);
    $("step3").classList.toggle("active", n===3);
    $("step1Box").classList.toggle("hide", n!==1);
    $("step2Box").classList.toggle("hide", n!==2);
    $("step3Box").classList.toggle("hide", n!==3);
    $("introBox").classList.add("hide");
  }
  function showIntro(){
    $("introBox").classList.remove("hide");
    $("step1Box").classList.add("hide");
    $("step2Box").classList.add("hide");
    $("step3Box").classList.add("hide");
    $("step1").classList.remove("active");
    $("step2").classList.remove("active");
    $("step3").classList.remove("active");
  }

  function setMsg(text, kind="info"){
    const el = $("msg");
    el.textContent = text;
    el.style.borderColor =
      kind==="good" ? "rgba(52,211,153,.45)" :
      kind==="bad" ? "rgba(251,113,133,.55)" :
      "rgba(110,231,255,.35)";
    el.style.background =
      kind==="good" ? "rgba(52,211,153,.08)" :
      kind==="bad" ? "rgba(251,113,133,.08)" :
      "rgba(110,231,255,.06)";
  }

  function renderPills(){
    $("countPill").textContent = String(bookings.length);
    $("todayPill").textContent = new Date().toLocaleDateString(undefined, {year:"numeric", month:"2-digit", day:"2-digit"});
  }

  // =========================
  // Booking time window (club hours) -> absolute window [winStartAbsDate, winEndAbsDate)
  // =========================
  function computeWindowForDate(dateISO){
    const day0 = parseDateISO(dateISO);
    if(!WORKING_HOURS_ENABLED){
      const winStartAbsDate = new Date(day0.getFullYear(), day0.getMonth(), day0.getDate(), 0,0,0,0);
      const winEndAbsDate = addDays(winStartAbsDate, 1);
      return { day0, winStartAbsDate, winEndAbsDate, spansMidnight:false, winStartMin:0, winEndMin:1440 };
    }

    const ws = minutesFromTime(WORK_START);
    const we = minutesFromTime(WORK_END);

    const winStartAbsDate = new Date(day0.getFullYear(), day0.getMonth(), day0.getDate(), Math.floor(ws/60), ws%60, 0,0);

    let spansMidnight = false;
    let winEndAbsDate;
    if(we > ws){
      winEndAbsDate = new Date(day0.getFullYear(), day0.getMonth(), day0.getDate(), Math.floor(we/60), we%60, 0,0);
    }else{
      spansMidnight = true;
      const day1 = addDays(day0, 1);
      winEndAbsDate = new Date(day1.getFullYear(), day1.getMonth(), day1.getDate(), Math.floor(we/60), we%60, 0,0);
    }

    const winStartMin = ws;
    const winEndMin = spansMidnight ? (1440 + we) : we;

    return { day0, winStartAbsDate, winEndAbsDate, spansMidnight, winStartMin, winEndMin };
  }

  // =========================
  // Stored booking -> absolute range
  // =========================
  function bookingToAbs(b){
    const dateISO = b.dateStart || b.date || "";
    const d0 = parseDateISO(dateISO);
    const sMin = minutesFromTime(b.start);
    const eMin = minutesFromTime(b.end);

    const startAbs = new Date(d0.getFullYear(), d0.getMonth(), d0.getDate(), Math.floor(sMin/60), sMin%60, 0,0);

    const span = b.spansMidnight || (eMin <= sMin);
    let endAbs;
    if(!span){
      endAbs = new Date(d0.getFullYear(), d0.getMonth(), d0.getDate(), Math.floor(eMin/60), eMin%60, 0,0);
    }else{
      const d1 = addDays(d0, 1);
      endAbs = new Date(d1.getFullYear(), d1.getMonth(), d1.getDate(), Math.floor(eMin/60), eMin%60, 0,0);
    }
    return { startAbs, endAbs };
  }

  function hasConflictForAllSelected(startAbs, endAbs){
    for(const pc of selectedPCs){
      for(const b of bookings){
        if(b.pc !== pc) continue;
        const br = bookingToAbs(b);
        if(intersects(startAbs, endAbs, br.startAbs, br.endAbs)){
          return true;
        }
      }
    }
    return false;
  }

  // =========================
  // Generate free start slots
  // =========================
  function roundUpToStep(min, step){
    return Math.ceil(min / step) * step;
  }

  function buildSlots(){
    const grid = $("slotGrid");
    grid.innerHTML = "";
    selectedStartMinAbs = null;

    const dateISO = $("date").value;
    if(!dateISO || !selectedDurMin || selectedPCs.size===0){
      grid.innerHTML = `<div class="hint">‚Äî</div>`;
      $("rangePreview").textContent = "‚Äî";
      return;
    }

    computedWindow = computeWindowForDate(dateISO);

    // current time limit if today
    const now = new Date();
    const todayISO = toISODate(now);
    let minStartAllowedAbsMin = computedWindow.winStartMin;

    if(dateISO === todayISO){
      // convert current time to "window minutes space"
      const curMin = now.getHours()*60 + now.getMinutes();
      // if window spans midnight and we're after midnight (same day0), curMin is fine
      // we only ensure start >= now (in absolute)
      minStartAllowedAbsMin = Math.max(computedWindow.winStartMin, curMin);
    }

    // start/end in "extended minutes" space
    const step = START_STEP_MIN;
    const startMin = roundUpToStep(minStartAllowedAbsMin, step);
    const lastStart = computedWindow.winEndMin - selectedDurMin; // inclusive upper bound for start

    const slots = [];
    for(let m = startMin; m <= lastStart; m += step){
      // convert m (extended minutes from day0 00:00) to absolute Date
      const day0 = parseDateISO(dateISO);
      const absStart = new Date(day0.getTime() + (m * 60000));
      const absEnd = new Date(absStart.getTime() + (selectedDurMin * 60000));

      // must be within window absolute
      if(absStart < computedWindow.winStartAbsDate) continue;
      if(absEnd > computedWindow.winEndAbsDate) continue;

      // must not be in the past absolute
      if(absStart.getTime() < now.getTime()) continue;

      if(!hasConflictForAllSelected(absStart, absEnd)){
        slots.push({m, absStart, absEnd});
      }
    }

    if(!slots.length){
      grid.innerHTML = `<div class="notice" style="grid-column:1/-1;">${t("errNoSlots")}</div>`;
      $("rangePreview").textContent = "‚Äî";
      return;
    }

    for(const s of slots){
      const btn = document.createElement("div");
      btn.className = "slot";
      btn.textContent = timeFromMinutes(s.m);
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".slot").forEach(x=>x.classList.remove("active"));
        btn.classList.add("active");
        selectedStartMinAbs = s.m;
        renderRangePreview();
      });
      grid.appendChild(btn);
    }

    // auto-select first slot to be extra fast
    const first = slots[0];
    selectedStartMinAbs = first.m;
    grid.querySelector(".slot")?.classList.add("active");
    renderRangePreview();
  }

  function renderRangePreview(){
    if(!computedWindow || selectedStartMinAbs == null || !selectedDurMin){
      $("rangePreview").textContent = "‚Äî";
      return;
    }
    const dateISO = $("date").value;
    const day0 = parseDateISO(dateISO);
    const startAbs = new Date(day0.getTime() + selectedStartMinAbs*60000);
    const endAbs = new Date(startAbs.getTime() + selectedDurMin*60000);

    const startStr = `${pad2(startAbs.getHours())}:${pad2(startAbs.getMinutes())}`;
    const endStr = `${pad2(endAbs.getHours())}:${pad2(endAbs.getMinutes())}`;
    const endISO = toISODate(endAbs);
    const over = endISO !== dateISO;

    const pcs = Array.from(selectedPCs).join(", ");
    $("rangePreview").textContent =
      `–ü–ö: ${pcs} | ${dateISO} ${startStr} ‚Üí ${endStr}${over ? " (+1)" : ""} | ${selectedDurMin} min`;
  }

  function renderDurations(){
    const bar = $("durChips");
    bar.innerHTML = "";
    for(const m of DURATIONS){
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.textContent = m < 60 ? `${m}m` : (m%60===0 ? `${m/60}h` : `${Math.floor(m/60)}h ${m%60}m`);
      chip.addEventListener("click", ()=>{
        document.querySelectorAll("#durChips .chip").forEach(x=>x.classList.remove("active"));
        chip.classList.add("active");
        selectedDurMin = m;
        buildSlots();
      });
      bar.appendChild(chip);
    }
  }

  // =========================
  // PCs render
  // =========================
  function renderPCs(){
    const grid = $("pcGrid");
    grid.innerHTML = "";
    for(const pc of PCs){
      const div = document.createElement("div");
      div.className = "pc" + (selectedPCs.has(pc) ? " selected" : "");
      div.innerHTML = `
        <div class="check">‚úì</div>
        <div class="name">${pc}</div>
        <div class="meta"><span class="tag"><span class="dot warn"></span>select</span></div>
      `;
      div.addEventListener("click", ()=>{
        if(selectedPCs.has(pc)) selectedPCs.delete(pc);
        else selectedPCs.add(pc);
        renderPCs();
        // rebuild slots because availability depends on ALL selected PCs
        buildSlots();
      });
      grid.appendChild(div);
    }
  }

  // =========================
  // Summary + create
  // =========================
  function getSelectedRange(){
    const dateISO = $("date").value;
    if(!dateISO || selectedStartMinAbs==null || !selectedDurMin) return null;
    const day0 = parseDateISO(dateISO);
    const startAbs = new Date(day0.getTime() + selectedStartMinAbs*60000);
    const endAbs = new Date(startAbs.getTime() + selectedDurMin*60000);
    const startStr = `${pad2(startAbs.getHours())}:${pad2(startAbs.getMinutes())}`;
    const endStr = `${pad2(endAbs.getHours())}:${pad2(endAbs.getMinutes())}`;
    const spansMidnight = toISODate(endAbs) !== dateISO;
    return { dateISO, startAbs, endAbs, startStr, endStr, spansMidnight };
  }

  function renderSummary(){
    const nick = ($("nick").value||"").trim();
    const note = ($("note").value||"").trim();
    const pricePerHour = Number($("price").value||5);
    const pcs = Array.from(selectedPCs);

    const r = getSelectedRange();
    let when = "‚Äî";
    let perPc = 0;
    let total = 0;

    if(r){
      const mins = Math.round((r.endAbs - r.startAbs)/60000);
      perPc = calcPriceGel(pricePerHour, mins);
      total = perPc * pcs.length;
      const endISO = toISODate(r.endAbs);
      when = r.spansMidnight ? `${r.dateISO} ${r.startStr} ‚Üí ${endISO} ${r.endStr}` : `${r.dateISO} ${r.startStr} ‚Üí ${r.endStr}`;
    }

    $("summaryBox").innerHTML = `
      <b>${t("s3")}</b><br/>
      ‚Ä¢ ${t("nick")}: <b>${escapeHtml(nick||"‚Äî")}</b><br/>
      ‚Ä¢ ${t("colPc")}: <b>${escapeHtml(pcs.length?pcs.join(", "):"‚Äî")}</b><br/>
      ‚Ä¢ ${t("colTime")}: <b>${escapeHtml(when)}</b><br/>
      ‚Ä¢ ${t("colCost")} (per PC): <b>${money(perPc)}</b><br/>
      ‚Ä¢ ${t("colCost")} total: <b>${money(total)}</b><br/>
      ${note ? ("‚Ä¢ "+t("colNote")+": <b>"+escapeHtml(note)+"</b><br/>") : ""}
    `;
  }

  function createBooking(){
    const nick = ($("nick").value||"").trim();
    if(!nick){ setMsg(t("errNick"),"bad"); return; }
    if(selectedPCs.size===0){ setMsg(t("errPc"),"bad"); return; }
    const dateISO = $("date").value;
    if(!dateISO){ setMsg(t("errDate"),"bad"); return; }
    const r = getSelectedRange();
    if(!selectedDurMin){ setMsg(t("errDur"),"bad"); return; }
    if(!r){ setMsg(t("errStart"),"bad"); return; }

    // check max ahead
    const d0 = parseDateISO(dateISO);
    const today0 = parseDateISO(toISODate(new Date()));
    const diffDays = Math.round((d0 - today0)/86400000);
    if(diffDays > MAX_DAYS_AHEAD){ setMsg(t("errTooFar"),"bad"); return; }

    // no past
    if(r.startAbs.getTime() < Date.now()){ setMsg(t("errPast"),"bad"); return; }

    // conflicts (double-check)
    if(hasConflictForAllSelected(r.startAbs, r.endAbs)){
      setMsg(t("errNoSlots"),"bad");
      return;
    }

    const note = ($("note").value||"").trim();
    const pricePerHour = Number($("price").value||5);
    const mins = Math.round((r.endAbs - r.startAbs)/60000);
    const perPc = calcPriceGel(pricePerHour, mins);

    const created = [];
    for(const pc of selectedPCs){
      created.push({
        id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2)),
        nick,
        pc,
        dateStart: dateISO,
        start: r.startStr,
        end: r.endStr,
        spansMidnight: r.spansMidnight,
        note,
        pricePerHour,
        totalGel: perPc,
        createdAt: new Date().toISOString()
      });
    }

    bookings = bookings.concat(created);
    saveBookings(bookings);
    renderPills();

    setMsg(`${t("created")}: ${created.length}`, "good");
    renderMyTable(nick);

    const payload = buildShareText({ nick, pcs:Array.from(selectedPCs), r, note, perPc, total: perPc*selectedPCs.size });
    renderQR(payload);
  }

  function buildShareText({nick, pcs, r, note, perPc, total}){
    const endISO = toISODate(r.endAbs);
    const when = r.spansMidnight
      ? `${r.dateISO} ${r.startStr} ‚Üí ${endISO} ${r.endStr}`
      : `${r.dateISO} ${r.startStr} ‚Üí ${r.endStr}`;

    return [
      "Sakompiutere Booking",
      `Nick: ${nick}`,
      `PCs: ${pcs.join(", ")}`,
      `Time: ${when}`,
      note ? `Note: ${note}` : null,
      `Cost per PC: ${money(perPc)}`,
      `Total: ${money(total)}`
    ].filter(Boolean).join("\n");
  }

  async function copyShare(){
    const nick = ($("nick").value||"").trim();
    const r = getSelectedRange();
    if(!nick || !r || selectedPCs.size===0 || !selectedDurMin){
      setMsg("Fill booking first.", "bad");
      return;
    }
    const note = ($("note").value||"").trim();
    const mins = Math.round((r.endAbs - r.startAbs)/60000);
    const perPc = calcPriceGel(Number($("price").value||5), mins);
    const text = buildShareText({
      nick,
      pcs:Array.from(selectedPCs),
      r,
      note,
      perPc,
      total: perPc*selectedPCs.size
    });
    try{
      await navigator.clipboard.writeText(text);
      setMsg(t("copied"), "good");
    }catch(e){
      setMsg(t("copyFail"), "bad");
    }
  }

  function renderQR(text){
    const canvas = $("qrCanvas");
    if(!window.QRCode || !QRCode.toCanvas){
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "#111111";
      ctx.font = "12px sans-serif";
      ctx.fillText("QR lib not loaded", 20, 80);
      return;
    }
    QRCode.toCanvas(canvas, text, { width: 160, margin: 1 }, () => {});
  }

  // =========================
  // My bookings
  // =========================
  function bookingTimeLabel(b){
    const span = b.spansMidnight || (minutesFromTime(b.end) <= minutesFromTime(b.start));
    return span ? `${b.start} ‚Üí ${b.end} (+1)` : `${b.start} ‚Üí ${b.end}`;
  }

  function renderMyTable(nick){
    const tbody = $("myTable");
    tbody.innerHTML = "";
    const q = (nick || "").trim();
    if(!q){
      tbody.innerHTML = `<tr><td colspan="6" style="color:var(--muted)">‚Äî</td></tr>`;
      return;
    }

    const list = bookings
      .filter(b => (b.nick||"").trim().toLowerCase() === q.toLowerCase())
      .sort((a,b)=> ((a.dateStart||a.date)+a.start+a.pc).localeCompare((b.dateStart||b.date)+b.start+b.pc));

    if(!list.length){
      tbody.innerHTML = `<tr><td colspan="6" style="color:var(--muted)">‚Äî</td></tr>`;
      return;
    }

    for(const b of list){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(b.dateStart || b.date)}</td>
        <td>${escapeHtml(bookingTimeLabel(b))}</td>
        <td><b>${escapeHtml(b.pc)}</b></td>
        <td style="color:var(--muted)">${escapeHtml(b.note || "")}</td>
        <td>${money(b.totalGel)}</td>
        <td><button class="mini danger" data-id="${b.id}">Cancel</button></td>
      `;
      tbody.appendChild(tr);
    }

    tbody.querySelectorAll("button[data-id]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-id");
        const b = bookings.find(x=>x.id===id);
        if(!b) return;

        if(!confirm(`Cancel booking?\n${b.nick} ‚Ä¢ ${b.pc}\n${b.dateStart||b.date} ${bookingTimeLabel(b)}`)) return;
        bookings = bookings.filter(x=>x.id!==id);
        saveBookings(bookings);
        renderPills();
        renderMyTable($("myNickInput").value);
        buildSlots();
      });
    });
  }

  function openMyBox(prefillNick){
    $("myBox").classList.remove("hide");
    $("myNickInput").value = prefillNick || localStorage.getItem(NICK_KEY) || $("nick").value || "";
    renderMyTable($("myNickInput").value);
    $("myBox").scrollIntoView({behavior:"smooth", block:"start"});
  }
  function closeMyBox(){ $("myBox").classList.add("hide"); }

  // =========================
  // Validation for navigation
  // =========================
  function validateStep1(){
    const nick = ($("nick").value||"").trim();
    if(!nick) return {ok:false, msg:t("errNick")};
    if(!$("date").value) return {ok:false, msg:t("errDate")};
    if(selectedPCs.size===0) return {ok:false, msg:t("errPc")};

    localStorage.setItem(NICK_KEY, nick);
    return {ok:true};
  }

  // =========================
  // Boot
  // =========================
  function boot(){
    // defaults
    const now = new Date();
    $("date").value = toISODate(now);
    $("todayPill").textContent = now.toLocaleDateString(undefined, {year:"numeric", month:"2-digit", day:"2-digit"});

    const savedNick = localStorage.getItem(NICK_KEY) || "";
    if(savedNick) $("nick").value = savedNick;

    renderPills();
    applyLang();
    renderPCs();
    renderDurations();
    buildSlots();
    showIntro();

    // language
    $("lang_ru").onclick = () => { lang="ru"; localStorage.setItem(LANG_KEY,lang); applyLang(); renderSummary(); };
    $("lang_en").onclick = () => { lang="en"; localStorage.setItem(LANG_KEY,lang); applyLang(); renderSummary(); };
    $("lang_ka").onclick = () => { lang="ka"; localStorage.setItem(LANG_KEY,lang); applyLang(); renderSummary(); };

    // intro
    $("startBtn").onclick = () => setStep(1);
    $("viewMyBtn").onclick = () => openMyBox($("nick").value);

    // step1
    $("clearPcBtn").onclick = () => { selectedPCs.clear(); renderPCs(); buildSlots(); };
    $("date").addEventListener("change", ()=>buildSlots());
    $("nick").addEventListener("input", ()=>localStorage.setItem(NICK_KEY, ($("nick").value||"").trim()));

    $("toStep2Btn").onclick = () => {
      const v = validateStep1();
      if(!v.ok){ alert(v.msg); return; }
      setStep(2);

      // auto pick first duration for speed
      if(!selectedDurMin){
        const firstChip = document.querySelector("#durChips .chip");
        firstChip?.click();
      }else{
        buildSlots();
      }
    };

    // step2
    $("backTo1Btn").onclick = () => setStep(1);
    $("toStep3Btn").onclick = () => {
      const v = validateStep1();
      if(!v.ok){ alert(v.msg); return; }
      if(!selectedDurMin){ alert(t("errDur")); return; }
      if(selectedStartMinAbs == null){ alert(t("errStart")); return; }
      setStep(3);
      renderSummary();
      setMsg("OK","info");
    };

    // step3
    $("backTo2Btn").onclick = () => setStep(2);
    $("createBtn").onclick = () => { createBooking(); renderSummary(); };
    $("showMyInlineBtn").onclick = () => openMyBox($("nick").value);
    $("copyShareBtn").onclick = copyShare;

    // my box
    $("mySearchBtn").onclick = () => renderMyTable($("myNickInput").value);
    $("myCloseBtn").onclick = closeMyBox;

    // live preview when note/price change
    $("note").addEventListener("input", ()=>{ if(!$("step3Box").classList.contains("hide")) renderSummary(); });
    $("price").addEventListener("input", ()=>{ if(!$("step3Box").classList.contains("hide")) renderSummary(); });

    // Esc
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") showIntro(); });
  }

  boot();
})();
</script>
</body>
</html>
