<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Sakompiutere Gaming ‚Äî Booking</title>
  <meta name="theme-color" content="#0b1020" />

  <!-- Firebase v9 COMPAT -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#070a12;
      --card:#0b1020;
      --muted:#9aa4bf;
      --text:#eaf0ff;
      --line:rgba(255,255,255,.09);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
      --shadow:0 20px 60px rgba(0,0,0,.55);
      --r:18px;
      --pad: 18px;
      --gap: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(110,231,255,.12), transparent 60%),
        radial-gradient(900px 700px at 80% 10%, rgba(167,139,250,.14), transparent 60%),
        radial-gradient(800px 700px at 40% 120%, rgba(52,211,153,.10), transparent 60%),
        var(--bg);
      overflow-x:hidden;
    }

    .wrap{max-width:1180px; margin:0 auto; padding:var(--pad);}

    header{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 16px; border:1px solid var(--line); border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      position:sticky; top:14px; z-index:20;
      backdrop-filter: blur(10px);
    }

    .brand{display:flex; gap:12px; align-items:center; min-width:0;}
    .logo-wrap{
      width:46px;height:46px;border-radius:16px;
      display:grid;place-items:center;flex:0 0 auto;
      border:1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(circle at 30% 20%, rgba(255,193,7,.22), rgba(255,193,7,.06) 60%, transparent 72%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.12));
      box-shadow: 0 12px 30px rgba(0,0,0,.4), 0 0 0 1px rgba(255,193,7,.12) inset;
      animation: logoFloat 6s ease-in-out infinite;
    }
    .logo-symbol{
      width:34px;height:auto;user-select:none;-webkit-user-drag:none;
      mix-blend-mode: screen;
      filter: drop-shadow(0 0 6px rgba(255,193,7,.55)) drop-shadow(0 0 18px rgba(255,193,7,.22));
      animation: logoPulse 3.4s ease-in-out infinite;
    }
    @keyframes logoFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
    @keyframes logoPulse{0%,100%{transform:scale(1);opacity:.95}50%{transform:scale(1.06);opacity:1}}

    .brandText{min-width:0}
    .brand h1{margin:0;font-size:16px;letter-spacing:.35px;line-height:1.2;word-break:break-word}
    .brand .sub{margin:4px 0 0;color:var(--muted);font-size:12px;line-height:1.25;word-break:break-word}

    .rightbar{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center;}
    .pill{
      padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--muted); font-size:12px;
      max-width: 340px;
      line-height:1.25;
      display:flex; gap:8px; align-items:center;
    }
    .pill strong{color:var(--text); font-weight:950}

    .dot{
      width:8px; height:8px; border-radius:999px;
      background:rgba(255,255,255,.22);
    }
    .dot.ok{ background: rgba(52,211,153,.95); box-shadow:0 0 0 0 rgba(52,211,153,.35); animation:pulse 1.8s ease-out infinite; }
    .dot.err{ background: rgba(251,113,133,.95); }
    @keyframes pulse{
      0%{ box-shadow:0 0 0 0 rgba(52,211,153,.35); }
      70%{ box-shadow:0 0 0 10px rgba(52,211,153,0); }
      100%{ box-shadow:0 0 0 0 rgba(52,211,153,0); }
    }

    .lang{
      display:flex; gap:6px;
      padding:6px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      flex:0 0 auto;
    }
    .lang button{
      padding:7px 10px; border-radius:999px;
      border:1px solid transparent;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      font-weight:950;
      font-size:12px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      touch-action: manipulation;
    }
    .lang button:active{transform: scale(.98)}
    .lang button.active{
      border-color: rgba(110,231,255,.55);
      background: rgba(110,231,255,.10);
      color: var(--text);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: var(--gap);
      margin-top:16px;
    }
    .card{
      border:1px solid var(--line);
      border-radius:var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:14px 16px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.10);
    }
    .hd h2{margin:0;font-size:14px}
    .hint{color:var(--muted); font-size:12px; line-height:1.25; text-align:right; max-width:55%;}
    .bd{padding:14px 16px}

    .notice{
      border:1px dashed rgba(110,231,255,.35);
      background: rgba(110,231,255,.06);
      padding:12px 12px;
      border-radius:16px;
      font-size:12px;
      line-height:1.4;
      word-break: break-word;
    }

    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:11px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:1000;
      letter-spacing:.2px;
      transition: transform .12s ease, border-color .12s ease, background .12s ease, box-shadow .12s ease, opacity .12s ease;
      touch-action: manipulation;
    }
    button:hover{border-color: rgba(110,231,255,.5)}
    button:active{transform: scale(.985)}
    button[disabled]{opacity:.55; cursor:not-allowed; transform:none}

    .primary{
      border-color: rgba(110,231,255,.55);
      background: linear-gradient(180deg, rgba(110,231,255,.18), rgba(167,139,250,.10));
    }
    .primary:hover{box-shadow: 0 0 0 3px rgba(110,231,255,.10)}
    .ghost{background:transparent}
    .danger{border-color: rgba(251,113,133,.6); background: rgba(251,113,133,.10)}
    .mini{padding:7px 10px; border-radius:12px; font-size:12px; font-weight:1000}

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input, select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
      transition: box-shadow .12s ease, border-color .12s ease;
    }
    input:focus, select:focus{border-color: rgba(110,231,255,.6); box-shadow:0 0 0 3px rgba(110,231,255,.12)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
    .mut{color:var(--muted); font-size:12px}

    .pcgrid{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:10px;
      margin-top:10px;
    }
    .pc{
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(0,0,0,.22);
      cursor:pointer;
      transition: transform .10s ease, border-color .12s ease, box-shadow .12s ease;
      user-select:none;
      position:relative;
      min-height:74px;
    }
    .pc:hover{transform: translateY(-1px); border-color: rgba(110,231,255,.4)}
    .pc .name{font-weight:1100; letter-spacing:.3px}
    .pc .meta{margin-top:6px; color:var(--muted); font-size:12px}
    .pc.selected{
      border-color: rgba(110,231,255,.75);
      box-shadow: 0 0 0 3px rgba(110,231,255,.10);
    }
    .check{
      position:absolute; top:10px; right:10px;
      width:22px; height:22px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.35);
      display:grid; place-items:center;
      color: transparent;
      font-weight:1100;
      font-size:12px;
    }
    .pc.selected .check{
      border-color: rgba(110,231,255,.75);
      background: rgba(110,231,255,.14);
      color: var(--text);
    }

    /* Time picker (buttons) */
    .timeBox{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      border-radius:18px;
      padding:12px;
    }
    .timeTop{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .timeTop .title{
      font-weight:1100; font-size:13px;
      display:flex; gap:10px; align-items:center;
    }
    .picked{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12px;
    }
    .picked b{color:var(--text)}
    .timeList{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:8px;
      margin-top:10px;
    }
    .tbtn{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      transition: transform .10s ease, border-color .12s ease, box-shadow .12s ease, opacity .12s ease;
      font-weight:1100;
      text-align:center;
      user-select:none;
      line-height:1.15;
    }
    .tbtn:hover{transform: translateY(-1px); border-color: rgba(110,231,255,.5)}
    .tbtn.busy{
      cursor:not-allowed;
      opacity:.65;
      border-color: rgba(251,113,133,.40);
      background: rgba(251,113,133,.06);
      color: rgba(251,113,133,.9);
      transform:none !important;
    }
    .tbtn.past{
      cursor:not-allowed;
      opacity:.55;
      transform:none !important;
    }
    .tbtn.active{
      border-color: rgba(110,231,255,.75);
      box-shadow: 0 0 0 3px rgba(110,231,255,.10);
      background: rgba(110,231,255,.08);
    }

    .tablewrap{
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      border-radius:16px;
      margin-top:10px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 560px;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
      font-size:12px;
      white-space:nowrap;
    }
    th{
      color:var(--muted);
      font-weight:1100;
      text-align:left;
      background:rgba(255,255,255,.03);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:last-child td{border-bottom:none}

    .footerbar{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-top:12px;
      color: var(--muted);
      font-size:12px;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      padding:2px 6px;
      border:1px solid var(--line);
      border-radius:8px;
      background:rgba(0,0,0,.25);
      color:var(--muted);
      font-size:12px;
    }
    .hide{display:none !important;}

    /* Modal */
    .backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.58);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .backdrop.show{display:flex;}
    .modal{
      width:min(560px, 100%);
      border:1px solid var(--line);
      border-radius:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
      animation: modalIn .18s ease-out both;
    }
    @keyframes modalIn{from{opacity:0;transform:translateY(8px) scale(.985)}to{opacity:1;transform:translateY(0) scale(1)}}
    .mh{
      padding:14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.14);
    }
    .mb{padding:14px 16px}

    /* Success */
    .successBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.68);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:1000;
    }
    .successBackdrop.show{display:flex;}
    .successCard{
      width:min(560px, 100%);
      border:1px solid var(--line);
      border-radius:22px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .confetti{position:absolute; inset:0; pointer-events:none; overflow:hidden;}
    .confetti i{
      position:absolute;
      width:10px; height:14px;
      border-radius:3px;
      opacity:.85;
      transform: translateY(-20px) rotate(0deg);
      animation: fall 900ms linear forwards;
    }
    @keyframes fall{
      to{ transform: translateY(520px) rotate(260deg); opacity:0.95; }
    }
    .successTop{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      background: rgba(0,0,0,.16);
    }
    .successBody{ padding:16px; }
    .bigCheck{
      width:62px; height:62px; border-radius:22px;
      border:1px solid rgba(52,211,153,.35);
      background: radial-gradient(circle at 25% 20%, rgba(52,211,153,.35), rgba(52,211,153,.08) 55%, rgba(0,0,0,.12));
      display:grid; place-items:center;
      font-size:28px;
      margin-bottom:12px;
      box-shadow: 0 18px 45px rgba(0,0,0,.35);
    }
    .successInfo{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      border-radius:18px;
      padding:12px 12px;
      color: var(--muted);
      font-size:12px;
      line-height:1.55;
    }
    .successInfo b{color: var(--text)}
    .successActions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
      header{position:static;}
      .hint{max-width:100%; text-align:left;}
      .timeList{grid-template-columns: repeat(3, 1fr);}
      .pcgrid{grid-template-columns: repeat(2, 1fr);}
    }
    @media (max-width: 560px){
      :root{ --pad: 12px; --gap: 12px; }
      header{flex-direction: column; align-items: stretch; gap: 10px; padding: 12px;}
      .rightbar{width:100%; justify-content: stretch; gap:8px;}
      .lang{width:100%; justify-content:space-between;}
      .pill{width:100%; max-width:100%; border-radius:14px;}
      .row{grid-template-columns:1fr;}
      button{width:100%;}
      .btns{gap:8px}
      .tablewrap table{min-width:640px;}
      .timeList{grid-template-columns: repeat(2, 1fr);}
    }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo-wrap" aria-hidden="true">
        <img class="logo-symbol" src="logo-symbol.png" alt="Sakompiutere logo" onerror="this.style.display='none'">
      </div>
      <div class="brandText">
        <h1 id="t_title">Sakompiutere Gaming ‚Äî Booking</h1>
        <p class="sub" id="t_sub">–ü–ö ‚Üí –î–∞—Ç–∞/–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Üí –í—Ä–µ–º—è ‚Üí –ì–æ—Ç–æ–≤–æ</p>
      </div>
    </div>

    <div class="rightbar">
      <div class="lang" aria-label="Language selector">
        <button id="lang_ru" type="button">RU</button>
        <button id="lang_en" type="button">EN</button>
        <button id="lang_ka" type="button">KA</button>
      </div>

      <div class="pill"><span id="t_user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>: <strong id="userPill">‚Äî</strong></div>

      <div class="pill">
        <span class="dot" id="cloudDot"></span>
        <span id="t_status">–°—Ç–∞—Ç—É—Å</span>: <strong id="cloudPill">‚Ä¶</strong>
      </div>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="hd">
        <h2 id="t_main">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
        <div class="hint" id="hintTop">–û–±—â–∞—è –±–∞–∑–∞ (Firebase)</div>
      </div>

      <div class="bd">
        <!-- AUTH BAR -->
        <div class="notice" id="authBar">
          <b id="t_authTitle">–ê–∫–∫–∞—É–Ω—Ç</b><br/>
          <span id="t_authDesc">–ß—Ç–æ–±—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å ‚Äî –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏.</span>
          <div class="btns">
            <button class="primary" id="openAuthBtn" type="button">üîë <span id="t_login">–í–æ–π—Ç–∏</span> / <span id="t_register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span></button>
            <button class="ghost hide" id="logoutBtn" type="button">üö™ <span id="t_logout">–í—ã–π—Ç–∏</span></button>
          </div>
          <div class="notice" style="margin-top:10px" id="authMsg">‚Äî</div>
        </div>

        <!-- FLOW -->
        <div class="notice" style="margin-top:12px" id="flowHelp">
          <b id="t_flowTitle">–ë—ã—Å—Ç—Ä–æ</b><br/>
          <span id="t_flow1">1) –í–æ–π–¥–∏</span> ¬∑
          <span id="t_flow2">2) –í—ã–±–µ—Ä–∏ –ü–ö</span> ¬∑
          <span id="t_flow3">3) –î–∞—Ç—É + –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</span> ¬∑
          <span id="t_flow4">4) –í—Ä–µ–º—è ‚Üí –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</span>
        </div>

        <div style="margin-top:12px">
          <div class="row">
            <div>
              <label id="t_nickLabel">–ù–∏–∫ (–≤ –∫–ª—É–±–µ)</label>
              <input id="nick" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: KiraLite" />
            </div>
            <div>
              <label id="t_dateLabel">–î–∞—Ç–∞ (–∫–ª—É–±–Ω—ã–π –¥–µ–Ω—å)</label>
              <input id="date" type="date" />
            </div>
          </div>

          <div class="row">
            <div>
              <label id="t_duration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</label>
              <select id="duration">
                <option value="60">1h</option>
                <option value="90">1h 30m</option>
                <option value="120">2h</option>
                <option value="180">3h</option>
                <option value="240">4h</option>
                <option value="300">5h</option>
                <option value="360">6h</option>
              </select>
            </div>
            <div>
              <label id="t_noteLabel">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü.)</label>
              <input id="note" type="text" placeholder="CS2 / –¢—É—Ä–Ω–∏—Ä" />
            </div>
          </div>

          <div class="hint" id="t_pickpc">–í—ã–±–µ—Ä–∏ –ü–ö (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ):</div>
          <div id="pcGrid" class="pcgrid"></div>

          <!-- TIME PICKER -->
          <div class="timeBox">
            <div class="timeTop">
              <div class="title">‚è± <span id="t_timeTitle">–í—Ä–µ–º—è</span></div>
              <div class="picked" id="pickedSummary"><b>‚Äî</b></div>
            </div>
            <div class="btns" style="margin-top:0">
              <button class="ghost mini" id="nextFreeBtn" type="button">‚ö° <span id="t_nextFree">–°–ª–µ–¥—É—é—â–∏–π —Å–≤–æ–±–æ–¥–Ω—ã–π</span></button>
              <button class="ghost mini" id="refreshBtn" type="button">üîÑ <span id="t_refresh">–û–±–Ω–æ–≤–∏—Ç—å</span></button>
            </div>
            <div class="timeList" id="timeList"></div>
            <div class="mut" style="margin-top:10px" id="timeHint">–í—ã–±–µ—Ä–∏ –ü–ö + –¥–∞—Ç—É + –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî –ø–æ—è–≤—è—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç–∞—Ä—Ç—ã.</div>
          </div>

          <div class="btns" style="margin-top:12px">
            <button class="primary" id="createBtn" type="button" disabled>‚úÖ <span id="t_bookNow">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</span></button>
            <button class="ghost" id="myBtn" type="button">üë§ <span id="t_my">–ú–æ–∏ –±—Ä–æ–Ω–∏</span></button>
            <button class="ghost" id="todayBtn" type="button">üìÖ <span id="t_today">–°–µ–≥–æ–¥–Ω—è</span></button>
          </div>

          <div class="notice" style="margin-top:10px" id="msgBox">‚Äî</div>
        </div>

        <!-- MY -->
        <div id="myBox" class="hide" style="margin-top:14px">
          <div class="btns">
            <button class="ghost" id="closeMyBtn" type="button">‚úñ <span id="t_close">–ó–∞–∫—Ä—ã—Ç—å</span></button>
          </div>
          <div class="tablewrap">
            <table>
              <thead>
                <tr>
                  <th id="t_colDate">–î–∞—Ç–∞</th>
                  <th id="t_colTime">–í—Ä–µ–º—è</th>
                  <th id="t_colPc">–ü–ö</th>
                  <th id="t_colNote">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                  <th id="t_colAct">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody id="myTable"></tbody>
            </table>
          </div>
        </div>

        <!-- TODAY -->
        <div id="todayBox" class="hide" style="margin-top:14px">
          <div class="btns">
            <button class="ghost" id="closeTodayBtn" type="button">‚úñ <span id="t_close2">–ó–∞–∫—Ä—ã—Ç—å</span></button>
          </div>
          <div class="tablewrap">
            <table>
              <thead>
                <tr>
                  <th id="t_colTime2">–í—Ä–µ–º—è</th>
                  <th id="t_colPc2">–ü–ö</th>
                  <th id="t_colNick2">–ù–∏–∫</th>
                  <th id="t_colNote2">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                </tr>
              </thead>
              <tbody id="todayTable"></tbody>
            </table>
          </div>
        </div>

        <!-- ADMIN -->
        <div id="adminBox" class="hide" style="margin-top:14px">
          <div class="notice">
            <b>Admin</b> ‚Äî –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –±—Ä–æ–Ω–µ–π
            <div class="row" style="margin-top:10px">
              <div>
                <label>–†–µ–∂–∏–º</label>
                <select id="adminMode">
                  <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                  <option value="date">–í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞</option>
                </select>
              </div>
              <div>
                <label>–î–∞—Ç–∞</label>
                <input id="adminDate" type="date" />
              </div>
            </div>

            <div class="row">
              <div>
                <label>–ü–æ–∏—Å–∫</label>
                <input id="adminSearch" type="text" placeholder="–Ω–∏–∫ / pc / email" />
              </div>
              <div>
                <label>–õ–∏–º–∏—Ç</label>
                <select id="adminLimit">
                  <option value="50">50</option>
                  <option value="100" selected>100</option>
                  <option value="200">200</option>
                </select>
              </div>
            </div>

            <div class="btns">
              <button class="ghost" id="refreshAdminBtn" type="button">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
              <button class="danger" id="adminCloseBtn" type="button">üö™ –ó–∞–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω</button>
            </div>
            <div class="mut" id="adminHint" style="margin-top:8px">‚Äî</div>
          </div>

          <div class="tablewrap">
            <table>
              <thead>
                <tr>
                  <th>–î–∞—Ç–∞</th>
                  <th>–í—Ä–µ–º—è</th>
                  <th>–ü–ö</th>
                  <th>–ù–∏–∫</th>
                  <th>User</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="adminTable"></tbody>
            </table>
          </div>
        </div>

        <div class="footerbar">
          <div><span class="kbd">Esc</span> ‚Äî –∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–∞</div>
          <div class="btns" style="margin:0">
            <button class="mini ghost" id="openAdminBtn" type="button">üîê Admin</button>
          </div>
        </div>

      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="hd">
        <h2 id="t_sideTitle">–ü–æ–¥—Å–∫–∞–∑–∫–∞</h2>
        <div class="hint" id="t_sideHint">–¥–ª—è –∏–≥—Ä–æ–∫–æ–≤</div>
      </div>
      <div class="bd">
        <div class="notice" id="helpBox">‚úÖ –í–æ–π—Ç–∏ ‚Üí –ü–ö ‚Üí –î–∞—Ç–∞/–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Üí –í—Ä–µ–º—è ‚Üí –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å.</div>
        <div style="height:12px"></div>
        <div class="notice" id="rulesBox">
          <b id="t_important">–í–∞–∂–Ω–æ</b><br/>
          ‚Ä¢ –ù–∞ –æ–¥–Ω–æ–º –ü–ö –Ω–µ–ª—å–∑—è –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è<br/>
          ‚Ä¢ –ù–æ—á–Ω—ã–µ —Å–ª–æ—Ç—ã –æ—Ç–º–µ—á–µ–Ω—ã (+1)<br/>
          ‚Ä¢ Firebase —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ <b>http(s)</b> (–Ω–µ file:///)
        </div>
        <div style="height:12px"></div>
        <div class="notice" id="adblockBox">
          <b>–ï—Å–ª–∏ –≤ Console –≤–∏–¥–∏—à—å</b> <span class="kbd">ERR_BLOCKED_BY_CLIENT</span> ‚Äî –∑–Ω–∞—á–∏—Ç –±–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫ —Ä–µ–∫–ª–∞–º—ã –≤—Å—ë –µ—â—ë —Ä–µ–∂–µ—Ç Firestore.
          –û—Ç–∫–ª—é—á–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –¥–ª—è —Å–∞–π—Ç–∞.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- AUTH MODAL -->
<div class="backdrop" id="authBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="mh">
      <div>
        <b id="t_authModal">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</b>
        <div class="mut" id="t_authModal2">Email + –ø–∞—Ä–æ–ª—å</div>
      </div>
      <button id="authCloseBtn" type="button">‚úñ</button>
    </div>
    <div class="mb">
      <div class="row">
        <div>
          <label id="t_email">Email</label>
          <input id="authEmail" type="email" placeholder="email@example.com" />
        </div>
        <div>
          <label id="t_pass">Password</label>
          <input id="authPass" type="password" placeholder="******" />
        </div>
      </div>
      <div class="btns">
        <button class="primary" id="doLoginBtn" type="button"><span id="t_login2">–í–æ–π—Ç–∏</span></button>
        <button class="ghost" id="doRegisterBtn" type="button"><span id="t_register2">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span></button>
        <button class="ghost" id="forgotBtn" type="button">üîÅ <span id="t_forgot">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</span></button>
      </div>
      <div class="notice" style="margin-top:10px" id="authModalMsg">‚Äî</div>
    </div>
  </div>
</div>

<!-- SUCCESS -->
<div class="successBackdrop" id="successBackdrop" aria-hidden="true">
  <div class="successCard">
    <div class="confetti" id="confetti"></div>
    <div class="successTop">
      <b id="succTitle">‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ</b>
      <button type="button" id="succClose">‚úñ</button>
    </div>
    <div class="successBody">
      <div class="bigCheck">‚úî</div>
      <div class="successInfo" id="succInfo"></div>
      <div class="successActions">
        <button class="primary" type="button" id="succMy">üë§ <span id="t_succMy">–ú–æ–∏ –±—Ä–æ–Ω–∏</span></button>
        <button class="ghost" type="button" id="succAgain">‚ûï <span id="t_succAgain">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë</span></button>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // =========================
  // FIREBASE CONFIG
  // =========================
  const firebaseConfig = {
    apiKey: "AIzaSyDJ-5e_xLPW9PnYT66ENey_Ndh8HJdI5wc",
    authDomain: "sakompiutere-gaming.firebaseapp.com",
    projectId: "sakompiutere-gaming",
    storageBucket: "sakompiutere-gaming.firebasestorage.app",
    messagingSenderId: "508996154674",
    appId: "1:508996154674:web:0b6e475d284c49ba80d32b",
    measurementId: "G-H2HKS025KH"
  };

  // =========================
  // CLUB CONFIG
  // =========================
  const PCs = ["Bishop","Godzilla","Elf","Kadita","Orc","Lancelot","Fantomas","Soultaker","Pudge","Kratos"];
  const SLOT_STEP_MIN = 30;

  const WORKING_HOURS_ENABLED = true;
  const WORK_START = "10:00";
  const WORK_END = "03:00"; // crosses midnight

  const ADMIN_EMAILS = [
    "adjarelispeak@gmail.com",
    "kiralite93@gmail.com",
  ].map(x => String(x).toLowerCase());

  // =========================
  // HELPERS
  // =========================
  const $ = (id)=>document.getElementById(id);
  const pad2 = (n)=>String(n).padStart(2,"0");
  const toISODate = (d)=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const parseISODate = (iso)=>{ const [y,m,dd]=iso.split("-").map(Number); return new Date(y,m-1,dd,0,0,0,0); };
  const minutesFromHHMM = (t)=>{ const [h,m]=t.split(":").map(Number); return h*60+m; };
  const hhmmFromMinutes = (min)=>{ min=((min%1440)+1440)%1440; const h=Math.floor(min/60), m=min%60; return `${pad2(h)}:${pad2(m)}`; };
  const addDays = (d, days)=>{ const x=new Date(d); x.setDate(x.getDate()+days); return x; };

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function overlapsMs(a1,a2,b1,b2){ return Math.max(a1,b1) < Math.min(a2,b2); }

  function setCloud(text, ok=true){
    $("cloudPill").textContent = text;
    const dot = $("cloudDot");
    dot.classList.remove("ok","err");
    dot.classList.add(ok ? "ok" : "err");
  }

  function setMsg(html, kind="info"){
    const el = $("msgBox");
    el.innerHTML = html;
    el.style.borderColor =
      kind==="good" ? "rgba(52,211,153,.45)" :
      kind==="bad" ? "rgba(251,113,133,.55)" :
      kind==="warn" ? "rgba(251,191,36,.55)" :
      "rgba(110,231,255,.35)";
    el.style.background =
      kind==="good" ? "rgba(52,211,153,.08)" :
      kind==="bad" ? "rgba(251,113,133,.08)" :
      kind==="warn" ? "rgba(251,191,36,.10)" :
      "rgba(110,231,255,.06)";
  }

  function show(el){ el.classList.remove("hide"); }
  function hide(el){ el.classList.add("hide"); }
  function openModal(){ $("authBackdrop").classList.add("show"); }
  function closeModal(){ $("authBackdrop").classList.remove("show"); }

  function isPermissionError(e){
    const msg = String(e?.message || e || "");
    return msg.toLowerCase().includes("permission") || msg.includes("PERMISSION_DENIED") || msg.includes("Missing or insufficient permissions");
  }
  function isBlockedByClient(e){
    const msg = String(e?.message || e || "");
    return msg.includes("ERR_BLOCKED_BY_CLIENT");
  }

  // =========================
  // i18n (UI text only)
  // =========================
  const LANG_KEY = "sg_lang";
  let lang = localStorage.getItem(LANG_KEY) || "ru";

  const T = {
    ru: {
      title:"Sakompiutere Gaming ‚Äî Booking",
      sub:"–ü–ö ‚Üí –î–∞—Ç–∞/–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Üí –í—Ä–µ–º—è ‚Üí –ì–æ—Ç–æ–≤–æ",
      user:"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
      status:"–°—Ç–∞—Ç—É—Å",
      main:"–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ",
      hintTop:"–û–±—â–∞—è –±–∞–∑–∞ (Firebase)",
      authTitle:"–ê–∫–∫–∞—É–Ω—Ç",
      authDesc:"–ß—Ç–æ–±—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å ‚Äî –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏.",
      login:"–í–æ–π—Ç–∏",
      register:"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è",
      logout:"–í—ã–π—Ç–∏",
      flowTitle:"–ë—ã—Å—Ç—Ä–æ",
      flow1:"1) –í–æ–π–¥–∏",
      flow2:"2) –í—ã–±–µ—Ä–∏ –ü–ö",
      flow3:"3) –î–∞—Ç—É + –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
      flow4:"4) –í—Ä–µ–º—è ‚Üí –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å",
      nickLabel:"–ù–∏–∫ (–≤ –∫–ª—É–±–µ)",
      dateLabel:"–î–∞—Ç–∞ (–∫–ª—É–±–Ω—ã–π –¥–µ–Ω—å)",
      duration:"–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
      noteLabel:"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü.)",
      pickpc:"–í—ã–±–µ—Ä–∏ –ü–ö (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ):",
      timeTitle:"–í—Ä–µ–º—è",
      nextFree:"–°–ª–µ–¥—É—é—â–∏–π —Å–≤–æ–±–æ–¥–Ω—ã–π",
      refresh:"–û–±–Ω–æ–≤–∏—Ç—å",
      timeHintIdle:"–í—ã–±–µ—Ä–∏ –ü–ö + –¥–∞—Ç—É + –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî –ø–æ—è–≤—è—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç–∞—Ä—Ç—ã.",
      timeHintPick:"–í—ã–±–µ—Ä–∏ —Å—Ç–∞—Ä—Ç (‚úÖ —Å–≤–æ–±–æ–¥–Ω–æ / ‚õî –∑–∞–Ω—è—Ç–æ).",
      bookNow:"–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å",
      my:"–ú–æ–∏ –±—Ä–æ–Ω–∏",
      today:"–°–µ–≥–æ–¥–Ω—è",
      close:"–ó–∞–∫—Ä—ã—Ç—å",
      colDate:"–î–∞—Ç–∞",
      colTime:"–í—Ä–µ–º—è",
      colPc:"–ü–ö",
      colNote:"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",
      colAct:"–î–µ–π—Å—Ç–≤–∏—è",
      sideTitle:"–ü–æ–¥—Å–∫–∞–∑–∫–∞",
      sideHint:"–¥–ª—è –∏–≥—Ä–æ–∫–æ–≤",
      important:"–í–∞–∂–Ω–æ",
      authModal:"–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è",
      authModal2:"Email + –ø–∞—Ä–æ–ª—å",
      forgot:"–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?",
      succTitle:"‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ",
      succMy:"–ú–æ–∏ –±—Ä–æ–Ω–∏",
      succAgain:"–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë",
      msg:{
        needHttps:"Firebase —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ http(s). –û—Ç–∫—Ä–æ–π —Å–∞–π—Ç —á–µ—Ä–µ–∑ —Ö–æ—Å—Ç–∏–Ω–≥ (Firebase Hosting / Vercel / Netlify).",
        loginFirst:"–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏.",
        enterNick:"–í–≤–µ–¥–∏ –Ω–∏–∫.",
        pickDate:"–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É.",
        pickPc:"–í—ã–±–µ—Ä–∏ –ü–ö.",
        pickTime:"–í—ã–±–µ—Ä–∏ —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è.",
        past:"–ù–µ–ª—å–∑—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º.",
        loading:"–ó–∞–≥—Ä—É–∂–∞—é –±—Ä–æ–Ω–∏‚Ä¶",
        creating:"–°–æ–∑–¥–∞—é –±—Ä–æ–Ω—å‚Ä¶",
        ok:"üéâ –£—Å–ø–µ—à–Ω–æ! –ë—Ä–æ–Ω—å —Å–æ–∑–¥–∞–Ω–∞.",
        overlap:"‚õî –≠—Ç–æ—Ç —Å–ª–æ—Ç —É–∂–µ –∑–∞–Ω—è–ª–∏. –í—ã–±–µ—Ä–∏ –¥—Ä—É–≥–æ–π.",
        rules:"‚õî –ù–µ—Ç –ø—Ä–∞–≤ (Firestore Rules).",
        blocked:"‚õî –ó–∞–ø—Ä–æ—Å—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º (ERR_BLOCKED_BY_CLIENT). –û—Ç–∫–ª—é—á–∏ AdBlock/Brave Shields.",
        generic:"–û—à–∏–±–∫–∞. –û—Ç–∫—Ä–æ–π Console (F12) –∏ –ø—Ä–∏—à–ª–∏ –æ–¥–Ω—É –∫—Ä–∞—Å–Ω—É—é —Å—Ç—Ä–æ–∫—É.",
        canceled:"–û—Ç–º–µ–Ω–µ–Ω–æ.",
        deleted:"–£–¥–∞–ª–µ–Ω–æ.",
        notAdmin:"–¢—ã –Ω–µ –∞–¥–º–∏–Ω (ADMIN_EMAILS)."
      }
    },
    en: {
      title:"Sakompiutere Gaming ‚Äî Booking",
      sub:"PC ‚Üí Date/Duration ‚Üí Time ‚Üí Done",
      user:"User",
      status:"Status",
      main:"Booking",
      hintTop:"Shared database (Firebase)",
      authTitle:"Account",
      authDesc:"Login required to book.",
      login:"Login",
      register:"Register",
      logout:"Logout",
      flowTitle:"Quick",
      flow1:"1) Login",
      flow2:"2) Pick PCs",
      flow3:"3) Date + duration",
      flow4:"4) Time ‚Üí Book",
      nickLabel:"Nickname (club)",
      dateLabel:"Date (club day)",
      duration:"Duration",
      noteLabel:"Note (optional)",
      pickpc:"Pick PCs (multi-select):",
      timeTitle:"Time",
      nextFree:"Next free",
      refresh:"Refresh",
      timeHintIdle:"Pick PCs + date + duration ‚Äî available start times will appear.",
      timeHintPick:"Pick a start time (‚úÖ free / ‚õî busy).",
      bookNow:"Book now",
      my:"My bookings",
      today:"Today",
      close:"Close",
      colDate:"Date",
      colTime:"Time",
      colPc:"PC",
      colNote:"Note",
      colAct:"Actions",
      sideTitle:"Help",
      sideHint:"for players",
      important:"Important",
      authModal:"Login / Register",
      authModal2:"Email + password",
      forgot:"Forgot password?",
      succTitle:"‚úÖ Booking successful",
      succMy:"My bookings",
      succAgain:"Book again",
      msg:{
        needHttps:"Firebase works only on http(s). Open via hosting (Firebase Hosting / Vercel / Netlify).",
        loginFirst:"Please login first.",
        enterNick:"Enter nickname.",
        pickDate:"Pick a date.",
        pickPc:"Pick PCs.",
        pickTime:"Pick a free time.",
        past:"Cannot book in the past.",
        loading:"Loading bookings‚Ä¶",
        creating:"Creating booking‚Ä¶",
        ok:"üéâ Success! Booking created.",
        overlap:"‚õî Slot already taken. Pick another.",
        rules:"‚õî No permission (Firestore Rules).",
        blocked:"‚õî Requests are blocked by extension (ERR_BLOCKED_BY_CLIENT). Disable AdBlock/Brave Shields.",
        generic:"Error. Open Console (F12) and send one red line.",
        canceled:"Canceled.",
        deleted:"Deleted.",
        notAdmin:"You are not admin (ADMIN_EMAILS)."
      }
    },
    ka: {
      title:"Sakompiutere Gaming ‚Äî Booking",
      sub:"PC ‚Üí ·Éó·Éê·É†·Éò·É¶·Éò/·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éù·Éë·Éê ‚Üí ·Éì·É†·Éù ‚Üí ·Éõ·Éñ·Éê·Éì·Éê·Éê",
      user:"·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò",
      status:"·É°·É¢·Éê·É¢·É£·É°·Éò",
      main:"·ÉØ·Éê·Éï·É®·Éê·Éú·Éò",
      hintTop:"·É°·Éê·Éî·É†·Éó·Éù ·Éë·Éê·Éñ·Éê (Firebase)",
      authTitle:"·Éê·É•·Éê·É£·Éú·Éó·Éò",
      authDesc:"·ÉØ·Éê·Éï·É®·Éú·Éò·É°·Éó·Éï·Éò·É° ·É°·Éê·É≠·Éò·É†·Éù·Éê ·É®·Éî·É°·Éï·Éö·Éê.",
      login:"·É®·Éî·É°·Éï·Éö·Éê",
      register:"·É†·Éî·Éí·Éò·É°·É¢·É†·Éê·É™·Éò·Éê",
      logout:"·Éí·Éê·É°·Éï·Éö·Éê",
      flowTitle:"·É°·É¨·É†·Éê·É§·Éê·Éì",
      flow1:"1) ·É®·Éî·Éì·Éò",
      flow2:"2) ·Éê·Éò·É†·É©·Éò·Éî PC",
      flow3:"3) ·Éó·Éê·É†·Éò·É¶·Éò + ·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éù·Éë·Éê",
      flow4:"4) ·Éì·É†·Éù ‚Üí ·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éê",
      nickLabel:"·Éú·Éò·Éô·Éò (·Éô·Éö·É£·Éë·É®·Éò)",
      dateLabel:"·Éó·Éê·É†·Éò·É¶·Éò (·Éô·Éö·É£·Éë·Éò·É° ·Éì·É¶·Éî)",
      duration:"·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éù·Éë·Éê",
      noteLabel:"·É®·Éî·Éú·Éò·É®·Éï·Éú·Éê (·Éê·É†·Éê·É°·Éê·Éï·Éê·Éö·Éì.)",
      pickpc:"·Éê·Éò·É†·É©·Éò·Éî PC-·Éî·Éë·Éò (·É†·Éê·Éõ·Éì·Éî·Éú·Éò·Éõ·Éî ·É®·Éî·Éò·É´·Éö·Éî·Éë·Éê):",
      timeTitle:"·Éì·É†·Éù",
      nextFree:"·É®·Éî·Éõ·Éì·Éî·Éí·Éò ·Éó·Éê·Éï·Éò·É°·É£·É§·Éê·Éö·Éò",
      refresh:"·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éî·Éë·Éê",
      timeHintIdle:"·Éê·Éò·É†·É©·Éò·Éî PC + ·Éó·Éê·É†·Éò·É¶·Éò + ·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éù·Éë·Éê ‚Äî ·Éí·Éê·Éõ·Éù·É©·Éú·Éì·Éî·Éë·Éê ·Éì·É†·Éù·Éî·Éë·Éò.",
      timeHintPick:"·Éê·Éò·É†·É©·Éò·Éî ·Éì·Éê·É¨·Éß·Éî·Éë·Éê (‚úÖ ·Éó·Éê·Éï·Éò·É°·É£·É§·Éê·Éö·Éò / ‚õî ·Éì·Éê·Éô·Éê·Éï·Éî·Éë·É£·Éö·Éò).",
      bookNow:"·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éê",
      my:"·É©·Éî·Éõ·Éò ·ÉØ·Éê·Éï·É®·Éú·Éî·Éë·Éò",
      today:"·Éì·É¶·Éî·É°",
      close:"·Éì·Éê·ÉÆ·É£·É†·Éï·Éê",
      colDate:"·Éó·Éê·É†·Éò·É¶·Éò",
      colTime:"·Éì·É†·Éù",
      colPc:"PC",
      colNote:"·É®·Éî·Éú·Éò·É®·Éï·Éú·Éê",
      colAct:"·É•·Éõ·Éî·Éì·Éî·Éë·Éê",
      sideTitle:"·Éì·Éê·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éê",
      sideHint:"·Éõ·Éù·Éó·Éê·Éõ·Éê·É®·Éî·Éî·Éë·Éò·É°·Éó·Éï·Éò·É°",
      important:"·Éõ·Éú·Éò·É®·Éï·Éú·Éî·Éö·Éù·Éï·Éê·Éú·Éò·Éê",
      authModal:"·É®·Éî·É°·Éï·Éö·Éê / ·É†·Éî·Éí·Éò·É°·É¢·É†·Éê·É™·Éò·Éê",
      authModal2:"Email + ·Éû·Éê·É†·Éù·Éö·Éò",
      forgot:"·Éû·Éê·É†·Éù·Éö·Éò ·Éì·Éê·Éí·Éê·Éï·Éò·É¨·Éß·Éì·Éê?",
      succTitle:"‚úÖ ·ÉØ·Éê·Éï·É®·Éê·Éú·Éò ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·É£·Éö·Éò·Éê",
      succMy:"·É©·Éî·Éõ·Éò ·ÉØ·Éê·Éï·É®·Éú·Éî·Éë·Éò",
      succAgain:"·Éô·Éò·Éì·Éî·Éï ·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éê",
      msg:{
        needHttps:"Firebase ·Éõ·É£·É®·Éê·Éù·Éë·É° ·Éõ·ÉÆ·Éù·Éö·Éù·Éì http(s)-·Éñ·Éî. ·Éí·Éê·ÉÆ·É°·Éî·Éú·Éò ·É∞·Éù·É°·É¢·Éò·Éú·Éí·Éò·Éó (Firebase Hosting / Vercel / Netlify).",
        loginFirst:"·ÉØ·Éî·É† ·É®·Éî·Éì·Éò.",
        enterNick:"·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éî ·Éú·Éò·Éô·Éò.",
        pickDate:"·Éê·Éò·É†·É©·Éò·Éî ·Éó·Éê·É†·Éò·É¶·Éò.",
        pickPc:"·Éê·Éò·É†·É©·Éò·Éî PC.",
        pickTime:"·Éê·Éò·É†·É©·Éò·Éî ·Éó·Éê·Éï·Éò·É°·É£·É§·Éê·Éö·Éò ·Éì·É†·Éù.",
        past:"·É¨·Éê·É†·É°·É£·Éö·É®·Éò ·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éê ·Éê·É† ·É®·Éî·Éò·É´·Éö·Éî·Éë·Éê.",
        loading:"·Éï·É¢·Éï·Éò·É†·Éó·Éê·Éï ·ÉØ·Éê·Éï·É®·Éú·Éî·Éë·É°‚Ä¶",
        creating:"·Éï·É•·Éõ·Éú·Éò ·ÉØ·Éê·Éï·É®·Éê·Éú·É°‚Ä¶",
        ok:"üéâ ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éê! ·ÉØ·Éê·Éï·É®·Éê·Éú·Éò ·É®·Éî·Éò·É•·Éõ·Éú·Éê.",
        overlap:"‚õî ·Éì·É†·Éù ·Éì·Éê·Éô·Éê·Éï·Éî·Éë·É£·Éö·Éò·Éê. ·Éê·Éò·É†·É©·Éò·Éî ·É°·ÉÆ·Éï·Éê.",
        rules:"‚õî ·É¨·Éï·Éì·Éù·Éõ·Éê ·Éê·É† ·Éê·É†·Éò·É° (Firestore Rules).",
        blocked:"‚õî ·Éõ·Éù·Éó·ÉÆ·Éù·Éï·Éú·Éî·Éë·Éò ·Éë·Éö·Éù·Éô·Éì·Éî·Éë·Éê (ERR_BLOCKED_BY_CLIENT). ·Éí·Éê·Éõ·Éù·É†·Éó·Éî AdBlock/Brave Shields.",
        generic:"·É®·Éî·É™·Éì·Éù·Éõ·Éê. ·Éí·Éê·ÉÆ·É°·Éî·Éú·Éò Console (F12) ·Éì·Éê ·Éí·Éê·Éõ·Éù·Éõ·Éò·Éí·Éñ·Éê·Éï·Éú·Éî 1 ·É¨·Éò·Éó·Éî·Éö·Éò ·ÉÆ·Éê·Éñ·Éò.",
        canceled:"·Éí·Éê·É£·É•·Éõ·Éì·Éê.",
        deleted:"·É¨·Éê·Éò·É®·Éê·Éö·Éê.",
        notAdmin:"Admin ·Éê·É† ·ÉÆ·Éê·É† (ADMIN_EMAILS)."
      }
    }
  };

  function tr(key){
    const dict = T[lang] || T.ru;
    const parts = key.split(".");
    let cur = dict;
    for(const p of parts){
      cur = (cur && cur[p]!=null) ? cur[p] : null;
    }
    return cur == null ? (T.ru?.[key] ?? key) : cur;
  }

  function applyLang(){
    document.title = tr("title");
    $("t_title").textContent = tr("title");
    $("t_sub").textContent = tr("sub");
    $("t_user").textContent = tr("user");
    $("t_status").textContent = tr("status");
    $("t_main").textContent = tr("main");
    $("hintTop").textContent = tr("hintTop");

    $("t_authTitle").textContent = tr("authTitle");
    $("t_authDesc").textContent = tr("authDesc");
    $("t_login").textContent = tr("login");
    $("t_register").textContent = tr("register");
    $("t_logout").textContent = tr("logout");

    $("t_flowTitle").textContent = tr("flowTitle");
    $("t_flow1").textContent = tr("flow1");
    $("t_flow2").textContent = tr("flow2");
    $("t_flow3").textContent = tr("flow3");
    $("t_flow4").textContent = tr("flow4");

    $("t_nickLabel").textContent = tr("nickLabel");
    $("t_dateLabel").textContent = tr("dateLabel");
    $("t_duration").textContent = tr("duration");
    $("t_noteLabel").textContent = tr("noteLabel");
    $("t_pickpc").textContent = tr("pickpc");

    $("t_timeTitle").textContent = tr("timeTitle");
    $("t_nextFree").textContent = tr("nextFree");
    $("t_refresh").textContent = tr("refresh");

    $("t_bookNow").textContent = tr("bookNow");
    $("t_my").textContent = tr("my");
    $("t_today").textContent = tr("today");
    $("t_close").textContent = tr("close");
    $("t_close2").textContent = tr("close");

    $("t_colDate").textContent = tr("colDate");
    $("t_colTime").textContent = tr("colTime");
    $("t_colPc").textContent = tr("colPc");
    $("t_colNote").textContent = tr("colNote");
    $("t_colAct").textContent = tr("colAct");

    $("t_sideTitle").textContent = tr("sideTitle");
    $("t_sideHint").textContent = tr("sideHint");
    $("t_important").textContent = tr("important");

    $("t_authModal").textContent = tr("authModal");
    $("t_authModal2").textContent = tr("authModal2");
    $("t_forgot").textContent = tr("forgot");
    $("t_login2").textContent = tr("login");
    $("t_register2").textContent = tr("register");

    $("succTitle").textContent = tr("succTitle");
    $("t_succMy").textContent = tr("succMy");
    $("t_succAgain").textContent = tr("succAgain");

    $("lang_ru").classList.toggle("active", lang==="ru");
    $("lang_en").classList.toggle("active", lang==="en");
    $("lang_ka").classList.toggle("active", lang==="ka");

    updateTimeHint();
  }

  // =========================
  // FIREBASE INIT
  // =========================
  let app, auth, db;
  let currentUser = null;
  let isAdmin = false;

  try{
    app = firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.firestore();
    setCloud("OK", true);
  }catch(e){
    console.error(e);
    setCloud("ERROR", false);
    setMsg("Firebase init error. Open Console (F12).", "bad");
    return;
  }

  // =========================
  // TIME / SLOTS (club day window)
  // =========================
  const wsMin = minutesFromHHMM(WORK_START);
  const weMin = minutesFromHHMM(WORK_END);
  const crossesMidnight = WORKING_HOURS_ENABLED && (weMin <= wsMin);

  function segments(){
    if(!WORKING_HOURS_ENABLED) return [{a:0,b:1440,nextDay:false}];
    if(!crossesMidnight) return [{a:wsMin,b:weMin,nextDay:false}];
    return [
      {a:wsMin,b:1440,nextDay:false},
      {a:0,b:weMin,nextDay:true},
    ];
  }

  function dateTimeFromBase(baseDateISO, minutes, nextDay){
    const base = parseISODate(baseDateISO);
    const actual = nextDay ? addDays(base, 1) : base;
    return new Date(actual.getFullYear(), actual.getMonth(), actual.getDate(),
      Math.floor(minutes/60), minutes%60, 0, 0);
  }

  // =========================
  // UI STATE
  // =========================
  let selectedPCs = new Set();
  let selectedSlot = null; // {startMin,endMin,nextDay,label,startAtMs,endAtMs}
  let cachedDayBookings = []; // bookings for selected baseDate
  let unsubRealtime = null;

  function renderPCs(){
    const grid = $("pcGrid");
    grid.innerHTML = "";
    for(const pc of PCs){
      const div = document.createElement("div");
      div.className = "pc" + (selectedPCs.has(pc) ? " selected" : "");
      div.innerHTML = `
        <div class="check">‚úì</div>
        <div class="name">${pc}</div>
        <div class="meta">${selectedPCs.has(pc) ? "Selected" : "Tap to select"}</div>
      `;
      div.addEventListener("click", ()=>{
        if(selectedPCs.has(pc)) selectedPCs.delete(pc);
        else selectedPCs.add(pc);
        renderPCs();
        rebuildSlots();
      });
      grid.appendChild(div);
    }
  }

  function updateTimeHint(){
    const baseDate = $("date").value;
    const dur = Number($("duration").value || 60);
    if(!baseDate || !dur || selectedPCs.size===0){
      $("timeHint").textContent = tr("timeHintIdle");
    }else{
      $("timeHint").textContent = tr("timeHintPick");
    }
  }

  function slotBusyMs(startAtMs, endAtMs){
    for(const b of cachedDayBookings){
      if(!selectedPCs.has(String(b.pc||""))) continue;
      const bs = Number(b.startAtMs||0);
      const be = Number(b.endAtMs||0);
      if(overlapsMs(startAtMs,endAtMs,bs,be)) return true;
    }
    return false;
  }

  function rebuildSlots(){
    const list = $("timeList");
    list.innerHTML = "";
    selectedSlot = null;
    $("pickedSummary").innerHTML = `<b>‚Äî</b>`;
    $("createBtn").disabled = true;

    const baseDate = $("date").value;
    const dur = Number($("duration").value || 60);
    if(!baseDate || selectedPCs.size===0){
      updateTimeHint();
      return;
    }

    const nowMs = Date.now();
    for(const seg of segments()){
      for(let s=seg.a; s+dur<=seg.b; s+=SLOT_STEP_MIN){
        const e = s+dur;
        const startAt = dateTimeFromBase(baseDate, s, seg.nextDay);
        const endAt   = dateTimeFromBase(baseDate, e, seg.nextDay);
        const startAtMs = startAt.getTime();
        const endAtMs = endAt.getTime();

        const label = `${hhmmFromMinutes(s)} ‚Üí ${hhmmFromMinutes(e)}${seg.nextDay ? " (+1)" : ""}`;
        const busy = slotBusyMs(startAtMs, endAtMs);
        const past = startAtMs < nowMs;

        const btn = document.createElement("div");
        btn.className = "tbtn" + (busy ? " busy" : "") + (past ? " past" : "");
        btn.textContent = busy ? `‚õî ${label}` : past ? `‚Äî ${label}` : `‚úÖ ${label}`;

        btn.addEventListener("click", ()=>{
          if(busy || past) return;
          selectedSlot = {startMin:s,endMin:e,nextDay:seg.nextDay,label,startAtMs,endAtMs};

          [...list.children].forEach(x=>x.classList.remove("active"));
          btn.classList.add("active");

          $("pickedSummary").innerHTML =
            `<b>${escapeHtml(label)}</b> ‚Ä¢ ${escapeHtml(Array.from(selectedPCs).join(", "))}`;

          $("createBtn").disabled = false;
          setMsg(`${escapeHtml(tr("msg.pickTime"))}<br/><b>${escapeHtml(label)}</b>`, "info");
        });

        list.appendChild(btn);
      }
    }

    updateTimeHint();
  }

  function pickNextFree(){
    const btns = [...$("timeList").querySelectorAll(".tbtn")];
    const first = btns.find(b => !b.classList.contains("busy") && !b.classList.contains("past"));
    if(first){ first.click(); return true; }
    return false;
  }

  // =========================
  // REALTIME (by baseDate)
  // =========================
  function stopRealtime(){
    if(unsubRealtime){ try{unsubRealtime();}catch(e){} unsubRealtime=null; }
  }

  function startRealtime(baseDateISO){
    stopRealtime();
    if(!baseDateISO) return;

    setMsg(tr("msg.loading"), "info");

    unsubRealtime = db.collection("bookings")
      .where("baseDate","==", String(baseDateISO))
      .onSnapshot((snap)=>{
        cachedDayBookings = snap.docs.map(d=>({id:d.id, ...d.data()}));
        setMsg("‚Äî", "info");
        rebuildSlots();
      }, (e)=>{
        console.error(e);
        cachedDayBookings = [];
        rebuildSlots();

        if(isBlockedByClient(e)) {
          setCloud("BLOCK", false);
          setMsg(tr("msg.blocked"), "bad");
          return;
        }

        if(isPermissionError(e)){
          setCloud("RULES", false);
          setMsg(tr("msg.rules"), "bad");
        }else{
          setCloud("ERR", false);
          setMsg(tr("msg.generic"), "bad");
        }
      });
  }

  // =========================
  // PROFILE (primitives only)
  // =========================
  async function upsertNick(uid, nick){
    const safe = String(nick||"").trim().slice(0,32);
    if(!safe) return;
    await db.collection("users").doc(String(uid)).set({
      nick: safe,
      updatedAtMs: Date.now()
    }, {merge:true});
  }

  async function loadNick(uid){
    const doc = await db.collection("users").doc(String(uid)).get();
    return doc.exists ? String(doc.data().nick||"") : "";
  }

  function updateAuthUI(){
    $("logoutBtn").classList.toggle("hide", !currentUser);
    $("openAuthBtn").classList.toggle("hide", !!currentUser);
    $("userPill").textContent = currentUser ? (currentUser.email || currentUser.uid.slice(0,6)) : "‚Äî";

    const email = String(currentUser?.email || "").toLowerCase();
    isAdmin = !!(currentUser && ADMIN_EMAILS.includes(email));
    hide($("adminBox"));
  }

  // =========================
  // SUCCESS UI
  // =========================
  function makeConfetti(){
    const wrap = $("confetti");
    wrap.innerHTML = "";
    const colors = [
      "rgba(110,231,255,.95)",
      "rgba(167,139,250,.95)",
      "rgba(52,211,153,.95)",
      "rgba(251,191,36,.95)"
    ];
    const count = 28;
    for(let i=0;i<count;i++){
      const el = document.createElement("i");
      el.style.left = (Math.random()*100)+"%";
      el.style.top = (-10 - Math.random()*30) + "px";
      el.style.width = (8 + Math.random()*10) + "px";
      el.style.height = (10 + Math.random()*18) + "px";
      el.style.background = colors[Math.floor(Math.random()*colors.length)];
      el.style.animationDelay = (Math.random()*180) + "ms";
      el.style.animationDuration = (750 + Math.random()*550) + "ms";
      wrap.appendChild(el);
    }
    setTimeout(()=>{ wrap.innerHTML=""; }, 1400);
  }

  function showSuccess(detailsHtml){
    $("succInfo").innerHTML = detailsHtml;
    $("successBackdrop").classList.add("show");
    makeConfetti();
  }
  function closeSuccess(){
    $("successBackdrop").classList.remove("show");
    $("confetti").innerHTML = "";
  }

  // =========================
  // CREATE BOOKING (FIXED ‚úÖ)
  // - NO FieldValue/serverTimestamp (was causing Pd object errors)
  // - Uses selectedSlot ONLY (fixes null startAtMs error)
  // - Transaction reads baseDate docs once (no composite index required)
  // =========================
  async function createBooking(){
    if(!currentUser){ setMsg(tr("msg.loginFirst"), "bad"); return; }

    const nick = String(($("nick").value||"")).trim();
    const baseDate = String($("date").value||"");
    const note = String(($("note").value||"")).trim();

    if(!nick){ setMsg(tr("msg.enterNick"), "bad"); return; }
    if(!baseDate){ setMsg(tr("msg.pickDate"), "bad"); return; }
    if(selectedPCs.size===0){ setMsg(tr("msg.pickPc"), "bad"); return; }
    if(!selectedSlot){ setMsg(tr("msg.pickTime"), "bad"); return; }

    const startAtMs = Number(selectedSlot.startAtMs||0);
    const endAtMs   = Number(selectedSlot.endAtMs||0);
    if(!startAtMs || !endAtMs){
      setMsg("–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–ª–æ—Ç–∞. –ù–∞–∂–º–∏ –≤—Ä–µ–º—è –µ—â—ë —Ä–∞–∑.", "bad");
      return;
    }
    if(startAtMs < Date.now()){ setMsg(tr("msg.past"), "bad"); return; }

    const pcs = Array.from(selectedPCs);

    $("createBtn").disabled = true;
    setMsg(tr("msg.creating"), "info");

    try{
      try{ await upsertNick(currentUser.uid, nick); }catch(e){}

      await db.runTransaction(async (tx)=>{
        const q = db.collection("bookings").where("baseDate","==", baseDate);
        const snap = await tx.get(q);
        const all = snap.docs.map(d=>({id:d.id, ...d.data()}));

        // check overlap for each selected PC
        for(const pc of pcs){
          for(const b of all){
            if(String(b.pc||"") !== String(pc)) continue;
            const bs = Number(b.startAtMs||0);
            const be = Number(b.endAtMs||0);
            if(overlapsMs(startAtMs,endAtMs,bs,be)){
              throw new Error("OVERLAP");
            }
          }
        }

        // create one doc per pc
        for(const pc of pcs){
          const ref = db.collection("bookings").doc();
          tx.set(ref, {
            uid: String(currentUser.uid),
            userEmail: String(currentUser.email || ""),
            nick: String(nick),
            pc: String(pc),
            baseDate: String(baseDate),
            startMin: Number(selectedSlot.startMin),
            endMin: Number(selectedSlot.endMin),
            note: String(note || ""),
            startAtMs: Number(startAtMs),
            endAtMs: Number(endAtMs),
            createdAtMs: Number(Date.now())
          });
        }
      });

      const start = new Date(startAtMs);
      const end = new Date(endAtMs);
      const timeStr = `${pad2(start.getHours())}:${pad2(start.getMinutes())} ‚Üí ${pad2(end.getHours())}:${pad2(end.getMinutes())}${selectedSlot.nextDay ? " (+1)" : ""}`;

      setMsg(tr("msg.ok") + `<br/>–ü–ö: <b>${escapeHtml(pcs.join(", "))}</b><br/>‚è± <b>${escapeHtml(timeStr)}</b>`, "good");

      showSuccess(`
        <div><b>${lang==="en"?"Nick":lang==="ka"?"·Éú·Éò·Éô·Éò":"–ù–∏–∫"}:</b> ${escapeHtml(nick)}</div>
        <div><b>${lang==="en"?"PCs":lang==="ka"?"PC-·Éî·Éë·Éò":"–ü–ö"}:</b> ${escapeHtml(pcs.join(", "))}</div>
        <div><b>${lang==="en"?"Day":lang==="ka"?"·Éì·É¶·Éî":"–î–µ–Ω—å"}:</b> ${escapeHtml(baseDate)}</div>
        <div><b>${lang==="en"?"Time":lang==="ka"?"·Éì·É†·Éù":"–í—Ä–µ–º—è"}:</b> ${escapeHtml(timeStr)}</div>
        <div><b>${lang==="en"?"Note":lang==="ka"?"·É®·Éî·Éú·Éò·É®·Éï·Éú·Éê":"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"}:</b> ${escapeHtml(note || "‚Äî")}</div>
      `);

      // reset selection
      selectedSlot = null;
      $("pickedSummary").innerHTML = `<b>‚Äî</b>`;
      $("createBtn").disabled = true;

    }catch(e){
      console.error(e);
      $("createBtn").disabled = false;

      if(String(e?.message||"") === "OVERLAP"){
        setMsg(tr("msg.overlap"), "bad");
      }else if(isBlockedByClient(e)){
        setCloud("BLOCK", false);
        setMsg(tr("msg.blocked"), "bad");
      }else if(isPermissionError(e)){
        setCloud("RULES", false);
        setMsg(tr("msg.rules"), "bad");
      }else{
        setMsg(tr("msg.generic"), "bad");
      }
    }
  }

  // =========================
  // LISTS
  // =========================
  async function renderMyBookings(){
    const tbody = $("myTable");
    tbody.innerHTML = "";
    if(!currentUser){
      tbody.innerHTML = `<tr><td colspan="5" style="color:var(--muted)">${lang==="en"?"Login first":lang==="ka"?"·ÉØ·Éî·É† ·É®·Éî·Éì·Éò":"–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏"}</td></tr>`;
      return;
    }
    try{
      const snap = await db.collection("bookings").where("uid","==", String(currentUser.uid)).get();
      let list = snap.docs.map(d=>({id:d.id, ...d.data()}));
      list.sort((a,b)=>Number(a.startAtMs||0)-Number(b.startAtMs||0));
      if(!list.length){
        tbody.innerHTML = `<tr><td colspan="5" style="color:var(--muted)">‚Äî</td></tr>`;
        return;
      }
      for(const b of list){
        const start = new Date(Number(b.startAtMs||0));
        const end = new Date(Number(b.endAtMs||0));
        const timeStr = `${pad2(start.getHours())}:${pad2(start.getMinutes())} ‚Üí ${pad2(end.getHours())}:${pad2(end.getMinutes())}`;
        const trEl = document.createElement("tr");
        trEl.innerHTML = `
          <td>${escapeHtml(String(b.baseDate||""))}</td>
          <td>${escapeHtml(timeStr)}</td>
          <td><b>${escapeHtml(String(b.pc||""))}</b></td>
          <td style="color:var(--muted)">${escapeHtml(String(b.note||""))}</td>
          <td><button class="mini danger" type="button" data-id="${b.id}">${lang==="en"?"Cancel":lang==="ka"?"·Éí·Éê·É£·É•·Éõ·Éî·Éë·Éê":"Cancel"}</button></td>
        `;
        tbody.appendChild(trEl);
      }

      tbody.querySelectorAll("button[data-id]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-id");
          if(!confirm(lang==="en"?"Cancel booking?":lang==="ka"?"·Éí·É°·É£·É†·É° ·Éí·Éê·É£·É•·Éõ·Éî·Éë·Éê?":"–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å?")) return;
          try{
            await db.collection("bookings").doc(id).delete();
            await renderMyBookings();
            rebuildSlots();
            setMsg(tr("msg.canceled"), "good");
          }catch(e){
            console.error(e);
            if(isBlockedByClient(e)) setMsg(tr("msg.blocked"), "bad");
            else if(isPermissionError(e)) setMsg(tr("msg.rules"), "bad");
            else setMsg(tr("msg.generic"), "bad");
          }
        });
      });

    }catch(e){
      console.error(e);
      tbody.innerHTML = `<tr><td colspan="5" style="color:var(--muted)">Load error</td></tr>`;
    }
  }

  async function renderToday(){
    const tbody = $("todayTable");
    tbody.innerHTML = "";
    const todayISO = toISODate(new Date());
    const yISO = toISODate(addDays(new Date(), -1));
    try{
      const [snapA, snapB] = await Promise.all([
        db.collection("bookings").where("baseDate","==", todayISO).get(),
        db.collection("bookings").where("baseDate","==", yISO).get(),
      ]);

      let list = [...snapA.docs, ...snapB.docs].map(d=>({id:d.id, ...d.data()}));
      // show only bookings that START today (real date)
      list = list.filter(b=>{
        const ms = Number(b.startAtMs||0);
        return ms && toISODate(new Date(ms)) === todayISO;
      });
      list.sort((a,b)=>Number(a.startAtMs||0)-Number(b.startAtMs||0));

      if(!list.length){
        tbody.innerHTML = `<tr><td colspan="4" style="color:var(--muted)">‚Äî</td></tr>`;
        return;
      }
      for(const b of list){
        const start = new Date(Number(b.startAtMs||0));
        const end = new Date(Number(b.endAtMs||0));
        const timeStr = `${pad2(start.getHours())}:${pad2(start.getMinutes())} ‚Üí ${pad2(end.getHours())}:${pad2(end.getMinutes())}`;
        const trEl = document.createElement("tr");
        trEl.innerHTML = `
          <td>${escapeHtml(timeStr)}</td>
          <td><b>${escapeHtml(String(b.pc||""))}</b></td>
          <td>${escapeHtml(String(b.nick||""))}</td>
          <td style="color:var(--muted)">${escapeHtml(String(b.note||""))}</td>
        `;
        tbody.appendChild(trEl);
      }
    }catch(e){
      console.error(e);
      if(isBlockedByClient(e)) tbody.innerHTML = `<tr><td colspan="4" style="color:var(--muted)">${escapeHtml(tr("msg.blocked"))}</td></tr>`;
      else if(isPermissionError(e)) tbody.innerHTML = `<tr><td colspan="4" style="color:var(--muted)">${escapeHtml(tr("msg.rules"))}</td></tr>`;
      else tbody.innerHTML = `<tr><td colspan="4" style="color:var(--muted)">Firestore error</td></tr>`;
    }
  }

  async function renderAdmin(){
    if(!isAdmin){ setMsg(tr("msg.notAdmin"), "bad"); return; }
    const tbody = $("adminTable");
    tbody.innerHTML = "";

    const mode = $("adminMode").value;
    const lim = Number($("adminLimit").value||100);
    const q = String($("adminSearch").value||"").trim().toLowerCase();
    const dateISO = String($("adminDate").value||"");

    try{
      let list = [];
      if(mode==="today"){
        const todayISO = toISODate(new Date());
        const yISO = toISODate(addDays(new Date(), -1));
        const [snapA, snapB] = await Promise.all([
          db.collection("bookings").where("baseDate","==", todayISO).get(),
          db.collection("bookings").where("baseDate","==", yISO).get(),
        ]);
        list = [...snapA.docs, ...snapB.docs].map(d=>({id:d.id, ...d.data()}))
          .filter(b=>{
            const ms = Number(b.startAtMs||0);
            return ms && toISODate(new Date(ms)) === todayISO;
          });
        $("adminHint").textContent = lang==="en" ? "Today (by real start date)." : lang==="ka" ? "·Éì·É¶·Éî·É° (·É†·Éî·Éê·Éö·É£·É†·Éò ·Éì·Éê·É¨·Éß·Éî·Éë·Éò·Éó)." : "–°–µ–≥–æ–¥–Ω—è (–ø–æ —Ä–µ–∞–ª—å–Ω–æ–π –¥–∞—Ç–µ —Å—Ç–∞—Ä—Ç–∞).";
      }else{
        if(!dateISO){
          tbody.innerHTML = `<tr><td colspan="6" style="color:var(--muted)">Pick date</td></tr>`;
          return;
        }
        const snap = await db.collection("bookings").where("baseDate","==", dateISO).get();
        list = snap.docs.map(d=>({id:d.id, ...d.data()}));
        $("adminHint").textContent = lang==="en" ? "Selected club day (includes night +1)." : lang==="ka" ? "·Éê·É†·É©·Éî·É£·Éö·Éò ·Éô·Éö·É£·Éë·Éò·É° ·Éì·É¶·Éî (·É¶·Éê·Éõ·Éî +1)." : "–í—ã–±—Ä–∞–Ω–Ω–∞—è –∫–ª—É–±–Ω–∞—è –¥–∞—Ç–∞ (–≤–∫–ª—é—á–∞—è –Ω–æ—á–Ω—ã–µ +1).";
      }

      if(q){
        list = list.filter(b =>
          String(b.nick||"").toLowerCase().includes(q) ||
          String(b.pc||"").toLowerCase().includes(q) ||
          String(b.userEmail||"").toLowerCase().includes(q)
        );
      }

      list.sort((a,b)=>Number(a.startAtMs||0)-Number(b.startAtMs||0));
      list = list.slice(0, lim);

      if(!list.length){
        tbody.innerHTML = `<tr><td colspan="6" style="color:var(--muted)">‚Äî</td></tr>`;
        return;
      }

      for(const b of list){
        const start = new Date(Number(b.startAtMs||0));
        const end = new Date(Number(b.endAtMs||0));
        const timeStr = `${pad2(start.getHours())}:${pad2(start.getMinutes())} ‚Üí ${pad2(end.getHours())}:${pad2(end.getMinutes())}`;
        const trEl = document.createElement("tr");
        trEl.innerHTML = `
          <td>${escapeHtml(String(b.baseDate||""))}</td>
          <td>${escapeHtml(timeStr)}</td>
          <td><b>${escapeHtml(String(b.pc||""))}</b></td>
          <td>${escapeHtml(String(b.nick||""))}</td>
          <td style="color:var(--muted)">${escapeHtml(String(b.userEmail||""))}</td>
          <td><button class="mini danger" type="button" data-id="${b.id}">${lang==="en"?"Delete":lang==="ka"?"·É¨·Éê·É®·Éö·Éê":"Delete"}</button></td>
        `;
        tbody.appendChild(trEl);
      }

      tbody.querySelectorAll("button[data-id]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-id");
          if(!confirm(lang==="en"?"Delete booking?":lang==="ka"?"·É¨·Éê·Éï·É®·Éê·Éö·Éù ·ÉØ·Éê·Éï·É®·Éê·Éú·Éò?":"–£–¥–∞–ª–∏—Ç—å –±—Ä–æ–Ω—å?")) return;
          try{
            await db.collection("bookings").doc(id).delete();
            await renderAdmin();
            rebuildSlots();
            setMsg(tr("msg.deleted"), "good");
          }catch(e){
            console.error(e);
            if(isBlockedByClient(e)) setMsg(tr("msg.blocked"), "bad");
            else if(isPermissionError(e)) setMsg(tr("msg.rules"), "bad");
            else setMsg(tr("msg.generic"), "bad");
          }
        });
      });

    }catch(e){
      console.error(e);
      if(isBlockedByClient(e)) setMsg(tr("msg.blocked"), "bad");
      else if(isPermissionError(e)) setMsg(tr("msg.rules"), "bad");
      else setMsg(tr("msg.generic"), "bad");
    }
  }

  // =========================
  // EVENTS
  // =========================
  function bind(){
    $("lang_ru").onclick = ()=>{ lang="ru"; localStorage.setItem(LANG_KEY, lang); applyLang(); };
    $("lang_en").onclick = ()=>{ lang="en"; localStorage.setItem(LANG_KEY, lang); applyLang(); };
    $("lang_ka").onclick = ()=>{ lang="ka"; localStorage.setItem(LANG_KEY, lang); applyLang(); };

    $("openAuthBtn").onclick = openModal;
    $("authCloseBtn").onclick = closeModal;
    $("authBackdrop").onclick = (e)=>{ if(e.target === $("authBackdrop")) closeModal(); };

    $("doLoginBtn").onclick = async ()=>{
      const email = String($("authEmail").value||"").trim();
      const pass = String($("authPass").value||"").trim();
      if(!email || !pass){ $("authModalMsg").textContent = "–í–≤–µ–¥–∏—Ç–µ email + –ø–∞—Ä–æ–ª—å"; return; }
      try{
        await auth.signInWithEmailAndPassword(email, pass);
        $("authModalMsg").textContent = "OK";
        closeModal();
      }catch(e){
        console.error(e);
        $("authModalMsg").textContent = e.message || "Login error";
      }
    };

    $("doRegisterBtn").onclick = async ()=>{
      const email = String($("authEmail").value||"").trim();
      const pass = String($("authPass").value||"").trim();
      if(!email || !pass){ $("authModalMsg").textContent = "–í–≤–µ–¥–∏—Ç–µ email + –ø–∞—Ä–æ–ª—å"; return; }
      try{
        await auth.createUserWithEmailAndPassword(email, pass);
        $("authModalMsg").textContent = "–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω!";
        closeModal();
      }catch(e){
        console.error(e);
        $("authModalMsg").textContent = e.message || "Register error";
      }
    };

    $("forgotBtn").onclick = async ()=>{
      const email = String($("authEmail").value||"").trim();
      if(!email){ $("authModalMsg").textContent = "–í–≤–µ–¥–∏ email"; return; }
      try{
        await auth.sendPasswordResetEmail(email);
        $("authModalMsg").textContent = "–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ";
      }catch(e){
        console.error(e);
        $("authModalMsg").textContent = e.message || "Reset error";
      }
    };

    $("logoutBtn").onclick = async ()=>{ try{ await auth.signOut(); }catch(e){} };

    $("date").addEventListener("change", ()=>{
      const baseDate = $("date").value;
      startRealtime(baseDate);
      rebuildSlots();
    });
    $("duration").addEventListener("change", rebuildSlots);

    $("refreshBtn").onclick = ()=>{
      const baseDate = $("date").value;
      startRealtime(baseDate);
      rebuildSlots();
      setMsg("OK", "good");
    };

    $("nextFreeBtn").onclick = ()=>{
      if(!pickNextFree()){
        setMsg(lang==="en"?"No free time üòï":lang==="ka"?"·Éó·Éê·Éï·Éò·É°·É£·É§·Éê·Éö·Éò ·Éì·É†·Éù ·Éê·É† ·Éê·É†·Éò·É° üòï":"–°–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ—Ç üòï", "warn");
      }
    };

    $("createBtn").onclick = createBooking;

    $("myBtn").onclick = async ()=>{
      show($("myBox")); hide($("todayBox")); hide($("adminBox"));
      await renderMyBookings();
      $("myBox").scrollIntoView({behavior:"smooth", block:"start"});
    };
    $("closeMyBtn").onclick = ()=> hide($("myBox"));

    $("todayBtn").onclick = async ()=>{
      hide($("myBox")); show($("todayBox")); hide($("adminBox"));
      await renderToday();
      $("todayBox").scrollIntoView({behavior:"smooth", block:"start"});
    };
    $("closeTodayBtn").onclick = ()=> hide($("todayBox"));

    $("openAdminBtn").onclick = async ()=>{
      if(!currentUser){ setMsg(tr("msg.loginFirst"), "bad"); return; }
      if(!isAdmin){ setMsg(tr("msg.notAdmin"), "bad"); return; }
      hide($("myBox")); hide($("todayBox")); show($("adminBox"));
      $("adminDate").value = $("adminDate").value || $("date").value;
      await renderAdmin();
      $("adminBox").scrollIntoView({behavior:"smooth", block:"start"});
    };

    $("adminCloseBtn").onclick = ()=> hide($("adminBox"));
    $("refreshAdminBtn").onclick = renderAdmin;
    $("adminDate").addEventListener("change", renderAdmin);
    $("adminMode").addEventListener("change", renderAdmin);
    $("adminLimit").addEventListener("change", renderAdmin);
    $("adminSearch").addEventListener("input", ()=>{
      clearTimeout(window.__admT);
      window.__admT = setTimeout(renderAdmin, 160);
    });

    // success
    $("succClose").onclick = closeSuccess;
    $("successBackdrop").onclick = (e)=>{ if(e.target === $("successBackdrop")) closeSuccess(); };
    $("succMy").onclick = async ()=>{
      closeSuccess();
      show($("myBox")); hide($("todayBox")); hide($("adminBox"));
      await renderMyBookings();
      $("myBox").scrollIntoView({behavior:"smooth", block:"start"});
    };
    $("succAgain").onclick = ()=>{
      closeSuccess();
      selectedSlot = null;
      $("pickedSummary").innerHTML = `<b>‚Äî</b>`;
      $("createBtn").disabled = true;
      rebuildSlots();
      $("timeList").scrollIntoView({behavior:"smooth", block:"center"});
    };

    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        hide($("myBox")); hide($("todayBox")); hide($("adminBox"));
        closeModal();
        closeSuccess();
      }
    });
  }

  // =========================
  // BOOT
  // =========================
  function ensureHttps(){
    const proto = location.protocol;
    if(proto === "file:"){
      setCloud("NO-HTTPS", false);
      setMsg(tr("msg.needHttps"), "warn");
    }
  }

  async function boot(){
    const now = new Date();
    $("date").value = toISODate(now);
    $("adminDate").value = toISODate(now);

    if(!T[lang]) lang="ru";
    applyLang();

    renderPCs();
    bind();
    ensureHttps();

    const savedNick = localStorage.getItem("sg_nick") || "";
    if(savedNick) $("nick").value = savedNick;
    $("nick").addEventListener("input", ()=> localStorage.setItem("sg_nick", String($("nick").value||"").trim()));

    auth.onAuthStateChanged(async (u)=>{
      currentUser = u || null;
      updateAuthUI();

      if(currentUser){
        $("authMsg").textContent = `‚úÖ ${currentUser.email || currentUser.uid.slice(0,6)}`;
        setMsg("OK", "info");

        if(!String($("nick").value||"").trim()){
          try{
            const pn = await loadNick(currentUser.uid);
            if(pn) $("nick").value = pn;
          }catch(e){}
        }
      }else{
        $("authMsg").textContent = "‚Äî";
        setMsg(tr("msg.loginFirst"), "info");
      }

      // load bookings regardless of login (read rules decide)
      startRealtime($("date").value);
      rebuildSlots();
    });
  }

  boot();
})();
</script>
</body>
</html>
